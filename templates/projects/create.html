{% extends 'base.html' %}

{% block title %}Create Project - Bridgio CRM{% endblock %}

{% block page_title %}Create Project{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-4 sm:mb-6">
        <h1 class="text-2xl sm:text-3xl font-heading font-semibold text-text-primary mb-2">Create Project</h1>
        <p class="text-sm sm:text-base text-text-secondary">Create a new project with configurations and floor mapping.</p>
    </div>
    
    <!-- Progress Steps -->
    <div class="mb-6 sm:mb-8 overflow-x-auto">
        <div class="flex items-center justify-between min-w-[900px] sm:min-w-0">
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-olive-primary text-white font-bold" id="step-1-indicator">1</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-olive-primary">Basic Information</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-1-2-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-2-indicator">2</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Tower Structure</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-2-3-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-3-indicator">3</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Configurations</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-3-4-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-4-indicator">4</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Floor Mapping</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-4-5-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-5-indicator">5</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Settings</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
        <form id="project-form" method="post" action="{% url 'projects:create' %}" enctype="multipart/form-data" class="space-y-8" onsubmit="event.preventDefault(); return false;">
            {% csrf_token %}
            <input type="hidden" name="step" id="form-step" value="1">
            
            <!-- Step 1: Basic Information -->
            <div id="step-1" class="step-content">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Basic Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project Image</label>
                        <input type="file" name="image" id="image" accept="image/*"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                        <p class="text-xs text-gray-500 mt-1">Upload a cover image for the project</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project Name *</label>
                        <input type="text" name="name" id="name" required
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Builder Name *</label>
                        <input type="text" name="builder_name" id="builder_name" required
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-text-primary mb-2">Location *</label>
                        <textarea name="location" id="location" rows="2" required
                                  class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">RERA ID</label>
                        <input type="text" name="rera_id" id="rera_id"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project Type *</label>
                        <select name="project_type" id="project_type" required
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select Type</option>
                            {% for value, label in project_type_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Starting Price</label>
                        <div class="flex gap-2">
                            <input type="number" name="starting_price" id="starting_price" step="0.01" placeholder="e.g., 58"
                                   class="flex-1 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <select name="starting_price_unit" id="starting_price_unit"
                                    class="w-32 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <option value="lakhs">Lakhs</option>
                                <option value="crores">Crores</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Ending Price</label>
                        <div class="flex gap-2">
                            <input type="number" name="ending_price" id="ending_price" step="0.01" placeholder="e.g., 85"
                                   class="flex-1 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <select name="ending_price_unit" id="ending_price_unit"
                                    class="w-32 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <option value="lakhs">Lakhs</option>
                                <option value="crores">Crores</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-text-primary mb-2">Inventory Summary</label>
                        <textarea name="inventory_summary" id="inventory_summary" rows="3"
                                  class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Latitude</label>
                        <input type="number" name="latitude" id="latitude" step="0.000001"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Longitude</label>
                        <input type="number" name="longitude" id="longitude" step="0.000001"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <a href="{% url 'projects:list' %}" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Cancel</a>
                    <button type="button" onclick="submitStep(1)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Tower Structure</button>
                </div>
            </div>
            
            <!-- Step 2: Tower Structure -->
            <div id="step-2" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Tower and Unit Structure</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-text-primary mb-2">Number of Towers *</label>
                    <input type="number" name="number_of_towers" id="number_of_towers" value="1" min="1" required
                           onchange="generateTowerConfigs()"
                           class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    <p class="text-xs text-gray-500 mt-1">Set the number of towers, then configure each tower individually below</p>
                </div>
                
                <div id="tower-configs-container" class="space-y-4 mb-6">
                    <!-- Tower configurations will be generated here -->
                </div>
                
                <!-- Legacy fields (hidden, for backward compatibility) -->
                <input type="hidden" name="floors_per_tower" id="floors_per_tower" value="1">
                <input type="hidden" name="units_per_floor" id="units_per_floor" value="1">
                <input type="hidden" name="has_commercial" id="has_commercial" value="off">
                <input type="hidden" name="commercial_floors" id="commercial_floors" value="0">
                <input type="hidden" name="commercial_units_per_floor" id="commercial_units_per_floor" value="0">
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(2)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitStep(2)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Configurations</button>
                </div>
            </div>
            
            <!-- Step 3: Configurations -->
            <div id="step-3" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Configurations & Pricing</h2>
                
                <div class="mb-4">
                    <button type="button" onclick="addConfiguration()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                        + Add Configuration
                    </button>
                </div>
                
                <div id="configurations-container" class="space-y-4 mb-6">
                    <!-- Configurations will be added here dynamically -->
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(3)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitStep(3)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Floor Mapping</button>
                </div>
            </div>
            
            <!-- Step 4: Floor Mapping -->
            <div id="step-4" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Floor & Unit Mapping</h2>
                
                <p class="text-sm text-gray-600 mb-4">Map each unit to a configuration variant. The structure will be generated based on the tower structure you defined.</p>
                
                <div id="floor-mapping-container" class="space-y-4">
                    <p class="text-sm text-gray-500">Please complete previous steps to enable floor mapping.</p>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(4)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitStep(4)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Settings</button>
                </div>
            </div>
            
            <!-- Step 5: Settings -->
            <div id="step-5" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Settings & Assignment</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Default Commission %</label>
                        <input type="number" name="default_commission_percent" id="default_commission_percent" step="0.01" value="0"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Auto Assignment Strategy</label>
                        <select name="auto_assignment_strategy" id="auto_assignment_strategy"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="manual">Manual</option>
                            <option value="round_robin">Round Robin</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Site Head</label>
                        <select name="site_head" id="site_head"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">None</option>
                            {% for head in site_heads %}
                            <option value="{{ head.id }}">{{ head.get_full_name|default:head.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Highrise Pricing Section -->
                <div class="mt-8 pt-6 border-t border-border-light">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-heading font-semibold text-text-primary">Highrise Pricing (Optional)</h3>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" name="highrise_enabled" id="highrise_enabled" 
                                   onchange="toggleHighriseFields()"
                                   class="mr-2 w-5 h-5 text-olive-primary focus:ring-olive-primary border-gray-300 rounded">
                            <span class="text-sm font-medium text-text-primary">Enable Highrise Pricing</span>
                        </label>
                    </div>
                    
                    <div id="highrise-fields" class="hidden space-y-6 mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-text-primary mb-2">Floor Threshold *</label>
                                <input type="number" name="highrise_floor_threshold" id="highrise_floor_threshold" 
                                       value="10" min="1"
                                       class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <p class="text-xs text-gray-500 mt-1">Floors up to this number use base price (e.g., 10 = floors 1-10)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-text-primary mb-2">Base Price per Sqft (₹) *</label>
                                <input type="number" name="highrise_base_price_per_sqft" id="highrise_base_price_per_sqft" 
                                       step="0.01" min="0"
                                       class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <p class="text-xs text-gray-500 mt-1">Base price per sqft for floors up to threshold (from Configuration price/sqft or custom)</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-text-primary mb-2">Pricing Type *</label>
                                <select name="highrise_pricing_type" id="highrise_pricing_type" 
                                        onchange="togglePricingTypeFields()"
                                        class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                    <option value="fixed">Fixed Price Addition</option>
                                    <option value="per_sqft" selected>Per Sqft Addition</option>
                                </select>
                            </div>
                            <div id="fixed-price-field" class="hidden">
                                <label class="block text-sm font-semibold text-text-primary mb-2">Fixed Price Increment (₹) *</label>
                                <input type="number" name="highrise_fixed_price_increment" id="highrise_fixed_price_increment" 
                                       value="0" step="0.01" min="0"
                                       class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <p class="text-xs text-gray-500 mt-1">Amount added per floor above threshold</p>
                            </div>
                            <div id="per-sqft-field">
                                <label class="block text-sm font-semibold text-text-primary mb-2">Per Sqft Increment (₹) *</label>
                                <input type="number" name="highrise_per_sqft_increment" id="highrise_per_sqft_increment" 
                                       value="20" step="0.01" min="0"
                                       class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <p class="text-xs text-gray-500 mt-1">Amount added per sqft per floor above threshold (e.g., 20 = ₹20/sqft per floor)</p>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-300 pt-4">
                            <h4 class="text-md font-semibold text-text-primary mb-4">Development Charges</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-text-primary mb-2">Development Charges Type *</label>
                                    <select name="highrise_dev_charges_type" id="highrise_dev_charges_type" 
                                            onchange="toggleDevChargesFields()"
                                            class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                        <option value="fixed" selected>Fixed Amount</option>
                                        <option value="per_sqft">Per Sqft</option>
                                    </select>
                                </div>
                                <div id="dev-charges-fixed-field">
                                    <label class="block text-sm font-semibold text-text-primary mb-2">Development Charges Fixed (₹)</label>
                                    <input type="number" name="highrise_dev_charges_fixed" id="highrise_dev_charges_fixed" 
                                           value="0" step="0.01" min="0"
                                           class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                </div>
                                <div id="dev-charges-per-sqft-field" class="hidden">
                                    <label class="block text-sm font-semibold text-text-primary mb-2">Development Charges per Sqft (₹)</label>
                                    <input type="number" name="highrise_dev_charges_per_sqft" id="highrise_dev_charges_per_sqft" 
                                           value="0" step="0.01" min="0"
                                           class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-300 pt-4">
                            <h4 class="text-md font-semibold text-text-primary mb-4">Parking</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold text-text-primary mb-2">Parking Price (₹)</label>
                                    <input type="number" name="highrise_parking_price" id="highrise_parking_price" 
                                           value="0" step="0.01" min="0"
                                           class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" name="highrise_parking_negotiable" id="highrise_parking_negotiable" 
                                               class="mr-2 w-5 h-5 text-olive-primary focus:ring-olive-primary border-gray-300 rounded">
                                        <span class="text-sm font-medium text-text-primary">Negotiable</span>
                                    </label>
                                    <label class="flex items-center cursor-pointer">
                                        <input type="checkbox" name="highrise_include_parking" id="highrise_include_parking" 
                                               checked
                                               class="mr-2 w-5 h-5 text-olive-primary focus:ring-olive-primary border-gray-300 rounded">
                                        <span class="text-sm font-medium text-text-primary">Include in Calculation</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(5)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitFinalForm()" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Create Project</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let configCounter = 0;
    let areaCounters = {};
    
    // Step Navigation
    function updateStepIndicators(currentStep) {
        for (let i = 1; i <= 5; i++) {
            const indicator = document.getElementById(`step-${i}-indicator`);
            const label = indicator.nextElementSibling.querySelector('p');
            const prevLine = i > 1 ? document.getElementById(`step-${i-1}-${i}-line`) : null;
            
            if (i < currentStep) {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white font-bold';
                label.className = 'text-sm font-medium text-green-600';
                if (prevLine) prevLine.className = 'flex-1 h-1 mx-4 bg-green-500';
            } else if (i === currentStep) {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-olive-primary text-white font-bold';
                label.className = 'text-sm font-medium text-olive-primary';
                if (prevLine) prevLine.className = 'flex-1 h-1 mx-4 bg-olive-primary';
            } else {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold';
                label.className = 'text-sm font-medium text-gray-500';
                if (prevLine) prevLine.className = 'flex-1 h-1 mx-4 bg-gray-200';
            }
        }
    }
    
    function showStep(step) {
        // Hide all steps
        for (let i = 1; i <= 5; i++) {
            document.getElementById(`step-${i}`).classList.add('hidden');
        }
        // Show current step
        document.getElementById(`step-${step}`).classList.remove('hidden');
        updateStepIndicators(step);
        document.getElementById('form-step').value = step;
    }
    
    function previousStep(fromStep) {
        if (fromStep > 1) {
            showStep(fromStep - 1);
        }
    }
    
    function submitStep(step) {
        const form = document.getElementById('project-form');
        const formData = new FormData(form);
        formData.set('step', step.toString());
        
        fetch('{% url "projects:create" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Request failed');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (step === 1) {
                    showStep(2);
                } else if (step === 2) {
                    showStep(3);
                } else if (step === 3) {
                    showStep(4);
                    generateFloorMapping();
                } else if (step === 4) {
                    showStep(5);
                }
            } else {
                alert(data.error || 'An error occurred. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'An error occurred. Please try again.');
        });
    }
    
    function submitFinalForm() {
        const form = document.getElementById('project-form');
        const formData = new FormData(form);
        formData.set('step', '5');
        
        fetch('{% url "projects:create" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || data.message || 'Request failed');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '{% url "projects:list" %}';
                }
            } else {
                alert(data.error || data.message || 'An error occurred. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
    
    // Configuration Management
    function addConfiguration() {
        const container = document.getElementById('configurations-container');
        const configId = configCounter++;
        areaCounters[configId] = 0;
        
        const configHtml = `
            <div class="config-card border-2 border-gray-300 rounded-lg p-4 bg-gray-50" data-config-id="${configId}">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Configuration ${configId + 1}</h3>
                    <button type="button" onclick="removeConfiguration(${configId})" 
                            class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                        Remove
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Configuration Name * (e.g., 1BHK, 2BHK)</label>
                        <input type="text" name="config_name_${configId}" required
                               placeholder="e.g., 1BHK"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input type="text" name="config_description_${configId}"
                               placeholder="Optional description"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Price per Sqft (₹)</label>
                        <input type="number" name="config_price_per_sqft_${configId}" step="0.01"
                               placeholder="e.g., 5000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Stamp Duty (%)</label>
                        <input type="number" name="config_stamp_duty_${configId}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">GST (%)</label>
                        <input type="number" name="config_gst_${configId}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Registration Charges (₹)</label>
                        <input type="number" name="config_registration_${configId}" value="30000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Legal Charges (₹)</label>
                        <input type="number" name="config_legal_${configId}" value="15000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Development Charges (₹)</label>
                        <input type="number" name="config_development_${configId}" value="0" step="0.01"
                               placeholder="e.g., 50000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold">Area Types (Carpet, Buildup, RERA)</label>
                        <button type="button" onclick="addAreaType(${configId})" 
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                            + Add Area Type
                        </button>
                    </div>
                    <div id="area-types-${configId}" class="space-y-2">
                        <!-- Area types will be added here -->
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', configHtml);
    }
    
    function removeConfiguration(configId) {
        const configCard = document.querySelector(`[data-config-id="${configId}"]`);
        if (configCard) {
            configCard.remove();
        }
    }
    
    function addAreaType(configId) {
        const container = document.getElementById(`area-types-${configId}`);
        const areaId = areaCounters[configId] || 0;
        areaCounters[configId] = areaId + 1;
        
        const areaHtml = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-2 p-2 bg-white rounded border">
                <div>
                    <label class="block text-xs font-medium mb-1">Carpet Area (sqft)</label>
                    <input type="number" name="config_${configId}_area_carpet_${areaId}" step="0.01" required
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Buildup Area (sqft)</label>
                    <input type="number" name="config_${configId}_area_buildup_${areaId}" step="0.01" required
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">RERA Area (sqft)</label>
                    <input type="number" name="config_${configId}_area_rera_${areaId}" step="0.01"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Description</label>
                    <input type="text" name="config_${configId}_area_desc_${areaId}"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', areaHtml);
    }
    
    function toggleCommercialFields() {
        const checkbox = document.getElementById('has_commercial');
        const fields = document.getElementById('commercial_fields');
        if (checkbox.checked) {
            fields.classList.remove('hidden');
        } else {
            fields.classList.add('hidden');
        }
    }
    
    function getFloorDisplayName(floorNum) {
        if (floorNum === 1) return "Ground (G)";
        if (floorNum === 2) return "1st Floor";
        if (floorNum === 3) return "2nd Floor";
        return `${floorNum - 1}th Floor`;
    }
    
    function updateCommercialFloors(towerIndex) {
        const floorsInput = document.getElementById(`tower_${towerIndex}_floors`);
        const floorsCount = parseInt(floorsInput?.value) || 1;
        const container = document.getElementById(`commercial-floors-${towerIndex}`);
        
        if (!container) return;
        
        // Total floors = G (floor 1) + floorsCount (floors 2 to floorsCount+1)
        // So we display: G, 1st, 2nd, ..., floorsCount-th
        const totalFloors = floorsCount + 1; // G + N floors
        
        let html = '';
        for (let floor = 1; floor <= totalFloors; floor++) {
            const floorName = getFloorDisplayName(floor);
            const existingCheck = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial"]`);
            const isChecked = existingCheck ? existingCheck.checked : false;
            const existingUnits = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial_units"]`)?.value || '';
            
            html += `
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-300 rounded hover:bg-gray-50">
                    <label class="flex items-center cursor-pointer flex-1">
                        <input type="checkbox" name="tower_${towerIndex}_floor_${floor}_commercial" 
                               value="on" ${isChecked ? 'checked' : ''}
                               onchange="toggleCommercialUnits(${towerIndex}, ${floor}, this.checked)"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium">${floorName}</span>
                    </label>
                    ${floor === 1 ? '<span class="text-xs text-gray-500">(Vacant/Parking if not commercial)</span>' : ''}
                    <div id="commercial-units-${towerIndex}-${floor}" class="${isChecked ? '' : 'hidden'}">
                        <label class="text-xs text-gray-600 mr-2">Units:</label>
                        <input type="number" name="tower_${towerIndex}_floor_${floor}_commercial_units" 
                               value="${existingUnits}" min="1" placeholder="Units"
                               class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500">
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }
    
    function toggleCommercialUnits(towerIndex, floor, isChecked) {
        const unitsDiv = document.getElementById(`commercial-units-${towerIndex}-${floor}`);
        if (unitsDiv) {
            if (isChecked) {
                unitsDiv.classList.remove('hidden');
            } else {
                unitsDiv.classList.add('hidden');
                const unitsInput = unitsDiv.querySelector('input[type="number"]');
                if (unitsInput) unitsInput.value = '';
            }
        }
    }
    
    function generateTowerConfigs() {
        const container = document.getElementById('tower-configs-container');
        const numTowers = parseInt(document.getElementById('number_of_towers')?.value) || 1;
        
        let html = '';
        for (let i = 0; i < numTowers; i++) {
            const towerNum = i + 1;
            // Try to get existing config values
            const existingConfig = document.querySelector(`input[name="tower_${i}_number"]`);
            const existingFloors = existingConfig ? document.querySelector(`input[name="tower_${i}_floors"]`)?.value : '1';
            const existingUnits = existingConfig ? document.querySelector(`input[name="tower_${i}_units_per_floor"]`)?.value : '1';
            const existingCommercial = existingConfig ? document.querySelector(`input[name="tower_${i}_is_commercial"]`)?.checked : false;
            
            html += `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4" data-tower-index="${i}">
                    <h3 class="text-lg font-semibold mb-4">Tower ${towerNum}</h3>
                    <input type="hidden" name="tower_${i}_number" value="${towerNum}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Number of Floors (excluding Ground) *</label>
                            <input type="number" name="tower_${i}_floors" id="tower_${i}_floors" value="${existingFloors || 1}" min="1" required
                                   onchange="updateCommercialFloors(${i})"
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Ground floor (G) is included automatically. Total floors = G + this number</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Units per Floor *</label>
                            <input type="number" name="tower_${i}_units_per_floor" value="${existingUnits || 1}" min="1" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">Select Commercial Floors:</label>
                        <div id="commercial-floors-${i}" class="flex flex-wrap gap-3 p-3 bg-white rounded border border-gray-300">
                            <!-- Commercial floor checkboxes will be generated here -->
                        </div>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
        // Initialize commercial floors for all towers
        for (let i = 0; i < numTowers; i++) {
            updateCommercialFloors(i);
        }
    }
    
    function generateFloorMapping() {
        const container = document.getElementById('floor-mapping-container');
        const numTowers = parseInt(document.getElementById('number_of_towers')?.value) || 1;
        
        // Get tower configurations from form inputs - find all tower number inputs first
        const towerConfigs = [];
        const towerInputs = document.querySelectorAll('input[name^="tower_"][name$="_number"]');
        
        // Collect all tower configs by finding their corresponding inputs
        towerInputs.forEach(towerNumInput => {
            const nameMatch = towerNumInput.name.match(/tower_(\d+)_number/);
            if (nameMatch) {
                const index = parseInt(nameMatch[1]);
                const towerNum = parseInt(towerNumInput.value) || (index + 1);
                const floorsInput = document.querySelector(`input[name="tower_${index}_floors"]`);
                const unitsInput = document.querySelector(`input[name="tower_${index}_units_per_floor"]`);
                const commercialInput = document.querySelector(`input[name="tower_${index}_is_commercial"]`);
                
                if (floorsInput && unitsInput) {
                    towerConfigs.push({
                        towerNum: towerNum,
                        floors: parseInt(floorsInput.value) || 1,
                        unitsPerFloor: parseInt(unitsInput.value) || 1,
                        isCommercial: commercialInput ? commercialInput.checked : false
                    });
                }
            }
        });
        
        // Sort by tower number to ensure correct order
        towerConfigs.sort((a, b) => a.towerNum - b.towerNum);
        
        if (towerConfigs.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">Please complete Tower Structure step first.</p>';
            return;
        }
        
        // Get all configurations for dropdown
        const configs = [];
        document.querySelectorAll('[data-config-id]').forEach(card => {
            const configId = card.getAttribute('data-config-id');
            const configNameInput = card.querySelector(`input[name="config_name_${configId}"]`);
            if (configNameInput && configNameInput.value) {
                const configName = configNameInput.value;
                const areaContainer = card.querySelector(`#area-types-${configId}`);
                if (areaContainer) {
                    const areaTypes = [];
                    const carpetInputs = areaContainer.querySelectorAll(`input[name^="config_${configId}_area_carpet_"]`);
                    carpetInputs.forEach(input => {
                        const nameMatch = input.name.match(/config_\d+_area_carpet_(\d+)/);
                        if (nameMatch) {
                            const areaId = nameMatch[1];
                            const carpet = input.value.trim();
                            const buildupInput = areaContainer.querySelector(`input[name="config_${configId}_area_buildup_${areaId}"]`);
                            const buildup = buildupInput?.value.trim() || '';
                            if (carpet && buildup) {
                                areaTypes.push({
                                    id: areaId,
                                    carpet: carpet,
                                    buildup: buildup,
                                    value: `config_${configId}_area_${areaId}`
                                });
                            }
                        }
                    });
                    if (areaTypes.length > 0) {
                        configs.push({id: configId, name: configName, areaTypes: areaTypes});
                    }
                }
            }
        });
        
        if (configs.length === 0) {
            container.innerHTML = '<p class="text-sm text-red-600">Please add at least one configuration with area types first.</p>';
            return;
        }
        
        let html = '';
        for (const towerConfig of towerConfigs) {
            const tower = towerConfig.towerNum;
            const floorsPerTower = towerConfig.floors;
            const unitsPerFloor = towerConfig.unitsPerFloor;
            const isCommercialTower = towerConfig.isCommercial;
            
            html += `<div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">`;
            html += `<h3 class="text-lg font-semibold mb-4">Tower ${tower}${isCommercialTower ? ' <span class="text-sm text-blue-600">(Commercial)</span>' : ''}</h3>`;
            
            // Get commercial floors and their unit counts from form inputs
            // Need to find the tower index first, then use that to find the inputs
            const commercialFloorsData = {};
            // Find all tower number inputs to map tower number to index
            const towerInputs = document.querySelectorAll('input[name^="tower_"][name$="_number"]');
            let towerIndex = null;
            for (const input of towerInputs) {
                if (parseInt(input.value) === tower) {
                    const nameMatch = input.name.match(/tower_(\d+)_number/);
                    if (nameMatch) {
                        towerIndex = parseInt(nameMatch[1]);
                        break;
                    }
                }
            }
            
            // If we found the tower index, read commercial floor data
            if (towerIndex !== null) {
                for (let floor = 1; floor <= floorsPerTower; floor++) {
                    const commercialCheck = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial"]`);
                    if (commercialCheck && commercialCheck.checked) {
                        const unitsInput = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial_units"]`);
                        const units = unitsInput ? parseInt(unitsInput.value) || unitsPerFloor : unitsPerFloor;
                        commercialFloorsData[floor] = units;
                    }
                }
            }
            
            for (let floor = 1; floor <= floorsPerTower; floor++) {
                // Get floor display name
                let floorDisplayName;
                if (floor === 1) {
                    floorDisplayName = "Ground (G)";
                } else if (floor === 2) {
                    floorDisplayName = "1st Floor";
                } else if (floor === 3) {
                    floorDisplayName = "2nd Floor";
                } else {
                    floorDisplayName = `${floor - 1}th Floor`;
                }
                
                // Check if this floor is marked as commercial
                const isCommercialFloor = floor in commercialFloorsData || isCommercialTower;
                
                // Get units per floor for this floor
                let unitsPerFloorThis = unitsPerFloor;
                if (floor in commercialFloorsData) {
                    unitsPerFloorThis = commercialFloorsData[floor];
                }
                
                html += `<div class="mb-4 p-3 bg-white rounded border ${isCommercialFloor ? 'border-blue-300 bg-blue-50' : ''}">`;
                html += `<div class="flex items-center justify-between mb-2 flex-wrap gap-2">`;
                html += `<div class="flex items-center gap-4">`;
                html += `<label class="flex items-center">`;
                html += `<input type="checkbox" name="tower_${tower}_floor_${floor}_excluded" class="mr-2">`;
                html += `<span class="font-medium">${floorDisplayName} - Exclude Entire Floor</span>`;
                html += `</label>`;
                // Commercial floors are now selected in tower structure step, so we just display the status
                if (isCommercialFloor) {
                    html += `<span class="ml-4 text-sm font-medium text-blue-600">✓ Commercial Floor (${unitsPerFloorThis} units)</span>`;
                } else if (floor === 1) {
                    html += `<span class="ml-4 text-sm font-medium text-gray-500">(Vacant/Parking)</span>`;
                }
                html += `</div>`;
                html += `</div>`;
                
                for (let unit = 1; unit <= unitsPerFloorThis; unit++) {
                    // Ground floor (1): 01, 02, 03... First floor (2): 101, 102, 103...
                    let unitNumber;
                    let unitDisplay;
                    if (floor === 1) {
                        unitNumber = unit;
                        unitDisplay = String(unit).padStart(2, '0'); // 01, 02, 03...
                    } else {
                        unitNumber = (floor - 1) * 100 + unit;
                        unitDisplay = unitNumber;
                    }
                    html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2 p-2 bg-gray-50 rounded">`;
                    html += `<div class="flex items-center">`;
                    html += `<span class="text-sm font-medium">Unit ${unitDisplay}</span>`;
                    html += `</div>`;
                    html += `<div class="flex items-center">`;
                    html += `<input type="checkbox" name="tower_${tower}_floor_${floor}_unit_${unit}_excluded" class="mr-2">`;
                    html += `<span class="text-xs">Exclude</span>`;
                    html += `</div>`;
                    html += `<div>`;
                    html += `<select name="tower_${tower}_floor_${floor}_unit_${unit}_area_type" class="w-full px-2 py-1 text-sm border border-gray-300 rounded">`;
                    html += `<option value="">Select Configuration</option>`;
                    configs.forEach(config => {
                        config.areaTypes.forEach(areaType => {
                            html += `<option value="${areaType.value}">${config.name} - ${areaType.carpet}/${areaType.buildup} sqft</option>`;
                        });
                    });
                    html += `</select>`;
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
        }
        
        container.innerHTML = html;
    }
    
    // Initialize
    updateStepIndicators(1);
    generateTowerConfigs(); // Generate initial tower configs
    
    // Highrise pricing functions
    function toggleHighriseFields() {
        const enabled = document.getElementById('highrise_enabled').checked;
        const fields = document.getElementById('highrise-fields');
        if (enabled) {
            fields.classList.remove('hidden');
        } else {
            fields.classList.add('hidden');
        }
    }
    
    function togglePricingTypeFields() {
        const pricingType = document.getElementById('highrise_pricing_type').value;
        const fixedField = document.getElementById('fixed-price-field');
        const perSqftField = document.getElementById('per-sqft-field');
        
        if (pricingType === 'fixed') {
            fixedField.classList.remove('hidden');
            perSqftField.classList.add('hidden');
        } else {
            fixedField.classList.add('hidden');
            perSqftField.classList.remove('hidden');
        }
    }
    
    function toggleDevChargesFields() {
        const devChargesType = document.getElementById('highrise_dev_charges_type').value;
        const fixedField = document.getElementById('dev-charges-fixed-field');
        const perSqftField = document.getElementById('dev-charges-per-sqft-field');
        
        if (devChargesType === 'fixed') {
            fixedField.classList.remove('hidden');
            perSqftField.classList.add('hidden');
        } else {
            fixedField.classList.add('hidden');
            perSqftField.classList.remove('hidden');
        }
    }
</script>
{% endblock %}
