{% extends 'base.html' %}

{% block title %}Create Project - Bridgio CRM{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-heading font-bold text-olive-primary">Create Project</h1>
        <a href="{% url 'projects:list' %}" class="text-olive-primary hover:text-olive-secondary">← Back to Projects</a>
    </div>
    
    <div class="bg-white rounded-custom shadow-md p-6">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Image</label>
                        <input type="file" name="image" accept="image/*"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <p class="text-xs text-gray-500 mt-1">Upload a cover image for the project (will be used in cards and detail page)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Name *</label>
                        <input type="text" name="name" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Builder Name *</label>
                        <input type="text" name="builder_name" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Location *</label>
                        <textarea name="location" rows="2" required
                                  class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">RERA ID</label>
                        <input type="text" name="rera_id"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Type *</label>
                        <select name="project_type" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="">Select Type</option>
                            {% for value, label in project_type_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Starting Price</label>
                        <div class="flex gap-2">
                            <input type="number" name="starting_price" step="0.01" placeholder="e.g., 58"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <select name="starting_price_unit"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                                <option value="lakhs">Lakhs</option>
                                <option value="crores">Crores</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Ending Price</label>
                        <div class="flex gap-2">
                            <input type="number" name="ending_price" step="0.01" placeholder="e.g., 85"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <select name="ending_price_unit"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                                <option value="lakhs">Lakhs</option>
                                <option value="crores">Crores</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Inventory Summary</label>
                        <textarea name="inventory_summary" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Tower and Unit Structure -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Tower and Unit Structure</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Number of Towers *</label>
                        <input type="number" name="number_of_towers" value="1" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Floors per Tower *</label>
                        <input type="number" name="floors_per_tower" value="1" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Units per Floor (Residential) *</label>
                        <input type="number" name="units_per_floor" value="1" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="has_commercial" id="has_commercial"
                               class="w-4 h-4 text-olive-primary border-gray-300 rounded focus:ring-olive-primary"
                               onchange="toggleCommercialFields()">
                        <label for="has_commercial" class="ml-2 text-sm font-medium">Has Commercial Units</label>
                    </div>
                    <div id="commercial_fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <div>
                            <label class="block text-sm font-medium mb-2">Commercial Floors</label>
                            <input type="number" name="commercial_floors" value="0" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Commercial Units per Floor</label>
                            <input type="number" name="commercial_units_per_floor" value="0" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Location Coordinates -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Location Coordinates (for Attendance)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Latitude</label>
                        <input type="number" name="latitude" step="0.000001"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Longitude</label>
                        <input type="number" name="longitude" step="0.000001"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Project Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Default Commission %</label>
                        <input type="number" name="default_commission_percent" step="0.01" value="0"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Auto Assignment Strategy</label>
                        <select name="auto_assignment_strategy"
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="manual">Manual</option>
                            <option value="round_robin">Round Robin</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Configurations -->
            <div id="configurations-section">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-heading font-bold">Configurations & Pricing</h2>
                    <button type="button" onclick="addConfiguration()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-custom hover:bg-blue-700 transition text-sm">
                        + Add Configuration
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-4">Add configurations (1BHK, 2BHK, etc.) with pricing and area variants. Save configurations first, then proceed to floor mapping.</p>
                <div id="configurations-container" class="space-y-4">
                    <!-- Configurations will be added here dynamically -->
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="button" onclick="saveConfigurations()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-custom hover:bg-green-700 transition">
                        Save Configurations & Continue to Floor Mapping
                    </button>
                </div>
            </div>
            
            <!-- Floor Mapping Section -->
            <div id="floor-mapping-section" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-heading font-bold">Floor & Unit Mapping</h2>
                </div>
                <p class="text-sm text-gray-600 mb-4">Map each unit to a configuration variant. Make sure "Floors per Tower" and "Units per Floor" are set above.</p>
                <div id="floor-mapping-container" class="space-y-4">
                    <!-- Floor mapping will be generated here -->
                    <p class="text-sm text-gray-500">Set "Floors per Tower" and "Units per Floor" above to enable floor mapping.</p>
                </div>
            </div>
            
            <!-- Assignment -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Assignment</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if mandate_owners %}
                    <div>
                        <label class="block text-sm font-medium mb-2">Mandate Owner *</label>
                        <select name="mandate_owner" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="">Select Mandate Owner</option>
                            {% for owner in mandate_owners %}
                            <option value="{{ owner.id }}">
                                {% if owner.get_full_name %}{{ owner.get_full_name }} ({{ owner.username }}){% else %}{{ owner.username }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div>
                        <label class="block text-sm font-medium mb-2">Site Head</label>
                        <select name="site_head"
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="">None</option>
                            {% for head in site_heads %}
                            <option value="{{ head.id }}">{{ head.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Submit -->
            <div id="submit-section" class="hidden flex justify-end space-x-4">
                <a href="{% url 'projects:list' %}" 
                   class="px-6 py-2 border border-gray-300 rounded-custom hover:bg-gray-50 transition">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-olive-primary text-white rounded-custom hover:bg-olive-secondary transition">
                    Save Project
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let configCounter = 0;
    let areaCounters = {};
    let floorCounters = {};
    
    function toggleCommercialFields() {
        const checkbox = document.getElementById('has_commercial');
        const fields = document.getElementById('commercial_fields');
        if (checkbox.checked) {
            fields.classList.remove('hidden');
        } else {
            fields.classList.add('hidden');
        }
    }
    
    function addConfiguration() {
        const container = document.getElementById('configurations-container');
        const configId = configCounter++;
        areaCounters[configId] = 0;
        floorCounters[configId] = 0;
        
        const configHtml = `
            <div class="config-card border-2 border-gray-300 rounded-lg p-4 bg-gray-50" data-config-id="${configId}">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Configuration ${configId + 1}</h3>
                    <button type="button" onclick="removeConfiguration(${configId})" 
                            class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                        Remove
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Configuration Name * (e.g., 1BHK, 2BHK)</label>
                        <input type="text" name="config_name_${configId}" required
                               placeholder="e.g., 1BHK"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input type="text" name="config_description_${configId}"
                               placeholder="Optional description"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Price per Sqft (₹)</label>
                        <input type="number" name="config_price_per_sqft_${configId}" step="0.01"
                               placeholder="e.g., 5000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Stamp Duty (%)</label>
                        <input type="number" name="config_stamp_duty_${configId}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">GST (%)</label>
                        <input type="number" name="config_gst_${configId}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Registration Charges (₹)</label>
                        <input type="number" name="config_registration_${configId}" value="30000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Legal Charges (₹)</label>
                        <input type="number" name="config_legal_${configId}" value="15000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Development Charges (₹)</label>
                        <input type="number" name="config_development_${configId}" value="0" step="0.01"
                               placeholder="e.g., 50000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Area Types -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold">Area Types (Carpet, Buildup, RERA)</label>
                        <button type="button" onclick="addAreaType(${configId})" 
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                            + Add Area Type
                        </button>
                    </div>
                    <div id="area-types-${configId}" class="space-y-2">
                        <!-- Area types will be added here -->
                    </div>
                </div>
                
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', configHtml);
        
        // Add event listener to configuration name input to update dropdowns when it changes
        const configNameInput = container.querySelector(`input[name="config_name_${configId}"]`);
        if (configNameInput) {
            configNameInput.addEventListener('input', function() {
                clearTimeout(configNameInput.updateTimeout);
                configNameInput.updateTimeout = setTimeout(() => {
                    populateAreaTypeOptions();
                }, 300);
            });
        }
    }
    
    function removeConfiguration(configId) {
        const card = document.querySelector(`[data-config-id="${configId}"]`);
        if (card) {
            card.remove();
        }
        delete areaCounters[configId];
        delete floorCounters[configId];
        // Update dropdowns after removing configuration
        populateAreaTypeOptions();
    }
    
    function addAreaType(configId) {
        const container = document.getElementById(`area-types-${configId}`);
        const areaId = areaCounters[configId]++;
        
        const areaHtml = `
            <div class="flex gap-2 items-end bg-white p-2 rounded border">
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Carpet Area (sqft) *</label>
                    <input type="number" name="config_${configId}_area_carpet_${areaId}" step="0.01" required
                           placeholder="e.g., 500"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Buildup Area (sqft) *</label>
                    <input type="number" name="config_${configId}_area_buildup_${areaId}" step="0.01" required
                           placeholder="e.g., 650"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">RERA Area (sqft)</label>
                    <input type="number" name="config_${configId}_area_rera_${areaId}" step="0.01"
                           placeholder="e.g., 600"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Description</label>
                    <input type="text" name="config_${configId}_area_desc_${areaId}"
                           placeholder="e.g., Compact"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <button type="button" onclick="this.parentElement.remove(); populateAreaTypeOptions();"
                        class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
                    ×
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', areaHtml);
        // Update dropdowns when new area type is added
        populateAreaTypeOptions();
    }
    
    function saveConfigurations() {
        // Validate that at least one configuration exists
        const configCards = document.querySelectorAll('[data-config-id]');
        if (configCards.length === 0) {
            alert('Please add at least one configuration before proceeding.');
            return;
        }
        
        // Validate configurations have required fields
        let hasValidConfig = false;
        let validationErrors = [];
        
        configCards.forEach(card => {
            const configId = card.dataset.configId;
            const configName = card.querySelector(`[name="config_name_${configId}"]`)?.value?.trim();
            
            if (!configName) {
                validationErrors.push(`Configuration ${parseInt(configId) + 1} is missing a name.`);
                return;
            }
            
            const areaContainer = card.querySelector(`#area-types-${configId}`);
            if (!areaContainer) {
                validationErrors.push(`Configuration "${configName}" has no area types section.`);
                return;
            }
            
            // Get all carpet area inputs
            const carpetInputs = areaContainer.querySelectorAll(`input[name^="config_${configId}_area_carpet_"]`);
            
            if (carpetInputs.length === 0) {
                validationErrors.push(`Configuration "${configName}" has no area types. Please add at least one area type.`);
                return;
            }
            
            // Check if at least one area type has both carpet and buildup
            let hasValidAreaType = false;
            for (let input of carpetInputs) {
                // Extract area ID from name: config_X_area_carpet_Y
                const nameMatch = input.name.match(/config_\d+_area_carpet_(\d+)/);
                if (nameMatch) {
                    const areaId = nameMatch[1];
                    const carpetArea = input.value.trim();
                    const buildupInput = areaContainer.querySelector(`input[name="config_${configId}_area_buildup_${areaId}"]`);
                    const buildupArea = buildupInput?.value.trim() || '';
                    
                    if (carpetArea && buildupArea) {
                        hasValidAreaType = true;
                        hasValidConfig = true;
                        break;
                    }
                }
            }
            
            if (!hasValidAreaType) {
                validationErrors.push(`Configuration "${configName}" needs at least one area type with both carpet and buildup area filled.`);
            }
        });
        
        if (!hasValidConfig) {
            const errorMsg = validationErrors.length > 0 
                ? validationErrors.join('\n') 
                : 'Please add at least one configuration with area types (carpet and buildup area) before proceeding.';
            alert(errorMsg);
            return false;
        }
        
        console.log('Validation passed, showing floor mapping...');
        
        // First, populate area type options to ensure dropdowns are ready
        if (typeof populateAreaTypeOptions === 'function') {
            populateAreaTypeOptions();
        }
        
        // Hide configurations section, show floor mapping section
        const configSection = document.getElementById('configurations-section');
        const floorSection = document.getElementById('floor-mapping-section');
        const submitSection = document.getElementById('submit-section');
        
        if (configSection) {
            configSection.classList.add('hidden');
            console.log('Hidden configurations section');
        }
        if (floorSection) {
            floorSection.classList.remove('hidden');
            console.log('Shown floor mapping section');
        }
        if (submitSection) {
            submitSection.classList.remove('hidden');
            console.log('Shown submit section');
        } else {
            console.error('submit-section element not found!');
        }
        
        // Generate floor mapping (this will also call populateAreaTypeOptions)
        if (typeof generateFloorMapping === 'function') {
            generateFloorMapping();
        }
        
        // Scroll to floor mapping section
        if (floorSection) {
            floorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        return true;
    }
    
    // Generate floor mapping UI with per-unit dropdowns
    function generateFloorMapping() {
        const container = document.getElementById('floor-mapping-container');
        const floorsPerTower = parseInt(document.querySelector('[name="floors_per_tower"]').value) || 0;
        const unitsPerFloor = parseInt(document.querySelector('[name="units_per_floor"]').value) || 0;
        const numberOfTowers = parseInt(document.querySelector('[name="number_of_towers"]').value) || 1;
        
        if (floorsPerTower === 0 || unitsPerFloor === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">Set "Floors per Tower" and "Units per Floor" above to enable floor mapping.</p>';
            document.getElementById('floor-mapping-section').classList.add('hidden');
            return;
        }
        
        document.getElementById('floor-mapping-section').classList.remove('hidden');
        
        let floorHtml = '';
        
        // Generate floor mapping for each tower
        for (let towerNum = 1; towerNum <= numberOfTowers; towerNum++) {
            floorHtml += `
                <div class="border-2 border-blue-300 rounded-lg p-4 bg-blue-50 mb-4">
                    <h2 class="text-xl font-semibold mb-4">Tower ${towerNum}</h2>
            `;
            
            for (let floorNum = 1; floorNum <= floorsPerTower; floorNum++) {
            floorHtml += `
                <div class="border-2 border-gray-300 rounded-lg p-4 bg-white">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Floor ${floorNum}</h3>
                        <label class="flex items-center">
                            <input type="checkbox" 
                                   name="tower_${towerNum}_floor_${floorNum}_excluded" 
                                   id="tower_${towerNum}_floor_${floorNum}_excluded"
                                   onchange="toggleFloorExclusion(${towerNum}, ${floorNum})"
                                   class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="ml-2 text-sm text-red-600">Exclude Floor (Commercial)</span>
                        </label>
                    </div>
                    <div id="tower_${towerNum}_floor_${floorNum}_units" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            `;
            
                for (let unitIdx = 1; unitIdx <= unitsPerFloor; unitIdx++) {
                    // Unit number format: Floor-Unit (e.g., Floor 1, Unit 1 = 101, Floor 2, Unit 1 = 201)
                    // Same unit numbers can exist in different towers
                    const unitNumber = floorNum * 100 + unitIdx;
                    floorHtml += `
                        <div class="border rounded p-3 bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-sm font-medium">Unit ${unitNumber}</label>
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               name="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_excluded" 
                                               id="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_excluded"
                                               onchange="toggleUnitExclusion(${towerNum}, ${floorNum}, ${unitIdx})"
                                               class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                        <span class="ml-1 text-xs text-red-600">Exclude</span>
                                    </label>
                                </div>
                                <select name="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_area_type" 
                                        id="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_area_type"
                                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">Select Configuration</option>
                                    <!-- Options will be populated dynamically -->
                                </select>
                            </div>
                    `;
                }
                
                floorHtml += `
                        </div>
                    </div>
                `;
            }
            
            floorHtml += `
                </div>
            `;
        }
        
        container.innerHTML = floorHtml;
        populateAreaTypeOptions();
    }
    
    function toggleFloorExclusion(towerNum, floorNum) {
        const checkbox = document.getElementById(`tower_${towerNum}_floor_${floorNum}_excluded`);
        const unitsContainer = document.getElementById(`tower_${towerNum}_floor_${floorNum}_units`);
        const units = unitsContainer.querySelectorAll('select, input[type="checkbox"]:not([id*="_excluded"])');
        
        if (checkbox.checked) {
            units.forEach(el => {
                el.disabled = true;
                el.closest('.border').classList.add('opacity-50');
            });
        } else {
            units.forEach(el => {
                el.disabled = false;
                el.closest('.border').classList.remove('opacity-50');
            });
        }
    }
    
    function toggleUnitExclusion(towerNum, floorNum, unitIdx) {
        const checkbox = document.getElementById(`tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_excluded`);
        const select = document.getElementById(`tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_area_type`);
        
        if (checkbox.checked) {
            select.disabled = true;
            select.value = '';
            select.closest('.border').classList.add('opacity-50');
        } else {
            select.disabled = false;
            select.closest('.border').classList.remove('opacity-50');
        }
    }
    
    function populateAreaTypeOptions() {
        // Collect all area types from configurations in the form
        const selects = document.querySelectorAll('[id$="_area_type"]');
        const areaTypes = [];
        
        // Find all configuration cards
        const configCards = document.querySelectorAll('[data-config-id]');
        configCards.forEach(card => {
            const configId = card.dataset.configId;
            const configName = card.querySelector(`[name="config_name_${configId}"]`)?.value || '';
            
            if (!configName) return; // Skip if config name is empty
            
            // Find all area types for this configuration
            // Look for inputs by name pattern instead of ID
            const areaContainer = card.querySelector(`#area-types-${configId}`);
            if (areaContainer) {
                // Get all carpet area inputs by name pattern
                const carpetInputs = areaContainer.querySelectorAll(`input[name^="config_${configId}_area_carpet_"]`);
                
                carpetInputs.forEach(input => {
                    // Extract area ID from name: config_X_area_carpet_Y
                    const nameMatch = input.name.match(/config_\d+_area_carpet_(\d+)/);
                    if (nameMatch) {
                        const areaId = nameMatch[1];
                        const carpetArea = input.value.trim();
                        
                        // Find corresponding buildup input
                        const buildupInput = areaContainer.querySelector(`input[name="config_${configId}_area_buildup_${areaId}"]`);
                        const buildupArea = buildupInput?.value.trim() || '';
                        
                        // Only add if both carpet and buildup are provided
                        if (carpetArea && buildupArea) {
                            // Create a unique identifier for this area type
                            const optionValue = `config_${configId}_area_${areaId}`;
                            const displayName = `${configName}-${parseInt(carpetArea) || carpetArea}sqft`;
                            areaTypes.push({value: optionValue, text: displayName, configId, areaId, carpetArea});
                        }
                    }
                });
            }
        });
        
        // Populate all selects with collected area types
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Configuration</option>';
            areaTypes.forEach(areaType => {
                const option = document.createElement('option');
                option.value = areaType.value;
                option.textContent = areaType.text;
                if (currentValue === areaType.value) option.selected = true;
                select.appendChild(option);
            });
        });
        
        console.log(`Populated ${areaTypes.length} area types in ${selects.length} dropdowns`);
    }
    
    // Update area type options when configurations or area types change
    document.addEventListener('input', function(e) {
        if (e.target.matches('[name^="config_"][name$="_area_carpet_"]') || 
            e.target.matches('[name^="config_"][name$="_area_buildup_"]') ||
            e.target.matches('[name^="config_name_"]')) {
            populateAreaTypeOptions();
        }
    });
    
    // Update floor mapping when floors_per_tower or units_per_floor changes
    document.addEventListener('DOMContentLoaded', function() {
        const floorsInput = document.querySelector('[name="floors_per_tower"]');
        const unitsInput = document.querySelector('[name="units_per_floor"]');
        
        if (floorsInput) {
            floorsInput.addEventListener('change', generateFloorMapping);
        }
        if (unitsInput) {
            unitsInput.addEventListener('change', generateFloorMapping);
        }
        
        // Generate initial floor mapping if values are set
        generateFloorMapping();
    });
</script>
{% endblock %}

