{% extends 'base.html' %}

{% block title %}Edit Project - Bridgio CRM{% endblock %}

{% block page_title %}Edit Project{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-4 sm:mb-6">
        <h1 class="text-2xl sm:text-3xl font-heading font-semibold text-text-primary mb-2">Edit Project: {{ project.name }}</h1>
        <p class="text-sm sm:text-base text-text-secondary">Update project details, configurations, and floor mapping.</p>
    </div>
    
    <!-- Progress Steps -->
    <div class="mb-6 sm:mb-8 overflow-x-auto">
        <div class="flex items-center justify-between min-w-[900px] sm:min-w-0">
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-olive-primary text-white font-bold" id="step-1-indicator">1</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-olive-primary">Basic Information</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-1-2-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-2-indicator">2</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Tower Structure</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-2-3-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-3-indicator">3</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Configurations</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-3-4-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-4-indicator">4</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Floor Mapping</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-4-5-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-5-indicator">5</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Settings</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
        <form id="project-form" method="post" action="{% url 'projects:edit' project.pk %}" enctype="multipart/form-data" class="space-y-8" onsubmit="event.preventDefault(); return false;">
            {% csrf_token %}
            <input type="hidden" name="step" id="form-step" value="1">
            
            <!-- Step 1: Basic Information -->
            <div id="step-1" class="step-content">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Basic Information</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project Image</label>
                        {% if project.image %}
                        <div class="mb-2">
                            <img src="{{ project.image.url }}" alt="{{ project.name }}" class="w-32 h-32 object-cover rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Current image</p>
                        </div>
                        {% endif %}
                        <input type="file" name="image" id="image" accept="image/*"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                        <p class="text-xs text-gray-500 mt-1">Upload a new image to replace the current one</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project Name *</label>
                        <input type="text" name="name" id="name" value="{{ project.name }}" required
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Builder Name *</label>
                        <input type="text" name="builder_name" id="builder_name" value="{{ project.builder_name }}" required
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-text-primary mb-2">Location *</label>
                        <textarea name="location" id="location" rows="2" required
                                  class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">{{ project.location }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">RERA ID</label>
                        <input type="text" name="rera_id" id="rera_id" value="{{ project.rera_id|default:'' }}"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project Type *</label>
                        <select name="project_type" id="project_type" required
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select Type</option>
                            {% for value, label in project_type_choices %}
                            <option value="{{ value }}" {% if project.project_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Starting Price</label>
                        <div class="flex gap-2">
                            {% if project.starting_price %}
                                {% if project.starting_price_unit == 'crores' %}
                                    {% widthratio project.starting_price 10000000 1 as starting_price_display %}
                                {% else %}
                                    {% widthratio project.starting_price 100000 1 as starting_price_display %}
                                {% endif %}
                            {% endif %}
                            <input type="number" name="starting_price" id="starting_price" 
                                   value="{% if project.starting_price %}{{ starting_price_display }}{% endif %}" 
                                   step="0.01" placeholder="e.g., 58"
                                   class="flex-1 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <select name="starting_price_unit" id="starting_price_unit"
                                    class="w-32 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <option value="lakhs" {% if not project.starting_price_unit or project.starting_price_unit == 'lakhs' %}selected{% endif %}>Lakhs</option>
                                <option value="crores" {% if project.starting_price_unit == 'crores' %}selected{% endif %}>Crores</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Ending Price</label>
                        <div class="flex gap-2">
                            {% if project.ending_price %}
                                {% if project.ending_price_unit == 'crores' %}
                                    {% widthratio project.ending_price 10000000 1 as ending_price_display %}
                                {% else %}
                                    {% widthratio project.ending_price 100000 1 as ending_price_display %}
                                {% endif %}
                            {% endif %}
                            <input type="number" name="ending_price" id="ending_price" 
                                   value="{% if project.ending_price %}{{ ending_price_display }}{% endif %}" 
                                   step="0.01" placeholder="e.g., 85"
                                   class="flex-1 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <select name="ending_price_unit" id="ending_price_unit"
                                    class="w-32 px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                                <option value="lakhs" {% if not project.ending_price_unit or project.ending_price_unit == 'lakhs' %}selected{% endif %}>Lakhs</option>
                                <option value="crores" {% if project.ending_price_unit == 'crores' %}selected{% endif %}>Crores</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-text-primary mb-2">Inventory Summary</label>
                        <textarea name="inventory_summary" id="inventory_summary" rows="3"
                                  class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">{{ project.inventory_summary }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Latitude</label>
                        <input type="number" name="latitude" id="latitude" value="{{ project.latitude|default:'' }}" step="0.000001"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Longitude</label>
                        <input type="number" name="longitude" id="longitude" value="{{ project.longitude|default:'' }}" step="0.000001"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <a href="{% url 'projects:detail' project.pk %}" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Cancel</a>
                    <button type="button" onclick="submitStep(1, event)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Tower Structure</button>
                </div>
            </div>
            
            <!-- Step 2: Tower Structure -->
            <div id="step-2" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Tower and Unit Structure</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-text-primary mb-2">Number of Towers *</label>
                    <input type="number" name="number_of_towers" id="number_of_towers" value="{{ project.number_of_towers }}" min="1" required
                           onchange="generateTowerConfigs()"
                           class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    <p class="text-xs text-gray-500 mt-1">Set the number of towers, then configure each tower individually below</p>
                </div>
                
                <div id="tower-configs-container" class="space-y-4 mb-6">
                    <!-- Tower configurations will be generated here -->
                </div>
                
                <!-- Legacy fields (hidden, for backward compatibility) -->
                <input type="hidden" name="floors_per_tower" id="floors_per_tower" value="{{ project.floors_per_tower }}">
                <input type="hidden" name="units_per_floor" id="units_per_floor" value="{{ project.units_per_floor }}">
                <input type="hidden" name="has_commercial" id="has_commercial" value="{% if project.has_commercial %}on{% else %}off{% endif %}">
                <input type="hidden" name="commercial_floors" id="commercial_floors" value="{{ project.commercial_floors }}">
                <input type="hidden" name="commercial_units_per_floor" id="commercial_units_per_floor" value="{{ project.commercial_units_per_floor }}">
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(2)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitStep(2, event)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Configurations</button>
                </div>
            </div>
            
            <!-- Step 3: Configurations -->
            <div id="step-3" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Configurations & Pricing</h2>
                
                <div class="mb-4">
                    <button type="button" onclick="addConfiguration()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                        + Add Configuration
                    </button>
                </div>
                
                <div id="configurations-container" class="space-y-4 mb-6">
                    <!-- Existing configurations will be loaded here -->
                    {% for config in configurations %}
                    <div class="config-card border-2 border-gray-300 rounded-lg p-4 bg-gray-50" data-config-id="{{ config.id }}" data-config-index="{{ forloop.counter0 }}">
                        <input type="hidden" name="config_id_{{ forloop.counter0 }}" value="{{ config.id }}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Configuration {{ forloop.counter }}</h3>
                            <button type="button" onclick="removeConfiguration({{ config.id }})" 
                                    class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                Remove
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Configuration Name *</label>
                                <input type="text" name="config_name_{{ forloop.counter0 }}" value="{{ config.name }}" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Description</label>
                                <input type="text" name="config_description_{{ forloop.counter0 }}" value="{{ config.description|default:'' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Price per Sqft (₹)</label>
                                <input type="number" name="config_price_per_sqft_{{ forloop.counter0 }}" 
                                       value="{{ config.price_per_sqft|default:'' }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Stamp Duty (%)</label>
                                <input type="number" name="config_stamp_duty_{{ forloop.counter0 }}" value="{{ config.stamp_duty_percent }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">GST (%)</label>
                                <input type="number" name="config_gst_{{ forloop.counter0 }}" value="{{ config.gst_percent }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Registration Charges (₹)</label>
                                <input type="number" name="config_registration_{{ forloop.counter0 }}" value="{{ config.registration_charges }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Legal Charges (₹)</label>
                                <input type="number" name="config_legal_{{ forloop.counter0 }}" value="{{ config.legal_charges }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Development Charges (₹)</label>
                                <input type="number" name="config_development_{{ forloop.counter0 }}" value="{{ config.development_charges }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-semibold">Area Types</label>
                                <button type="button" onclick="addAreaType({{ config.id }})" 
                                        class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                                    + Add Area Type
                                </button>
                            </div>
                            <div id="area-types-{{ config.id }}" class="space-y-2">
                                {% for area_type in config.area_types.all %}
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-2 p-2 bg-white rounded border">
                                    <input type="hidden" name="config_{{ forloop.parentloop.counter0 }}_area_id_{{ forloop.counter0 }}" value="{{ area_type.id }}">
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Carpet Area (sqft)</label>
                                        <input type="number" name="config_{{ forloop.parentloop.counter0 }}_area_carpet_{{ forloop.counter0 }}" 
                                               value="{{ area_type.carpet_area }}" step="0.01" required
                                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Buildup Area (sqft)</label>
                                        <input type="number" name="config_{{ forloop.parentloop.counter0 }}_area_buildup_{{ forloop.counter0 }}" 
                                               value="{{ area_type.buildup_area }}" step="0.01" required
                                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">RERA Area (sqft)</label>
                                        <input type="number" name="config_{{ forloop.parentloop.counter0 }}_area_rera_{{ forloop.counter0 }}" 
                                               value="{{ area_type.rera_area|default:'' }}" step="0.01"
                                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium mb-1">Description</label>
                                        <input type="text" name="config_{{ forloop.parentloop.counter0 }}_area_desc_{{ forloop.counter0 }}" 
                                               value="{{ area_type.description|default:'' }}"
                                               class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(3)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" id="step-3-submit-btn" onclick="submitStep(3, event)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Floor Mapping</button>
                </div>
            </div>
            
            <!-- Step 4: Floor Mapping -->
            <div id="step-4" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Floor & Unit Mapping</h2>
                
                <p class="text-sm text-gray-600 mb-4">Map each unit to a configuration variant.</p>
                
                <div id="floor-mapping-container" class="space-y-4">
                    <p class="text-sm text-gray-500">Please complete previous steps to enable floor mapping.</p>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(4)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitStep(4, event)" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Next: Settings</button>
                </div>
            </div>
            
            <!-- Step 5: Settings -->
            <div id="step-5" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Settings & Assignment</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Default Commission %</label>
                        <input type="number" name="default_commission_percent" id="default_commission_percent" 
                               value="{{ project.default_commission_percent }}" step="0.01"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Auto Assignment Strategy</label>
                        <select name="auto_assignment_strategy" id="auto_assignment_strategy"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="manual" {% if project.auto_assignment_strategy == 'manual' %}selected{% endif %}>Manual</option>
                            <option value="round_robin" {% if project.auto_assignment_strategy == 'round_robin' %}selected{% endif %}>Round Robin</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Site Head</label>
                        <select name="site_head" id="site_head"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">None</option>
                            {% for head in site_heads %}
                            <option value="{{ head.id }}" {% if project.site_head_id == head.id %}selected{% endif %}>{{ head.get_full_name|default:head.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(5)" class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition">Previous</button>
                    <button type="button" onclick="submitFinalForm()" class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">Update Project</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script id="commercial-floors-data" type="application/json">{{ commercial_floors_data|safe }}</script>
<script>
    let configCounter = {{ configurations.count }};
    let areaCounters = {};
    
    // Initialize area counters for existing configs
    {% for config in configurations %}
    areaCounters[{{ config.id }}] = {{ config.area_types.count }};
    {% endfor %}
    
    // Step Navigation (same as create)
    function updateStepIndicators(currentStep) {
        for (let i = 1; i <= 5; i++) {
            const indicator = document.getElementById(`step-${i}-indicator`);
            const label = indicator.nextElementSibling.querySelector('p');
            const prevLine = i > 1 ? document.getElementById(`step-${i-1}-${i}-line`) : null;
            
            if (i < currentStep) {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-white font-bold';
                label.className = 'text-sm font-medium text-green-600';
                if (prevLine) prevLine.className = 'flex-1 h-1 mx-4 bg-green-500';
            } else if (i === currentStep) {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-olive-primary text-white font-bold';
                label.className = 'text-sm font-medium text-olive-primary';
                if (prevLine) prevLine.className = 'flex-1 h-1 mx-4 bg-olive-primary';
            } else {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold';
                label.className = 'text-sm font-medium text-gray-500';
                if (prevLine) prevLine.className = 'flex-1 h-1 mx-4 bg-gray-200';
            }
        }
    }
    
    function showStep(step) {
        for (let i = 1; i <= 5; i++) {
            document.getElementById(`step-${i}`).classList.add('hidden');
        }
        document.getElementById(`step-${step}`).classList.remove('hidden');
        updateStepIndicators(step);
        document.getElementById('form-step').value = step;
        
        // Generate floor mapping when step 4 is shown
        if (step === 4 && typeof generateFloorMapping === 'function') {
            setTimeout(() => {
                generateFloorMapping();
            }, 100);
        }
    }
    
    function previousStep(fromStep) {
        if (fromStep > 1) {
            showStep(fromStep - 1);
        }
    }
    
    function submitStep(step, event) {
        // Prevent default if event is provided
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const form = document.getElementById('project-form');
        if (!form) {
            alert('Form not found!');
            return;
        }
        
        const formData = new FormData(form);
        formData.set('step', step.toString());
        
        // Show loading state
        let submitButton = null;
        let originalText = '';
        if (event && event.target) {
            submitButton = event.target;
        } else {
            // Try to find button by ID or onclick attribute
            submitButton = document.getElementById(`step-${step}-submit-btn`) || 
                          document.querySelector(`button[onclick*="submitStep(${step})"]`);
        }
        
        if (submitButton) {
            originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Saving...';
        }
        
        const url = '{% url "projects:edit" project.pk %}';
        console.log('Submitting step', step, 'to', url);
        
        // Create AbortController for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        fetch(url, {
            method: 'POST',
            body: formData,
            signal: controller.signal,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(async response => {
            clearTimeout(timeoutId); // Clear timeout on successful response
            console.log('Response status:', response.status, 'Content-Type:', response.headers.get('content-type'));
            
            // Check content type to see if it's JSON
            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('application/json')) {
                // If not JSON, it's likely an HTML error page
                const text = await response.text();
                console.error('Non-JSON response (first 1000 chars):', text.substring(0, 1000));
                throw new Error('Server returned an error (Status: ' + response.status + '). Check browser console (F12) for details.');
            }
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (!response.ok) {
                throw new Error(data.error || data.message || 'Request failed with status ' + response.status);
            }
            return data;
        })
        .then(data => {
            if (data.success) {
                if (step === 1) {
                    showStep(2);
                    // Initialize commercial floors after moving to step 2
                    setTimeout(() => {
                        const numTowers = parseInt(document.getElementById('number_of_towers')?.value) || {{ project.number_of_towers }};
                        for (let i = 0; i < numTowers; i++) {
                            if (typeof updateCommercialFloors === 'function') {
                                updateCommercialFloors(i);
                            }
                        }
                    }, 100);
                } else if (step === 2) {
                    showStep(3);
                } else if (step === 3) {
                    showStep(4);
                    // Reload page to get updated configurations, or regenerate floor mapping after a short delay
                    setTimeout(() => {
                        if (typeof generateFloorMapping === 'function') {
                            generateFloorMapping();
                        }
                    }, 500);
                } else if (step === 4) {
                    showStep(5);
                } else if (step === 5 && data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            } else {
                alert(data.error || 'An error occurred. Please try again.');
            }
        })
        .catch(error => {
            clearTimeout(timeoutId); // Clear timeout on error
            console.error('Full error:', error);
            console.error('Error stack:', error.stack);
            
            if (error.name === 'AbortError') {
                alert('Request timed out after 30 seconds. The server may be processing a large amount of data. Please try again.');
            } else {
                alert('Error: ' + (error.message || 'An error occurred. Please check the browser console (F12) for details.'));
            }
        })
        .finally(() => {
            // Restore button state
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        });
    }
    
    function submitFinalForm() {
        const form = document.getElementById('project-form');
        const formData = new FormData(form);
        formData.set('step', '5');
        
        fetch('{% url "projects:edit" project.pk %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || data.message || 'Request failed');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = '{% url "projects:detail" project.pk %}';
                }
            } else {
                alert(data.error || data.message || 'An error occurred. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
    
    // Configuration Management (same as create)
    function addConfiguration() {
        const container = document.getElementById('configurations-container');
        const configId = configCounter++;
        // Use configId as index for new configs (they don't have database IDs yet)
        const configIndex = configId;
        areaCounters[configId] = 0;
        
        const configHtml = `
            <div class="config-card border-2 border-gray-300 rounded-lg p-4 bg-gray-50" data-config-id="${configId}" data-config-index="${configIndex}">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Configuration ${configId + 1}</h3>
                    <button type="button" onclick="removeConfiguration(${configId})" 
                            class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                        Remove
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Configuration Name *</label>
                        <input type="text" name="config_name_${configIndex}" required
                               placeholder="e.g., 1BHK"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input type="text" name="config_description_${configIndex}"
                               placeholder="Optional description"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Price per Sqft (₹)</label>
                        <input type="number" name="config_price_per_sqft_${configIndex}" step="0.01"
                               placeholder="e.g., 5000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Stamp Duty (%)</label>
                        <input type="number" name="config_stamp_duty_${configIndex}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">GST (%)</label>
                        <input type="number" name="config_gst_${configIndex}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Registration Charges (₹)</label>
                        <input type="number" name="config_registration_${configIndex}" value="30000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Legal Charges (₹)</label>
                        <input type="number" name="config_legal_${configIndex}" value="15000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Development Charges (₹)</label>
                        <input type="number" name="config_development_${configIndex}" value="0" step="0.01"
                               placeholder="e.g., 50000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold">Area Types</label>
                        <button type="button" onclick="addAreaType(${configId})" 
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                            + Add Area Type
                        </button>
                    </div>
                    <div id="area-types-${configId}" class="space-y-2">
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', configHtml);
    }
    
    function removeConfiguration(configId) {
        const configCard = document.querySelector(`[data-config-id="${configId}"]`);
        if (configCard) {
            configCard.remove();
        }
    }
    
    function addAreaType(configId) {
        const container = document.getElementById(`area-types-${configId}`);
        const areaId = areaCounters[configId] || 0;
        areaCounters[configId] = areaId + 1;
        
        // Get config index from the card's data attribute
        const configCard = document.querySelector(`[data-config-id="${configId}"]`);
        const configIndex = configCard ? (configCard.getAttribute('data-config-index') || configId) : configId;
        
        const areaHtml = `
            <div class="grid grid-cols-1 md:grid-cols-4 gap-2 p-2 bg-white rounded border">
                <div>
                    <label class="block text-xs font-medium mb-1">Carpet Area (sqft)</label>
                    <input type="number" name="config_${configIndex}_area_carpet_${areaId}" step="0.01" required
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Buildup Area (sqft)</label>
                    <input type="number" name="config_${configIndex}_area_buildup_${areaId}" step="0.01" required
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">RERA Area (sqft)</label>
                    <input type="number" name="config_${configIndex}_area_rera_${areaId}" step="0.01"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
                <div>
                    <label class="block text-xs font-medium mb-1">Description</label>
                    <input type="text" name="config_${configIndex}_area_desc_${areaId}"
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', areaHtml);
    }
    
    function toggleCommercialFields() {
        const checkbox = document.getElementById('has_commercial');
        const fields = document.getElementById('commercial_fields');
        if (checkbox.checked) {
            fields.classList.remove('hidden');
        } else {
            fields.classList.add('hidden');
        }
    }
    
    function getFloorDisplayName(floorNum) {
        if (floorNum === 1) return "Ground (G)";
        if (floorNum === 2) return "1st Floor";
        if (floorNum === 3) return "2nd Floor";
        return `${floorNum - 1}th Floor`;
    }
    
    function updateCommercialFloors(towerIndex) {
        const floorsInput = document.getElementById(`tower_${towerIndex}_floors`);
        const floorsCount = parseInt(floorsInput?.value) || 1;
        const container = document.getElementById(`commercial-floors-${towerIndex}`);
        
        if (!container) return;
        
        // Total floors = G (floor 1) + floorsCount (floors 2 to floorsCount+1)
        // So we display: G, 1st, 2nd, ..., floorsCount-th
        const totalFloors = floorsCount + 1; // G + N floors
        
        let html = '';
        for (let floor = 1; floor <= totalFloors; floor++) {
            const floorName = getFloorDisplayName(floor);
            const existingCheck = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial"]`);
            const isChecked = existingCheck ? existingCheck.checked : false;
            const existingUnits = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial_units"]`)?.value || '';
            
            html += `
                <div class="flex items-center gap-3 p-3 bg-white border border-gray-300 rounded hover:bg-gray-50">
                    <label class="flex items-center cursor-pointer flex-1">
                        <input type="checkbox" name="tower_${towerIndex}_floor_${floor}_commercial" 
                               value="on" ${isChecked ? 'checked' : ''}
                               onchange="toggleCommercialUnits(${towerIndex}, ${floor}, this.checked)"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="ml-2 text-sm font-medium">${floorName}</span>
                    </label>
                    ${floor === 1 ? '<span class="text-xs text-gray-500">(Vacant/Parking if not commercial)</span>' : ''}
                    <div id="commercial-units-${towerIndex}-${floor}" class="${isChecked ? '' : 'hidden'}">
                        <label class="text-xs text-gray-600 mr-2">Units:</label>
                        <input type="number" name="tower_${towerIndex}_floor_${floor}_commercial_units" 
                               value="${existingUnits}" min="1" placeholder="Units"
                               class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-blue-500">
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
    }
    
    function toggleCommercialUnits(towerIndex, floor, isChecked) {
        const unitsDiv = document.getElementById(`commercial-units-${towerIndex}-${floor}`);
        if (unitsDiv) {
            if (isChecked) {
                unitsDiv.classList.remove('hidden');
            } else {
                unitsDiv.classList.add('hidden');
                const unitsInput = unitsDiv.querySelector('input[type="number"]');
                if (unitsInput) unitsInput.value = '';
            }
        }
    }
    
    function generateTowerConfigs() {
        const container = document.getElementById('tower-configs-container');
        const numTowers = parseInt(document.getElementById('number_of_towers')?.value) || {{ project.number_of_towers }};
        
        let html = '';
        for (let i = 0; i < numTowers; i++) {
            const towerNum = i + 1;
            // Try to get existing config values from form inputs
            const existingConfig = document.querySelector(`input[name="tower_${i}_number"]`);
            const existingFloors = existingConfig ? document.querySelector(`input[name="tower_${i}_floors"]`)?.value : '{{ project.floors_per_tower }}';
            const existingUnits = existingConfig ? document.querySelector(`input[name="tower_${i}_units_per_floor"]`)?.value : '{{ project.units_per_floor }}';
            const existingCommercial = existingConfig ? document.querySelector(`input[name="tower_${i}_is_commercial"]`)?.checked : false;
            
            html += `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4" data-tower-index="${i}">
                    <h3 class="text-lg font-semibold mb-4">Tower ${towerNum}</h3>
                    <input type="hidden" name="tower_${i}_number" value="${towerNum}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Number of Floors *</label>
                            <input type="number" name="tower_${i}_floors" id="tower_${i}_floors" value="${existingFloors || 1}" min="1" required
                                   onchange="updateCommercialFloors(${i})"
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Units per Floor *</label>
                            <input type="number" name="tower_${i}_units_per_floor" value="${existingUnits || 1}" min="1" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium mb-2">Select Commercial Floors:</label>
                        <div id="commercial-floors-${i}" class="flex flex-wrap gap-3 p-3 bg-white rounded border border-gray-300">
                            <!-- Commercial floor checkboxes will be generated here -->
                        </div>
                    </div>
                </div>
            `;
        }
        container.innerHTML = html;
        // Initialize commercial floors for all towers
        for (let i = 0; i < numTowers; i++) {
            updateCommercialFloors(i);
        }
    }
    
    function loadExistingTowerConfigs() {
        const towerConfigs = [
            {% for tfc in tower_floor_configs %}
            {
                towerNum: {{ tfc.tower_number }},
                floors: {{ tfc.floors_count }},
                unitsPerFloor: {{ tfc.units_per_floor }},
                isCommercial: {{ tfc.is_commercial|yesno:"true,false" }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Get existing commercial floors from unit configurations
        const existingCommercialFloors = {};
        {% for key, uc in unit_configurations.items %}
        {% if uc.is_commercial %}
        (function() {
            const keyStr = '{{ key }}';
            const parts = keyStr.split('_');
            if (parts.length >= 2) {
                const towerKey = parts[0];
                const floorKey = parts[1];
                if (!existingCommercialFloors[towerKey]) {
                    existingCommercialFloors[towerKey] = new Set();
                }
                existingCommercialFloors[towerKey].add(floorKey);
            }
        })();
        {% endif %}
        {% endfor %}
        
        // Set number of towers input
        if (towerConfigs.length > 0) {
            const numTowersInput = document.getElementById('number_of_towers');
            if (numTowersInput) {
                numTowersInput.value = towerConfigs.length;
            }
        }
        
        // Get commercial floors from backend data
        const backendCommercialFloors = JSON.parse(document.getElementById('commercial-floors-data')?.textContent || '{}');
        
        if (towerConfigs.length > 0) {
            const container = document.getElementById('tower-configs-container');
            let html = '';
            towerConfigs.forEach((config, i) => {
                // Convert floors_count to "number of floors excluding ground"
                // floors_count = G + N, so N = floors_count - 1
                const floorsExcludingGround = config.floors - 1;
                
                html += `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4" data-tower-index="${i}">
                        <h3 class="text-lg font-semibold mb-4">Tower ${config.towerNum}</h3>
                        <input type="hidden" name="tower_${i}_number" value="${config.towerNum}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Number of Floors (excluding Ground) *</label>
                                <input type="number" name="tower_${i}_floors" id="tower_${i}_floors" value="${floorsExcludingGround}" min="1" required
                                       onchange="updateCommercialFloors(${i})"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Total floors: ${config.floors} (G + ${floorsExcludingGround})</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Units per Floor *</label>
                                <input type="number" name="tower_${i}_units_per_floor" value="${config.unitsPerFloor}" min="1" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Select Commercial Floors:</label>
                            <div id="commercial-floors-${i}" class="flex flex-wrap gap-3 p-3 bg-white rounded border border-gray-300">
                                <!-- Commercial floor checkboxes will be generated here -->
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            // Generate commercial floor checkboxes and check existing ones
            towerConfigs.forEach((config, i) => {
                updateCommercialFloors(i);
                // Check existing commercial floors from backend data
                const towerCommercialFloors = backendCommercialFloors[config.towerNum] || {};
                for (const [floorNum, unitsCount] of Object.entries(towerCommercialFloors)) {
                    const floor = parseInt(floorNum);
                    const checkbox = document.querySelector(`input[name="tower_${i}_floor_${floor}_commercial"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        toggleCommercialUnits(i, floor, true);
                        const unitsInput = document.querySelector(`input[name="tower_${i}_floor_${floor}_commercial_units"]`);
                        if (unitsInput) {
                            unitsInput.value = unitsCount;
                        }
                    }
                }
                // Also check from existingCommercialFloors set (for backward compatibility)
                const towerKey = config.towerNum.toString();
                if (existingCommercialFloors[towerKey]) {
                    existingCommercialFloors[towerKey].forEach(floorKey => {
                        const floor = parseInt(floorKey);
                        const checkbox = document.querySelector(`input[name="tower_${i}_floor_${floor}_commercial"]`);
                        if (checkbox && !checkbox.checked) {
                            checkbox.checked = true;
                            toggleCommercialUnits(i, floor, true);
                        }
                    });
                }
            });
        } else {
            generateTowerConfigs();
        }
    }
    
    function generateFloorMapping() {
        const container = document.getElementById('floor-mapping-container');
        const numTowers = parseInt(document.getElementById('number_of_towers')?.value) || {{ project.number_of_towers }};
        
        // Get tower configurations from form inputs - find all tower number inputs first
        const towerConfigs = [];
        const towerInputs = document.querySelectorAll('input[name^="tower_"][name$="_number"]');
        
        // Collect all tower configs by finding their corresponding inputs
        towerInputs.forEach(towerNumInput => {
            const nameMatch = towerNumInput.name.match(/tower_(\d+)_number/);
            if (nameMatch) {
                const index = parseInt(nameMatch[1]);
                const towerNum = parseInt(towerNumInput.value) || (index + 1);
                const floorsInput = document.querySelector(`input[name="tower_${index}_floors"]`);
                const unitsInput = document.querySelector(`input[name="tower_${index}_units_per_floor"]`);
                const commercialInput = document.querySelector(`input[name="tower_${index}_is_commercial"]`);
                
                if (floorsInput && unitsInput) {
                    // floorsInput.value is "number of floors excluding ground" (N)
                    // Total floors = G + N = 1 + N
                    const floorsExcludingGround = parseInt(floorsInput.value) || 1;
                    const totalFloors = floorsExcludingGround + 1; // G + N
                    towerConfigs.push({
                        towerNum: towerNum,
                        floors: totalFloors, // Total floors including ground
                        floorsExcludingGround: floorsExcludingGround, // N (for reference)
                        unitsPerFloor: parseInt(unitsInput.value) || 1,
                        isCommercial: commercialInput ? commercialInput.checked : false
                    });
                }
            }
        });
        
        // Sort by tower number to ensure correct order
        towerConfigs.sort((a, b) => a.towerNum - b.towerNum);
        
        if (towerConfigs.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">Please complete Tower Structure step first.</p>';
            return;
        }
        
        // Get all configurations for dropdown
        const configs = [];
        document.querySelectorAll('[data-config-id]').forEach(card => {
            const configId = card.getAttribute('data-config-id');
            // Get config index from data attribute or hidden input
            let configIndex = card.getAttribute('data-config-index');
            if (!configIndex) {
                const configIdInput = card.querySelector('input[name^="config_id_"]');
                if (configIdInput) {
                    const nameMatch = configIdInput.name.match(/config_id_(\d+)/);
                    if (nameMatch) {
                        configIndex = parseInt(nameMatch[1]);
                    }
                }
            } else {
                configIndex = parseInt(configIndex);
            }
            
            if (configIndex === null || isNaN(configIndex)) {
                console.warn('Could not find config index for config', configId);
                return;
            }
            
            // Find config name input (config_name_0, config_name_1, etc.)
            const configNameInput = card.querySelector(`input[name="config_name_${configIndex}"]`);
            if (configNameInput && configNameInput.value) {
                const configName = configNameInput.value;
                const areaContainer = card.querySelector(`#area-types-${configId}`);
                if (areaContainer) {
                    const areaTypes = [];
                    // Look for area type inputs - they use config_{index}_area_carpet_{areaIndex}
                    // e.g., config_0_area_carpet_0, config_0_area_carpet_1, etc.
                    const carpetInputs = areaContainer.querySelectorAll(`input[name^="config_${configIndex}_area_carpet_"]`);
                    carpetInputs.forEach(input => {
                        const nameMatch = input.name.match(/config_\d+_area_carpet_(\d+)/);
                        if (nameMatch) {
                            const areaId = nameMatch[1];
                            const carpet = input.value.trim();
                            const buildupInput = areaContainer.querySelector(`input[name="config_${configIndex}_area_buildup_${areaId}"]`);
                            const buildup = buildupInput?.value.trim() || '';
                            if (carpet && buildup) {
                                areaTypes.push({
                                    id: areaId,
                                    carpet: carpet,
                                    buildup: buildup,
                                    value: `config_${configIndex}_area_${areaId}`
                                });
                            }
                        }
                    });
                    if (areaTypes.length > 0) {
                        configs.push({id: configId, index: configIndex, name: configName, areaTypes: areaTypes});
                    } else {
                        console.warn('Config', configName, 'has no area types');
                    }
                } else {
                    console.warn('Could not find area container for config', configId);
                }
            } else {
                console.warn('Could not find config name input for config', configId, 'index', configIndex);
            }
        });
        
        console.log('Found configurations:', configs);
        
        if (configs.length === 0) {
            container.innerHTML = '<p class="text-sm text-red-600">Please add at least one configuration with area types first.</p>';
            return;
        }
        
        // Get commercial floors data from backend
        const backendCommercialFloors = JSON.parse(document.getElementById('commercial-floors-data')?.textContent || '{}');
        
        // Get existing unit configurations
        const existingUnits = {};
        const commercialFloors = new Set(); // Track which floors are commercial
        {% for key, uc in unit_configurations.items %}
        existingUnits['{{ key }}'] = {
            area_type_id: {{ uc.area_type_id|default:"null" }},
            is_excluded: {{ uc.is_excluded|yesno:"true,false" }},
            is_commercial: {{ uc.is_commercial|yesno:"true,false" }}
        };
        {% if uc.is_commercial %}
        // Extract tower and floor from key (format: "tower_floor_unit")
        (function(keyStr) {
            const parts = keyStr.split('_');
            if (parts.length >= 2) {
                commercialFloors.add(`${parts[0]}_${parts[1]}`);
            }
        })('{{ key }}');
        {% endif %}
        {% endfor %}
        
        let html = '';
        for (const towerConfig of towerConfigs) {
            const tower = towerConfig.towerNum;
            // floorsPerTower from form is "N" (excluding ground), but we stored it as total (G + N)
            // If it has floorsExcludingGround, use that to calculate total, otherwise assume it's already total
            let floorsPerTower = towerConfig.floors;
            if (towerConfig.floorsExcludingGround !== undefined) {
                // floorsExcludingGround is N, total = G + N = 1 + N
                floorsPerTower = towerConfig.floorsExcludingGround + 1;
            }
            const unitsPerFloor = towerConfig.unitsPerFloor;
            const isCommercialTower = towerConfig.isCommercial;
            
            html += `<div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">`;
            html += `<h3 class="text-lg font-semibold mb-4">Tower ${tower}${isCommercialTower ? ' <span class="text-sm text-blue-600">(Commercial)</span>' : ''}</h3>`;
            
            // Get commercial floors and their unit counts
            // First try from backend data (most reliable)
            const commercialFloorsData = {};
            try {
                const backendCommercialFloors = JSON.parse(document.getElementById('commercial-floors-data')?.textContent || '{}');
                if (backendCommercialFloors && backendCommercialFloors[tower]) {
                    Object.assign(commercialFloorsData, backendCommercialFloors[tower]);
                }
            } catch (e) {
                console.warn('Error parsing commercial floors data:', e);
            }
            
            // Also try to read from form inputs (in case user just updated step 2)
            // Need to find the tower index first, then use that to find the inputs
            const towerInputs = document.querySelectorAll('input[name^="tower_"][name$="_number"]');
            let towerIndex = null;
            for (const input of towerInputs) {
                if (parseInt(input.value) === tower) {
                    const nameMatch = input.name.match(/tower_(\d+)_number/);
                    if (nameMatch) {
                        towerIndex = parseInt(nameMatch[1]);
                        break;
                    }
                }
            }
            
            // If we found the tower index, read commercial floor data from form
            // floorsPerTower is already total floors (G + N) after our fix above
            if (towerIndex !== null) {
                for (let floor = 1; floor <= floorsPerTower; floor++) {
                    const commercialCheck = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial"]`);
                    if (commercialCheck && commercialCheck.checked) {
                        const unitsInput = document.querySelector(`input[name="tower_${towerIndex}_floor_${floor}_commercial_units"]`);
                        const units = unitsInput ? parseInt(unitsInput.value) || unitsPerFloor : unitsPerFloor;
                        // Form data takes precedence over backend data
                        commercialFloorsData[floor] = units;
                    }
                }
            }
            
            // Track if any commercial floors were found
            let hasCommercialFloors = Object.keys(commercialFloorsData).length > 0 || commercialFloors.has(`${tower}_1`) || isCommercialTower;
            
            // Only show floors that are marked as commercial
            // If G (floor 1) is not commercial, skip it
            let floorsAdded = 0;
            for (let floor = 1; floor <= floorsPerTower; floor++) {
                const floorKey = `${tower}_${floor}`;
                // Check if this floor is marked as commercial
                const isCommercialFloor = floor in commercialFloorsData || commercialFloors.has(floorKey) || isCommercialTower;
                
                // Skip ground floor (G) if it's not commercial - it's vacant/parking
                // But show all other floors (residential or commercial)
                if (floor === 1 && !isCommercialFloor) {
                    continue;
                }
                
                floorsAdded++;
                
                const floorExcluded = existingUnits[`${tower}_${floor}_0`]?.is_excluded || false;
                
                // Get units per floor for this floor
                // For commercial floors, use the specified unit count, otherwise use default
                let unitsPerFloorThis = unitsPerFloor;
                if (isCommercialFloor && floor in commercialFloorsData) {
                    unitsPerFloorThis = commercialFloorsData[floor];
                }
                
                // Get floor display name
                let floorDisplayName;
                if (floor === 1) {
                    floorDisplayName = "Ground (G)";
                } else if (floor === 2) {
                    floorDisplayName = "1st Floor";
                } else if (floor === 3) {
                    floorDisplayName = "2nd Floor";
                } else {
                    floorDisplayName = `${floor - 1}th Floor`;
                }
                
                // Determine floor type label
                const floorTypeLabel = isCommercialFloor ? 
                    `<span class="ml-4 text-sm font-medium text-blue-600">✓ Commercial Floor (${unitsPerFloorThis} units)</span>` :
                    `<span class="ml-4 text-sm font-medium text-green-600">✓ Residential Floor (${unitsPerFloorThis} units)</span>`;
                
                html += `<div class="mb-4 p-3 bg-white rounded border ${isCommercialFloor ? 'border-blue-300 bg-blue-50' : 'border-green-300 bg-green-50'}">`;
                html += `<div class="flex items-center justify-between mb-2 flex-wrap gap-2">`;
                html += `<div class="flex items-center gap-4">`;
                html += `<label class="flex items-center">`;
                html += `<input type="checkbox" name="tower_${tower}_floor_${floor}_excluded" ${floorExcluded ? 'checked' : ''} class="mr-2">`;
                html += `<span class="font-medium">${floorDisplayName} - Exclude Entire Floor</span>`;
                html += `</label>`;
                html += floorTypeLabel;
                html += `</div>`;
                html += `</div>`;
                
                for (let unit = 1; unit <= unitsPerFloorThis; unit++) {
                    // Ground floor (1): 01, 02, 03... First floor (2): 101, 102, 103...
                    let unitNumber;
                    if (floor === 1) {
                        unitNumber = unit; // Will be displayed as 01, 02, 03...
                    } else {
                        unitNumber = (floor - 1) * 100 + unit;
                    }
                    const unitKey = `${tower}_${floor}_${unitNumber}`;
                    const unitData = existingUnits[unitKey];
                    const unitExcluded = unitData?.is_excluded || false;
                    
                    // Find the matching area type for this unit
                    // unitData.area_type_id is the database ID of ConfigurationAreaType
                    // We need to find which config and area type index it corresponds to
                    let selectedAreaType = '';
                    if (unitData?.area_type_id) {
                        // Search through all configs and area types to find a match
                        // The hidden input format is: config_{configIndex}_area_id_{areaIndex}
                        // We need to search all area type hidden inputs to find the one with matching ID
                        for (const config of configs) {
                            const areaContainer = document.querySelector(`#area-types-${config.id}`);
                            if (areaContainer) {
                                // Find all hidden area_id inputs for this config
                                const areaIdInputs = areaContainer.querySelectorAll(`input[name^="config_${config.index}_area_id_"]`);
                                for (const areaIdInput of areaIdInputs) {
                                    if (parseInt(areaIdInput.value) === unitData.area_type_id) {
                                        // Extract the area index from the input name
                                        const nameMatch = areaIdInput.name.match(/config_\d+_area_id_(\d+)/);
                                        if (nameMatch) {
                                            const areaIndex = nameMatch[1];
                                            // Find the corresponding area type in our configs array
                                            const matchingAreaType = config.areaTypes.find(at => at.id === areaIndex);
                                            if (matchingAreaType) {
                                                selectedAreaType = matchingAreaType.value;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                            if (selectedAreaType) break;
                        }
                    }
                    
                    // Format unit number for display
                    let unitDisplay;
                    if (floor === 1) {
                        unitDisplay = String(unitNumber).padStart(2, '0'); // 01, 02, 03...
                    } else {
                        unitDisplay = unitNumber;
                    }
                    html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2 p-2 bg-gray-50 rounded">`;
                    html += `<div class="flex items-center">`;
                    html += `<span class="text-sm font-medium">Unit ${unitDisplay}</span>`;
                    html += `</div>`;
                    html += `<div class="flex items-center">`;
                    html += `<input type="checkbox" name="tower_${tower}_floor_${floor}_unit_${unit}_excluded" ${unitExcluded ? 'checked' : ''} class="mr-2">`;
                    html += `<span class="text-xs">Exclude</span>`;
                    html += `</div>`;
                    html += `<div>`;
                    html += `<select name="tower_${tower}_floor_${floor}_unit_${unit}_area_type" class="w-full px-2 py-1 text-sm border border-gray-300 rounded">`;
                    html += `<option value="">Select Configuration</option>`;
                    configs.forEach(config => {
                        config.areaTypes.forEach(areaType => {
                            const selected = selectedAreaType === areaType.value ? 'selected' : '';
                            html += `<option value="${areaType.value}" ${selected}>${config.name} - ${areaType.carpet}/${areaType.buildup} sqft</option>`;
                        });
                    });
                    html += `</select>`;
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            }
            
            // If no floors were found for this tower (all skipped or no floors configured), show a message
            if (floorsAdded === 0) {
                html += `<div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">`;
                html += `<p class="text-sm text-yellow-800 font-medium mb-2">No floors available for mapping in Tower ${tower}</p>`;
                html += `<p class="text-xs text-yellow-700">This tower has no floors configured, or only ground floor (G) which is not commercial. Please go back to <strong>Tower Structure</strong> step to configure floors. Residential floors (above ground) will automatically appear in floor mapping.</p>`;
                html += `</div>`;
            }
            
            html += `</div>`;
        }
        
        if (html.trim() === '') {
            container.innerHTML = '<div class="p-4 bg-red-50 border border-red-200 rounded-lg"><p class="text-sm text-red-800 font-medium">No tower configurations found. Please complete Tower Structure step first.</p></div>';
        } else {
            container.innerHTML = html;
        }
        
        console.log('Floor mapping generated. HTML length:', html.length, 'Towers:', towerConfigs.length);
    }
    
    // Initialize
    updateStepIndicators(1);
    {% if tower_floor_configs %}
    loadExistingTowerConfigs(); // Load existing tower configs
    {% else %}
    generateTowerConfigs(); // Generate initial tower configs if none exist
    // Initialize commercial floors for new towers
    setTimeout(() => {
        const numTowers = parseInt(document.getElementById('number_of_towers')?.value) || 1;
        for (let i = 0; i < numTowers; i++) {
            updateCommercialFloors(i);
        }
    }, 100);
    {% endif %}
</script>
{% endblock %}
