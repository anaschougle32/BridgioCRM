{% extends 'base.html' %}

{% block title %}Edit Project - Bridgio CRM{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-heading font-bold text-olive-primary">Edit Project: {{ project.name }}</h1>
        <a href="{% url 'projects:detail' project.pk %}" class="text-olive-primary hover:text-olive-secondary">← Back to Project</a>
    </div>
    
    <div class="bg-white rounded-custom shadow-md p-6">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Image</label>
                        {% if project.image %}
                        <div class="mb-2">
                            <img src="{{ project.image.url }}" alt="{{ project.name }}" class="w-32 h-32 object-cover rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Current image</p>
                        </div>
                        {% endif %}
                        <input type="file" name="image" accept="image/*"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <p class="text-xs text-gray-500 mt-1">Upload a new image to replace the current one</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Name *</label>
                        <input type="text" name="name" value="{{ project.name }}" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Builder Name *</label>
                        <input type="text" name="builder_name" value="{{ project.builder_name }}" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Location *</label>
                        <textarea name="location" rows="2" required
                                  class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">{{ project.location }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">RERA ID</label>
                        <input type="text" name="rera_id" value="{{ project.rera_id|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Type *</label>
                        <select name="project_type" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="">Select Type</option>
                            {% for value, label in project_type_choices %}
                            <option value="{{ value }}" {% if project.project_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Starting Price</label>
                        <div class="flex gap-2">
                            {% if project.starting_price %}
                                {% if project.starting_price_unit == 'crores' %}
                                    {% widthratio project.starting_price 10000000 1 as starting_price_display %}
                                {% else %}
                                    {% widthratio project.starting_price 100000 1 as starting_price_display %}
                                {% endif %}
                            {% endif %}
                            <input type="number" name="starting_price" 
                                   value="{% if project.starting_price %}{{ starting_price_display }}{% endif %}" 
                                   step="0.01" placeholder="e.g., 58"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <select name="starting_price_unit"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                                <option value="lakhs" {% if not project.starting_price_unit or project.starting_price_unit == 'lakhs' %}selected{% endif %}>Lakhs</option>
                                <option value="crores" {% if project.starting_price_unit == 'crores' %}selected{% endif %}>Crores</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Ending Price</label>
                        <div class="flex gap-2">
                            {% if project.ending_price %}
                                {% if project.ending_price_unit == 'crores' %}
                                    {% widthratio project.ending_price 10000000 1 as ending_price_display %}
                                {% else %}
                                    {% widthratio project.ending_price 100000 1 as ending_price_display %}
                                {% endif %}
                            {% endif %}
                            <input type="number" name="ending_price" 
                                   value="{% if project.ending_price %}{{ ending_price_display }}{% endif %}" 
                                   step="0.01" placeholder="e.g., 85"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <select name="ending_price_unit"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                                <option value="lakhs" {% if not project.ending_price_unit or project.ending_price_unit == 'lakhs' %}selected{% endif %}>Lakhs</option>
                                <option value="crores" {% if project.ending_price_unit == 'crores' %}selected{% endif %}>Crores</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Inventory Summary</label>
                        <textarea name="inventory_summary" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">{{ project.inventory_summary }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Tower and Unit Structure -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Tower and Unit Structure</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Number of Towers *</label>
                        <input type="number" name="number_of_towers" value="{{ project.number_of_towers }}" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Floors per Tower *</label>
                        <input type="number" name="floors_per_tower" value="{{ project.floors_per_tower }}" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Units per Floor (Residential) *</label>
                        <input type="number" name="units_per_floor" value="{{ project.units_per_floor }}" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="has_commercial" id="has_commercial" {% if project.has_commercial %}checked{% endif %}
                               class="w-4 h-4 text-olive-primary border-gray-300 rounded focus:ring-olive-primary"
                               onchange="toggleCommercialFields()">
                        <label for="has_commercial" class="ml-2 text-sm font-medium">Has Commercial Units</label>
                    </div>
                    <div id="commercial_fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 {% if not project.has_commercial %}hidden{% endif %}">
                        <div>
                            <label class="block text-sm font-medium mb-2">Commercial Floors</label>
                            <input type="number" name="commercial_floors" value="{{ project.commercial_floors }}" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Commercial Units per Floor</label>
                            <input type="number" name="commercial_units_per_floor" value="{{ project.commercial_units_per_floor }}" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Location Coordinates -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Location Coordinates</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Latitude</label>
                        <input type="number" name="latitude" value="{{ project.latitude|default:'' }}" step="0.000001"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Longitude</label>
                        <input type="number" name="longitude" value="{{ project.longitude|default:'' }}" step="0.000001"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Project Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Default Commission %</label>
                        <input type="number" name="default_commission_percent" value="{{ project.default_commission_percent }}" step="0.01"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Auto Assignment Strategy</label>
                        <select name="auto_assignment_strategy"
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="manual" {% if project.auto_assignment_strategy == 'manual' %}selected{% endif %}>Manual</option>
                            <option value="round_robin" {% if project.auto_assignment_strategy == 'round_robin' %}selected{% endif %}>Round Robin</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" id="is_active" {% if project.is_active %}checked{% endif %}
                               class="w-4 h-4 text-olive-primary border-gray-300 rounded focus:ring-olive-primary">
                        <label for="is_active" class="ml-2 text-sm font-medium">Active</label>
                    </div>
                </div>
            </div>
            
            <!-- Configurations -->
            <div id="configurations-section">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-heading font-bold">Configurations & Pricing</h2>
                    <button type="button" onclick="addConfiguration()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-custom hover:bg-blue-700 transition text-sm">
                        + Add Configuration
                    </button>
                </div>
                <p class="text-sm text-gray-600 mb-4">Add configurations (1BHK, 2BHK, etc.) with pricing and area variants. Save configurations first, then proceed to floor mapping.</p>
                <div id="configurations-container" class="space-y-4">
                    {% for config in configurations %}
                    <div class="config-card border-2 border-gray-300 rounded-lg p-4 bg-gray-50" data-config-id="{{ forloop.counter0 }}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Configuration {{ forloop.counter }}</h3>
                            <button type="button" onclick="removeConfiguration({{ forloop.counter0 }})" 
                                    class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                                Remove
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Configuration Name *</label>
                                <input type="text" name="config_name_{{ forloop.counter0 }}" value="{{ config.name }}" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Description</label>
                                <input type="text" name="config_description_{{ forloop.counter0 }}" value="{{ config.description }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Price per Sqft (₹)</label>
                                <input type="number" name="config_price_per_sqft_{{ forloop.counter0 }}" 
                                       value="{% if config.price_per_sqft %}{{ config.price_per_sqft }}{% endif %}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Stamp Duty (%)</label>
                                <input type="number" name="config_stamp_duty_{{ forloop.counter0 }}" 
                                       value="{{ config.stamp_duty_percent }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">GST (%)</label>
                                <input type="number" name="config_gst_{{ forloop.counter0 }}" 
                                       value="{{ config.gst_percent }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Registration Charges (₹)</label>
                                <input type="number" name="config_registration_{{ forloop.counter0 }}" 
                                       value="{{ config.registration_charges }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Legal Charges (₹)</label>
                                <input type="number" name="config_legal_{{ forloop.counter0 }}" 
                                       value="{{ config.legal_charges }}" step="0.01"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Development Charges (₹)</label>
                                <input type="number" name="config_development_{{ forloop.counter0 }}" 
                                       value="{{ config.development_charges }}" step="0.01"
                                       placeholder="e.g., 50000"
                                       class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <!-- Area Types -->
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-sm font-semibold">Area Types (Carpet, Buildup, RERA)</label>
                                <button type="button" onclick="addAreaType({{ forloop.counter0 }})" 
                                        class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                                    + Add Area Type
                                </button>
                            </div>
                            <div id="area-types-{{ forloop.counter0 }}" class="space-y-2">
                                {% for area in config.area_types.all %}
                                <div class="flex gap-2 items-end bg-white p-2 rounded border">
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium mb-1">Carpet Area (sqft) *</label>
                                        <input type="number" name="config_{{ forloop.parentloop.counter0 }}_area_carpet_{{ forloop.counter0 }}" 
                                               value="{{ area.carpet_area }}" step="0.01" required
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium mb-1">Buildup Area (sqft) *</label>
                                        <input type="number" name="config_{{ forloop.parentloop.counter0 }}_area_buildup_{{ forloop.counter0 }}" 
                                               value="{{ area.buildup_area }}" step="0.01" required
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium mb-1">RERA Area (sqft)</label>
                                        <input type="number" name="config_{{ forloop.parentloop.counter0 }}_area_rera_{{ forloop.counter0 }}" 
                                               value="{% if area.rera_area %}{{ area.rera_area }}{% endif %}" step="0.01"
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium mb-1">Description</label>
                                        <input type="text" name="config_{{ forloop.parentloop.counter0 }}_area_desc_{{ forloop.counter0 }}" 
                                               value="{{ area.description }}"
                                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                    <button type="button" onclick="this.parentElement.remove(); populateAreaTypeOptions();" 
                                            class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
                                        ×
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-6 flex justify-end">
                    <button type="button" onclick="saveConfigurations()" 
                            class="px-6 py-2 bg-green-600 text-white rounded-custom hover:bg-green-700 transition">
                        Save Configurations & Continue to Floor Mapping
                    </button>
                </div>
            </div>
            
            <!-- Floor Mapping Section -->
            <div id="floor-mapping-section" class="{% if configurations %}block{% else %}hidden{% endif %}">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-heading font-bold">Floor & Unit Mapping</h2>
                </div>
                <p class="text-sm text-gray-600 mb-4">Map each unit to a configuration variant. Make sure "Floors per Tower" and "Units per Floor" are set above.</p>
                <div id="floor-mapping-container" class="space-y-4">
                    <!-- Floor mapping will be generated here -->
                </div>
            </div>
            
            <!-- Assignment -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Assignment</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if mandate_owners %}
                    <div>
                        <label class="block text-sm font-medium mb-2">Mandate Owner *</label>
                        <select name="mandate_owner" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            {% for owner in mandate_owners %}
                            <option value="{{ owner.id }}" {% if project.mandate_owner_id == owner.id %}selected{% endif %}>
                                {% if owner.get_full_name %}{{ owner.get_full_name }} ({{ owner.username }}){% else %}{{ owner.username }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div>
                        <label class="block text-sm font-medium mb-2">Site Head</label>
                        <select name="site_head"
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="">None</option>
                            {% for head in site_heads %}
                            <option value="{{ head.id }}" {% if project.site_head_id == head.id %}selected{% endif %}>{{ head.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Submit -->
            <div id="submit-section" class="{% if configurations %}flex{% else %}hidden{% endif %} justify-end space-x-4">
                <a href="{% url 'projects:detail' project.pk %}" 
                   class="px-6 py-2 border border-gray-300 rounded-custom hover:bg-gray-50 transition">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-olive-primary text-white rounded-custom hover:bg-olive-secondary transition">
                    Save Project
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let configCounter = {{ configurations|length }};
    let areaCounters = {};
    let floorCounters = {};
    
    // Initialize counters for existing configurations
    {% for config in configurations %}
    areaCounters[{{ forloop.counter0 }}] = {{ config.area_types.all|length }};
    floorCounters[{{ forloop.counter0 }}] = {{ config.floor_mappings.all|length }};
    {% endfor %}
    
    function toggleCommercialFields() {
        const checkbox = document.getElementById('has_commercial');
        const fields = document.getElementById('commercial_fields');
        if (checkbox.checked) {
            fields.classList.remove('hidden');
        } else {
            fields.classList.add('hidden');
        }
    }
    
    function addConfiguration() {
        const container = document.getElementById('configurations-container');
        const configId = configCounter++;
        areaCounters[configId] = 0;
        floorCounters[configId] = 0;
        
        const configHtml = `
            <div class="config-card border-2 border-gray-300 rounded-lg p-4 bg-gray-50" data-config-id="${configId}">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Configuration ${configId + 1}</h3>
                    <button type="button" onclick="removeConfiguration(${configId})" 
                            class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
                        Remove
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Configuration Name * (e.g., 1BHK, 2BHK)</label>
                        <input type="text" name="config_name_${configId}" required
                               placeholder="e.g., 1BHK"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input type="text" name="config_description_${configId}"
                               placeholder="Optional description"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Price per Sqft (₹)</label>
                        <input type="number" name="config_price_per_sqft_${configId}" step="0.01"
                               placeholder="e.g., 5000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Stamp Duty (%)</label>
                        <input type="number" name="config_stamp_duty_${configId}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">GST (%)</label>
                        <input type="number" name="config_gst_${configId}" value="5.00" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Registration Charges (₹)</label>
                        <input type="number" name="config_registration_${configId}" value="30000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Legal Charges (₹)</label>
                        <input type="number" name="config_legal_${configId}" value="15000" step="0.01"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Development Charges (₹)</label>
                        <input type="number" name="config_development_${configId}" value="0" step="0.01"
                               placeholder="e.g., 50000"
                               class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Area Types -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold">Area Types (Carpet, Buildup, RERA)</label>
                        <button type="button" onclick="addAreaType(${configId})" 
                                class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">
                            + Add Area Type
                        </button>
                    </div>
                    <div id="area-types-${configId}" class="space-y-2">
                        <!-- Area types will be added here -->
                    </div>
                </div>
                
                <!-- Floor Mappings -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-sm font-semibold">Floor Mappings (Which floors have this configuration)</label>
                        <button type="button" onclick="addFloorMapping(${configId})" 
                                class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs">
                            + Add Floor
                        </button>
                    </div>
                    <div id="floor-mappings-${configId}" class="space-y-2">
                        <!-- Floor mappings will be added here -->
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', configHtml);
    }
    
    function removeConfiguration(configId) {
        const card = document.querySelector(`[data-config-id="${configId}"]`);
        if (card) {
            card.remove();
        }
        delete areaCounters[configId];
        delete floorCounters[configId];
        // Update dropdowns after removing configuration
        populateAreaTypeOptions();
    }
    
    function addAreaType(configId) {
        const container = document.getElementById(`area-types-${configId}`);
        const areaId = areaCounters[configId]++;
        
        const areaHtml = `
            <div class="flex gap-2 items-end bg-white p-2 rounded border">
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Carpet Area (sqft) *</label>
                    <input type="number" name="config_${configId}_area_carpet_${areaId}" step="0.01" required
                           placeholder="e.g., 500"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Buildup Area (sqft) *</label>
                    <input type="number" name="config_${configId}_area_buildup_${areaId}" step="0.01" required
                           placeholder="e.g., 650"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">RERA Area (sqft)</label>
                    <input type="number" name="config_${configId}_area_rera_${areaId}" step="0.01"
                           placeholder="e.g., 600"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <div class="flex-1">
                    <label class="block text-xs font-medium mb-1">Description</label>
                    <input type="text" name="config_${configId}_area_desc_${areaId}"
                           placeholder="e.g., Compact"
                           class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                <button type="button" onclick="this.parentElement.remove(); populateAreaTypeOptions();"
                        class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">
                    ×
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', areaHtml);
        // Update dropdowns when new area type is added
        populateAreaTypeOptions();
        
        // Add event listeners to the new inputs to update dropdowns when values change
        const newCarpetInput = container.querySelector(`input[name="config_${configId}_area_carpet_${areaId}"]`);
        const newBuildupInput = container.querySelector(`input[name="config_${configId}_area_buildup_${areaId}"]`);
        
        if (newCarpetInput) {
            newCarpetInput.addEventListener('input', function() {
                clearTimeout(newCarpetInput.updateTimeout);
                newCarpetInput.updateTimeout = setTimeout(() => {
                    populateAreaTypeOptions();
                }, 300);
            });
        }
        if (newBuildupInput) {
            newBuildupInput.addEventListener('input', function() {
                clearTimeout(newBuildupInput.updateTimeout);
                newBuildupInput.updateTimeout = setTimeout(() => {
                    populateAreaTypeOptions();
                }, 300);
            });
        }
    }
    
    function updateFloorMappings(configId) {
        const container = document.getElementById(`floor-mappings-${configId}`);
        const floorsPerTower = parseInt(document.querySelector('[name="floors_per_tower"]').value) || {{ floors_per_tower }};
        const existingData = (window.floorMappingData && window.floorMappingData[configId]) || {};
        
        let floorHtml = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">';
        for (let floorNum = 1; floorNum <= floorsPerTower; floorNum++) {
            const floorData = existingData[floorNum] || {};
            const defaultUnitStart = floorNum * 100 + 1;
            const isChecked = floorData.units_per_floor ? 'checked' : '';
            const isVisible = floorData.units_per_floor ? '' : 'hidden';
            
            floorHtml += `
                <div class="border rounded p-3 bg-gray-50 floor-mapping-item" data-floor="${floorNum}">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" 
                               name="config_${configId}_floor_${floorNum}" 
                               id="config_${configId}_floor_${floorNum}"
                               ${isChecked}
                               onchange="toggleFloorDetails(${configId}, ${floorNum})"
                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="config_${configId}_floor_${floorNum}" class="ml-2 text-sm font-medium">
                            Floor ${floorNum}
                        </label>
                    </div>
                    <div id="config_${configId}_floor_${floorNum}_details" class="${isVisible} space-y-2 mt-2">
                        <div>
                            <label class="block text-xs font-medium mb-1">Units per Floor *</label>
                            <input type="number" 
                                   name="config_${configId}_floor_units_${floorNum}" 
                                   value="${floorData.units_per_floor || 1}" min="1" 
                                   onchange="updateUnitStart(${configId}, ${floorNum})"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1">Starting Unit Number *</label>
                            <input type="number" 
                                   name="config_${configId}_floor_unit_start_${floorNum}" 
                                   value="${floorData.unit_number_start || defaultUnitStart}" 
                                   min="1"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                                   placeholder="e.g., ${defaultUnitStart}">
                            <p class="text-xs text-gray-500 mt-1">e.g., ${defaultUnitStart} means units ${defaultUnitStart}, ${defaultUnitStart + 1}, etc.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        floorHtml += '</div>';
        container.innerHTML = floorHtml;
    }
    
    function toggleFloorDetails(configId, floorNum) {
        const checkbox = document.getElementById(`config_${configId}_floor_${floorNum}`);
        const details = document.getElementById(`config_${configId}_floor_${floorNum}_details`);
        if (checkbox.checked) {
            details.classList.remove('hidden');
        } else {
            details.classList.add('hidden');
        }
    }
    
    function updateUnitStart(configId, floorNum) {
        const unitsInput = document.querySelector(`[name="config_${configId}_floor_units_${floorNum}"]`);
        const unitStartInput = document.querySelector(`[name="config_${configId}_floor_unit_start_${floorNum}"]`);
        if (unitsInput && unitStartInput && !unitStartInput.value) {
            const defaultStart = floorNum * 100 + 1;
            unitStartInput.value = defaultStart;
        }
    }
    
    function saveConfigurations() {
        console.log('saveConfigurations called');
        
        // Validate that at least one configuration exists
        const configCards = document.querySelectorAll('[data-config-id]');
        console.log('Found config cards:', configCards.length);
        
        if (configCards.length === 0) {
            alert('Please add at least one configuration before proceeding.');
            return false;
        }
        
        // Validate configurations have required fields
        let hasValidConfig = false;
        let validationErrors = [];
        
        configCards.forEach(card => {
            const configId = card.dataset.configId;
            const configName = card.querySelector(`[name="config_name_${configId}"]`)?.value?.trim();
            
            if (!configName) {
                validationErrors.push(`Configuration ${parseInt(configId) + 1} is missing a name.`);
                return;
            }
            
            const areaContainer = card.querySelector(`#area-types-${configId}`);
            if (!areaContainer) {
                validationErrors.push(`Configuration "${configName}" has no area types section.`);
                return;
            }
            
            // Get all carpet area inputs
            const carpetInputs = areaContainer.querySelectorAll(`input[name^="config_${configId}_area_carpet_"]`);
            
            if (carpetInputs.length === 0) {
                validationErrors.push(`Configuration "${configName}" has no area types. Please add at least one area type.`);
                return;
            }
            
            // Check if at least one area type has both carpet and buildup
            let hasValidAreaType = false;
            for (let input of carpetInputs) {
                // Extract area ID from name: config_X_area_carpet_Y
                const nameMatch = input.name.match(/config_\d+_area_carpet_(\d+)/);
                if (nameMatch) {
                    const areaId = nameMatch[1];
                    const carpetArea = input.value.trim();
                    const buildupInput = areaContainer.querySelector(`input[name="config_${configId}_area_buildup_${areaId}"]`);
                    const buildupArea = buildupInput?.value.trim() || '';
                    
                    if (carpetArea && buildupArea) {
                        hasValidAreaType = true;
                        hasValidConfig = true;
                        break;
                    }
                }
            }
            
            if (!hasValidAreaType) {
                validationErrors.push(`Configuration "${configName}" needs at least one area type with both carpet and buildup area filled.`);
            }
        });
        
        // Also check existing configurations from server
        {% for config in configurations %}
        {% if config.area_types.all %}
        hasValidConfig = true;
        {% endif %}
        {% endfor %}
        
        if (!hasValidConfig) {
            const errorMsg = validationErrors.length > 0 
                ? validationErrors.join('\n') 
                : 'Please add at least one configuration with area types (carpet and buildup area) before proceeding.';
            alert(errorMsg);
            return false;
        }
        
        console.log('Validation passed, showing floor mapping...');
        
        // First, populate area type options to ensure dropdowns are ready
        if (typeof populateAreaTypeOptions === 'function') {
            populateAreaTypeOptions();
        }
        
        // Hide configurations section, show floor mapping section
        const configSection = document.getElementById('configurations-section');
        const floorSection = document.getElementById('floor-mapping-section');
        const submitSection = document.getElementById('submit-section');
        
        if (configSection) {
            configSection.classList.add('hidden');
            console.log('Hidden configurations section');
        }
        if (floorSection) {
            floorSection.classList.remove('hidden');
            console.log('Shown floor mapping section');
        }
        if (submitSection) {
            submitSection.classList.remove('hidden');
            submitSection.classList.add('flex');
            console.log('Shown submit section');
        } else {
            console.error('submit-section element not found!');
        }
        
        // Generate floor mapping (this will also call populateAreaTypeOptions)
        if (typeof generateFloorMapping === 'function') {
            generateFloorMapping();
        }
        
        // Scroll to floor mapping section
        if (floorSection) {
            floorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        return true;
    }
    
    // Generate floor mapping UI with per-unit dropdowns (tower-based)
    function generateFloorMapping() {
        const container = document.getElementById('floor-mapping-container');
        const floorsPerTower = parseInt(document.querySelector('[name="floors_per_tower"]').value) || 0;
        const unitsPerFloor = parseInt(document.querySelector('[name="units_per_floor"]').value) || 0;
        const numberOfTowers = parseInt(document.querySelector('[name="number_of_towers"]').value) || 1;
        
        if (floorsPerTower === 0 || unitsPerFloor === 0) {
            container.innerHTML = '<p class="text-sm text-gray-500">Set "Floors per Tower" and "Units per Floor" above to enable floor mapping.</p>';
            document.getElementById('floor-mapping-section').classList.add('hidden');
            return;
        }
        
        document.getElementById('floor-mapping-section').classList.remove('hidden');
        
        // Get all area types from server (existing configurations)
        const areaTypes = [
            {% for area_type in all_area_types %}
            {
                id: {{ area_type.id }},
                name: '{{ area_type.get_display_name|escapejs }}',
                configName: '{{ area_type.configuration.name|escapejs }}',
                carpetArea: {{ area_type.carpet_area }}
            },
            {% endfor %}
        ];
        
        // Get existing unit configurations from server
        // Key format: "tower_floor_unit" -> config
        const unitConfigurationsData = {
            {% for key, unit_config in unit_configurations.items %}
            '{{ key }}': {
                area_type_id: {% if unit_config.area_type %}{{ unit_config.area_type.id }}{% else %}null{% endif %},
                is_excluded: {{ unit_config.is_excluded|yesno:"true,false" }}
            },
            {% endfor %}
        };
        
        let floorHtml = '';
        
        // Generate floor mapping for each tower
        for (let towerNum = 1; towerNum <= numberOfTowers; towerNum++) {
            floorHtml += `
                <div class="border-2 border-blue-300 rounded-lg p-4 bg-blue-50 mb-4">
                    <h2 class="text-xl font-semibold mb-4">Tower ${towerNum}</h2>
            `;
            
            for (let floorNum = 1; floorNum <= floorsPerTower; floorNum++) {
                // Check if floor is excluded (check any unit on this floor in this tower)
                let floorExcluded = false;
                for (let unitIdx = 1; unitIdx <= unitsPerFloor; unitIdx++) {
                    // Unit number format: Floor-Unit (e.g., Floor 1, Unit 1 = 101, Floor 2, Unit 1 = 201)
                    // Same unit numbers can exist in different towers
                    const unitNumber = floorNum * 100 + unitIdx;
                    // Get existing unit configuration from server data using key format: "tower_floor_unit"
                    const configKey = `${towerNum}_${floorNum}_${unitNumber}`;
                    const existingUnitConfig = unitConfigurationsData[configKey] || null;
                    if (existingUnitConfig && existingUnitConfig.is_excluded) {
                        floorExcluded = true;
                        break;
                    }
                }
                
                floorHtml += `
                    <div class="border-2 border-gray-300 rounded-lg p-4 bg-white mb-3">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold">Floor ${floorNum}</h3>
                            <label class="flex items-center">
                                <input type="checkbox" 
                                       name="tower_${towerNum}_floor_${floorNum}_excluded" 
                                       id="tower_${towerNum}_floor_${floorNum}_excluded"
                                       ${floorExcluded ? 'checked' : ''}
                                       onchange="toggleFloorExclusion(${towerNum}, ${floorNum})"
                                       class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                <span class="ml-2 text-sm text-red-600">Exclude Floor (Commercial)</span>
                            </label>
                        </div>
                        <div id="tower_${towerNum}_floor_${floorNum}_units" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                `;
                
                for (let unitIdx = 1; unitIdx <= unitsPerFloor; unitIdx++) {
                    // Unit number format: Floor-Unit (e.g., Floor 1, Unit 1 = 101, Floor 2, Unit 1 = 201)
                    // Same unit numbers can exist in different towers
                    const unitNumber = floorNum * 100 + unitIdx;
                    // Get existing unit configuration from server data (need to match by tower, floor, and unit)
                    // Since unit numbers can repeat across towers, we need to check tower_number too
                    let existingUnitConfig = null;
                    let existingAreaTypeId = null;
                    let isExcluded = false;
                    
                    // Find matching unit config using key format: "tower_floor_unit"
                    const configKey = `${towerNum}_${floorNum}_${unitNumber}`;
                    existingUnitConfig = unitConfigurationsData[configKey] || null;
                    if (existingUnitConfig) {
                        existingAreaTypeId = existingUnitConfig.area_type_id;
                        isExcluded = existingUnitConfig.is_excluded;
                    }
                    
                    floorHtml += `
                            <div class="border rounded p-3 bg-gray-50">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-sm font-medium">Unit ${unitNumber}</label>
                                    <label class="flex items-center">
                                        <input type="checkbox" 
                                               name="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_excluded" 
                                               id="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_excluded"
                                               ${isExcluded ? 'checked' : ''}
                                               onchange="toggleUnitExclusion(${towerNum}, ${floorNum}, ${unitIdx})"
                                               class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                        <span class="ml-1 text-xs text-red-600">Exclude</span>
                                    </label>
                                </div>
                                <select name="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_area_type" 
                                        id="tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_area_type"
                                        ${isExcluded ? 'disabled' : ''}
                                        class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">Select Configuration</option>
                                    ${areaTypes.map(at => `<option value="${at.id}" ${existingAreaTypeId === at.id ? 'selected' : ''}>${at.name}</option>`).join('')}
                                </select>
                            </div>
                    `;
                }
                
                floorHtml += `
                        </div>
                    </div>
                `;
            }
            
            floorHtml += `
                </div>
            `;
        }
        
        container.innerHTML = floorHtml;
    }
    
    function toggleFloorExclusion(towerNum, floorNum) {
        const checkbox = document.getElementById(`tower_${towerNum}_floor_${floorNum}_excluded`);
        const unitsContainer = document.getElementById(`tower_${towerNum}_floor_${floorNum}_units`);
        const units = unitsContainer.querySelectorAll('select, input[type="checkbox"]:not([id*="_excluded"])');
        
        if (checkbox.checked) {
            units.forEach(el => {
                el.disabled = true;
                el.closest('.border').classList.add('opacity-50');
            });
        } else {
            units.forEach(el => {
                el.disabled = false;
                el.closest('.border').classList.remove('opacity-50');
            });
        }
    }
    
    function toggleUnitExclusion(towerNum, floorNum, unitIdx) {
        const checkbox = document.getElementById(`tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_excluded`);
        const select = document.getElementById(`tower_${towerNum}_floor_${floorNum}_unit_${unitIdx}_area_type`);
        
        if (checkbox.checked) {
            select.disabled = true;
            select.value = '';
            select.closest('.border').classList.add('opacity-50');
        } else {
            select.disabled = false;
            select.closest('.border').classList.remove('opacity-50');
        }
    }
    
    function populateAreaTypeOptions() {
        // Collect all area types from configurations in the form
        const selects = document.querySelectorAll('[id$="_area_type"]');
        const areaTypes = [];
        
        // First, add existing area types from server
        const serverAreaTypes = [
            {% for area_type in all_area_types %}
            {
                id: {{ area_type.id }},
                name: '{{ area_type.get_display_name|escapejs }}',
                configName: '{{ area_type.configuration.name|escapejs }}',
                carpetArea: {{ area_type.carpet_area }}
            },
            {% endfor %}
        ];
        serverAreaTypes.forEach(at => {
            areaTypes.push({value: at.id, text: at.name, isServer: true});
        });
        
        // Find all configuration cards
        const configCards = document.querySelectorAll('[data-config-id]');
        configCards.forEach(card => {
            const configId = card.dataset.configId;
            const configName = card.querySelector(`[name="config_name_${configId}"]`)?.value || '';
            
            if (!configName) return; // Skip if config name is empty
            
            // Find all area types for this configuration
            const areaContainer = card.querySelector(`#area-types-${configId}`);
            if (areaContainer) {
                // Get all carpet area inputs by name pattern
                const carpetInputs = areaContainer.querySelectorAll(`input[name^="config_${configId}_area_carpet_"]`);
                
                carpetInputs.forEach(input => {
                    // Extract area ID from name: config_X_area_carpet_Y
                    const nameMatch = input.name.match(/config_\d+_area_carpet_(\d+)/);
                    if (nameMatch) {
                        const areaId = nameMatch[1];
                        const carpetArea = input.value.trim();
                        
                        // Find corresponding buildup input
                        const buildupInput = areaContainer.querySelector(`input[name="config_${configId}_area_buildup_${areaId}"]`);
                        const buildupArea = buildupInput?.value.trim() || '';
                        
                        // Only add if both carpet and buildup are provided
                        if (carpetArea && buildupArea) {
                            // Create a unique identifier for this area type
                            const optionValue = `config_${configId}_area_${areaId}`;
                            const displayName = `${configName}-${parseInt(carpetArea) || carpetArea}sqft`;
                            areaTypes.push({value: optionValue, text: displayName, configId, areaId, carpetArea, isServer: false});
                        }
                    }
                });
            }
        });
        
        // Populate all selects with collected area types
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Configuration</option>';
            areaTypes.forEach(areaType => {
                const option = document.createElement('option');
                option.value = areaType.value;
                option.textContent = areaType.text;
                if (currentValue === areaType.value || (currentValue && currentValue == areaType.value)) option.selected = true;
                select.appendChild(option);
            });
        });
        
        console.log(`Populated ${areaTypes.length} area types in ${selects.length} dropdowns`);
    }
    
    // Update area type options when configurations or area types change
    document.addEventListener('input', function(e) {
        if (e.target.matches('[name^="config_"][name$="_area_carpet_"]') || 
            e.target.matches('[name^="config_"][name$="_area_buildup_"]') ||
            e.target.matches('[name^="config_name_"]')) {
            populateAreaTypeOptions();
        }
    });
    
    // Update floor mapping when floors_per_tower, units_per_floor, or number_of_towers changes
    document.addEventListener('DOMContentLoaded', function() {
        const floorsInput = document.querySelector('[name="floors_per_tower"]');
        const unitsInput = document.querySelector('[name="units_per_floor"]');
        const towersInput = document.querySelector('[name="number_of_towers"]');
        
        if (floorsInput) {
            floorsInput.addEventListener('change', function() {
                if (!document.getElementById('floor-mapping-section').classList.contains('hidden')) {
                    generateFloorMapping();
                }
            });
        }
        if (unitsInput) {
            unitsInput.addEventListener('change', function() {
                if (!document.getElementById('floor-mapping-section').classList.contains('hidden')) {
                    generateFloorMapping();
                }
            });
        }
        if (towersInput) {
            towersInput.addEventListener('change', function() {
                if (!document.getElementById('floor-mapping-section').classList.contains('hidden')) {
                    generateFloorMapping();
                }
            });
        }
        
        // Add event listeners to all existing area type inputs to update dropdowns
        document.querySelectorAll('input[name$="_area_carpet_"], input[name$="_area_buildup_"]').forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(input.updateTimeout);
                input.updateTimeout = setTimeout(() => {
                    populateAreaTypeOptions();
                }, 300);
            });
        });
        
        // Also update when configuration names change
        document.querySelectorAll('input[name^="config_name_"]').forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(input.updateTimeout);
                input.updateTimeout = setTimeout(() => {
                    populateAreaTypeOptions();
                }, 300);
            });
        });
        
        // Initialize populateAreaTypeOptions on page load
        if (typeof populateAreaTypeOptions === 'function') {
            populateAreaTypeOptions();
        }
        
        // If configurations exist, show floor mapping and submit sections
        {% if configurations %}
        const floorSection = document.getElementById('floor-mapping-section');
        const submitSection = document.getElementById('submit-section');
        if (floorSection && submitSection) {
            floorSection.classList.remove('hidden');
            floorSection.classList.add('block');
            submitSection.classList.remove('hidden');
            submitSection.classList.add('flex');
            // Generate floor mapping if not already generated
            if (typeof generateFloorMapping === 'function') {
                generateFloorMapping();
            }
        }
        {% endif %}
    });
</script>
{% endblock %}

