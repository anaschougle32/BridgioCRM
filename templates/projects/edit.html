{% extends 'base.html' %}

{% block title %}Edit Project - Bridgio CRM{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-heading font-bold text-olive-primary">Edit Project: {{ project.name }}</h1>
        <a href="{% url 'projects:detail' project.pk %}" class="text-olive-primary hover:text-olive-secondary">‚Üê Back to Project</a>
    </div>
    
    <div class="bg-white rounded-custom shadow-md p-6">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Basic Information -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Image</label>
                        {% if project.image %}
                        <div class="mb-2">
                            <img src="{{ project.image.url }}" alt="{{ project.name }}" class="w-32 h-32 object-cover rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Current image</p>
                        </div>
                        {% endif %}
                        <input type="file" name="image" accept="image/*"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <p class="text-xs text-gray-500 mt-1">Upload a new image to replace the current one</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Name *</label>
                        <input type="text" name="name" value="{{ project.name }}" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Builder Name *</label>
                        <input type="text" name="builder_name" value="{{ project.builder_name }}" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Location *</label>
                        <textarea name="location" rows="2" required
                                  class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">{{ project.location }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">RERA ID</label>
                        <input type="text" name="rera_id" value="{{ project.rera_id|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Project Type *</label>
                        <select name="project_type" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            {% for value, label in project_type_choices %}
                            <option value="{{ value }}" {% if project.project_type == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Starting Price</label>
                        <div class="flex gap-2">
                            {% if project.starting_price %}
                                {% if project.starting_price_unit == 'crores' %}
                                    {% widthratio project.starting_price 10000000 1 as starting_price_display %}
                                {% else %}
                                    {% widthratio project.starting_price 100000 1 as starting_price_display %}
                                {% endif %}
                            {% endif %}
                            <input type="number" name="starting_price" 
                                   value="{% if project.starting_price %}{{ starting_price_display }}{% endif %}" 
                                   step="0.01" placeholder="e.g., 58"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <select name="starting_price_unit"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                                <option value="lakhs" {% if not project.starting_price_unit or project.starting_price_unit == 'lakhs' %}selected{% endif %}>Lakhs</option>
                                <option value="crores" {% if project.starting_price_unit == 'crores' %}selected{% endif %}>Crores</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Ending Price</label>
                        <div class="flex gap-2">
                            {% if project.ending_price %}
                                {% if project.ending_price_unit == 'crores' %}
                                    {% widthratio project.ending_price 10000000 1 as ending_price_display %}
                                {% else %}
                                    {% widthratio project.ending_price 100000 1 as ending_price_display %}
                                {% endif %}
                            {% endif %}
                            <input type="number" name="ending_price" 
                                   value="{% if project.ending_price %}{{ ending_price_display }}{% endif %}" 
                                   step="0.01" placeholder="e.g., 85"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <select name="ending_price_unit"
                                    class="w-32 px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                                <option value="lakhs" {% if not project.ending_price_unit or project.ending_price_unit == 'lakhs' %}selected{% endif %}>Lakhs</option>
                                <option value="crores" {% if project.ending_price_unit == 'crores' %}selected{% endif %}>Crores</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-2">Inventory Summary</label>
                        <textarea name="inventory_summary" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">{{ project.inventory_summary }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Tower and Unit Structure -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Tower and Unit Structure</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Number of Towers *</label>
                        <input type="number" name="number_of_towers" value="{{ project.number_of_towers }}" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Floors per Tower *</label>
                        <input type="number" name="floors_per_tower" value="{{ project.floors_per_tower }}" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Units per Floor (Residential) *</label>
                        <input type="number" name="units_per_floor" value="{{ project.units_per_floor }}" min="1" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="has_commercial" id="has_commercial" {% if project.has_commercial %}checked{% endif %}
                               class="w-4 h-4 text-olive-primary border-gray-300 rounded focus:ring-olive-primary"
                               onchange="toggleCommercialFields()">
                        <label for="has_commercial" class="ml-2 text-sm font-medium">Has Commercial Units</label>
                    </div>
                    <div id="commercial_fields" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 {% if not project.has_commercial %}hidden{% endif %}">
                        <div>
                            <label class="block text-sm font-medium mb-2">Commercial Floors</label>
                            <input type="number" name="commercial_floors" value="{{ project.commercial_floors }}" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Commercial Units per Floor</label>
                            <input type="number" name="commercial_units_per_floor" value="{{ project.commercial_units_per_floor }}" min="0"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Location Coordinates -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Location Coordinates</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Latitude</label>
                        <input type="number" name="latitude" value="{{ project.latitude|default:'' }}" step="0.000001"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Longitude</label>
                        <input type="number" name="longitude" value="{{ project.longitude|default:'' }}" step="0.000001"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                </div>
            </div>
            
            <!-- Settings -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Project Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Default Commission %</label>
                        <input type="number" name="default_commission_percent" value="{{ project.default_commission_percent }}" step="0.01"
                               class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Auto Assignment Strategy</label>
                        <select name="auto_assignment_strategy"
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="manual" {% if project.auto_assignment_strategy == 'manual' %}selected{% endif %}>Manual</option>
                            <option value="round_robin" {% if project.auto_assignment_strategy == 'round_robin' %}selected{% endif %}>Round Robin</option>
                        </select>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="is_active" id="is_active" {% if project.is_active %}checked{% endif %}
                               class="w-4 h-4 text-olive-primary border-gray-300 rounded focus:ring-olive-primary">
                        <label for="is_active" class="ml-2 text-sm font-medium">Active</label>
                    </div>
                </div>
            </div>
            
            <!-- Assignment -->
            <div>
                <h2 class="text-xl font-heading font-bold mb-4">Assignment</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% if mandate_owners %}
                    <div>
                        <label class="block text-sm font-medium mb-2">Mandate Owner *</label>
                        <select name="mandate_owner" required
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            {% for owner in mandate_owners %}
                            <option value="{{ owner.id }}" {% if project.mandate_owner_id == owner.id %}selected{% endif %}>
                                {% if owner.get_full_name %}{{ owner.get_full_name }} ({{ owner.username }}){% else %}{{ owner.username }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div>
                        <label class="block text-sm font-medium mb-2">Site Head</label>
                        <select name="site_head"
                                class="w-full px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                            <option value="">None</option>
                            {% for head in site_heads %}
                            <option value="{{ head.id }}" {% if project.site_head_id == head.id %}selected{% endif %}>{{ head.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Submit -->
            <div class="flex justify-end space-x-4">
                <a href="{% url 'projects:detail' project.pk %}" 
                   class="px-6 py-2 border border-gray-300 rounded-custom hover:bg-gray-50 transition">
                    Cancel
                </a>
                <button type="submit" 
                        class="px-6 py-2 bg-olive-primary text-white rounded-custom hover:bg-olive-secondary transition">
                    Update Project
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleCommercialFields() {
        const checkbox = document.getElementById('has_commercial');
        const fields = document.getElementById('commercial_fields');
        if (checkbox.checked) {
            fields.classList.remove('hidden');
        } else {
            fields.classList.add('hidden');
        }
    }
</script>
{% endblock %}

