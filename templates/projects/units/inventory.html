{% extends 'base.html' %}

{% block title %}Unit Inventory - {{ project.name }} - Bridgio CRM{% endblock %}

{% block page_title %}Unit Inventory{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl sm:text-3xl font-heading font-bold text-olive-primary">Unit Inventory</h1>
            <p class="text-gray-600 mt-1">{{ project.name }}</p>
        </div>
        <a href="{% url 'projects:detail' project.id %}" 
           class="text-olive-primary hover:text-olive-secondary">
            ← Back to Project
        </a>
    </div>
    
    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div class="bg-white rounded-lg shadow-md p-4">
            <div class="text-center">
                <p class="text-2xl font-bold text-gray-800">{{ stats.total_units }}</p>
                <p class="text-sm text-gray-600">Total Units</p>
            </div>
        </div>
        
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="text-center">
                <p class="text-2xl font-bold text-green-800">{{ stats.available }}</p>
                <p class="text-sm text-green-600">Available</p>
            </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="text-center">
                <p class="text-2xl font-bold text-blue-800">{{ stats.booked }}</p>
                <p class="text-sm text-blue-600">Booked</p>
            </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="text-center">
                <p class="text-2xl font-bold text-yellow-800">{{ stats.blocked }}</p>
                <p class="text-sm text-yellow-600">Blocked</p>
            </div>
        </div>
        
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <div class="text-center">
                <p class="text-2xl font-bold text-purple-800">{{ stats.reserved }}</p>
                <p class="text-sm text-purple-600">Reserved</p>
            </div>
        </div>
        
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <div class="text-center">
                <p class="text-2xl font-bold text-gray-800">{{ stats.excluded }}</p>
                <p class="text-sm text-gray-600">Excluded</p>
            </div>
        </div>
    </div>
    
    <!-- Filters and Actions -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Filters -->
            <form method="get" class="flex-1">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <select name="status" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    
                    <select name="tower" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Towers</option>
                        {% for tower in towers %}
                        <option value="{{ tower }}" {% if filters.tower == tower|stringformat:"s" %}selected{% endif %}>Tower {{ tower }}</option>
                        {% endfor %}
                    </select>
                    
                    <select name="floor" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Floors</option>
                        {% for floor in floors %}
                        <option value="{{ floor }}" {% if filters.floor == floor|stringformat:"s" %}selected{% endif %}>Floor {{ floor }}</option>
                        {% endfor %}
                    </select>
                    
                    <input type="text" name="search" placeholder="Search unit..." 
                           value="{{ filters.search }}"
                           class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
                
                <div class="mt-4 flex gap-2">
                    <button type="submit" class="bg-olive-primary text-white px-4 py-2 rounded-lg hover:bg-olive-secondary transition font-medium">
                        Filter
                    </button>
                    <a href="{% url 'projects:unit_inventory' project.id %}" 
                       class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition font-medium">
                        Clear
                    </a>
                </div>
            </form>
            
            <!-- Bulk Actions -->
            {% if user.is_site_head or user.is_super_admin or user.is_mandate_owner %}
            <div class="border-l pl-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="select-all" class="w-4 h-4 text-olive-primary">
                    <label for="select-all" class="text-sm font-medium">Select All</label>
                </div>
                
                <div class="mt-2 space-y-2">
                    <select id="bulk-action" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="">Bulk Actions</option>
                        <option value="block">Block Units</option>
                        <option value="unblock">Unblock Units</option>
                        <option value="update_status">Update Status</option>
                    </select>
                    
                    <button id="bulk-action-btn" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-medium disabled:opacity-50" disabled>
                        Apply
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Units Table -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        {% if user.is_site_head or user.is_super_admin or user.is_mandate_owner %}
                        <th class="px-4 py-3 text-left">
                            <input type="checkbox" class="unit-checkbox w-4 h-4 text-olive-primary">
                        </th>
                        {% endif %}
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Area</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Blocked By</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for unit in units %}
                    <tr class="hover:bg-gray-50">
                        {% if user.is_site_head or user.is_super_admin or user.is_mandate_owner %}
                        <td class="px-4 py-3">
                            <input type="checkbox" class="unit-checkbox w-4 h-4 text-olive-primary" 
                                   value="{{ unit.id }}" 
                                   data-unit-id="{{ unit.id }}">
                        </td>
                        {% endif %}
                        <td class="px-4 py-3 text-sm">
                            <div>
                                <p class="font-medium text-gray-900">{{ unit.full_unit_number }}</p>
                                {% if unit.is_excluded %}
                                <span class="text-xs text-gray-500">Excluded</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {% if unit.area_type %}
                                {{ unit.area_type.configuration.name }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {% if unit.area_type %}
                                {{ unit.area_type.carpet_area }} sqft
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {% if unit.area_type and unit.area_type.base_price %}
                                ₹{{ unit.area_type.base_price|floatformat:0 }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-1 text-xs rounded-full
                                {% if unit.status == 'available' %}bg-green-100 text-green-800
                                {% elif unit.status == 'booked' %}bg-blue-100 text-blue-800
                                {% elif unit.status == 'blocked' %}bg-yellow-100 text-yellow-800
                                {% elif unit.status == 'reserved' %}bg-purple-100 text-purple-800
                                {% elif unit.status == 'maintenance' %}bg-red-100 text-red-800
                                {% elif unit.status == 'sold' %}bg-gray-100 text-gray-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ unit.get_status_display }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {% if unit.booking %}
                                <a href="{% url 'bookings:detail' unit.booking.id %}" 
                                   class="text-olive-primary hover:text-olive-secondary">
                                    #{{ unit.booking.id }}
                                </a>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">
                            {% if unit.blocked_by %}
                                {{ unit.blocked_by.username }}
                                {% if unit.blocked_until %}
                                <div class="text-xs text-gray-500">
                                    Until {{ unit.blocked_until|date:"d M H:i" }}
                                </div>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            <div class="flex gap-2">
                                {% if unit.is_available %}
                                <button onclick="blockUnit('{{ unit.id }}')" 
                                        class="text-yellow-600 hover:text-yellow-800 text-sm font-medium">
                                    Block
                                </button>
                                {% elif unit.status == 'blocked' %}
                                <button onclick="unblockUnit('{{ unit.id }}')" 
                                        class="text-green-600 hover:text-green-800 text-sm font-medium">
                                    Unblock
                                </button>
                                {% endif %}
                                
                                {% if user.is_site_head or user.is_super_admin or user.is_mandate_owner %}
                                <button onclick="updateUnitStatus('{{ unit.id }}')" 
                                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    Edit
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{% if user.is_site_head or user.is_super_admin or user.is_mandate_owner %}9{% else %}8{% endif %}" 
                            class="px-4 py-8 text-center text-gray-500">
                            No units found matching your criteria.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if units.has_other_pages %}
        <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
            <div class="flex items-center justify-between">
                <div class="flex-1 flex justify-between sm:hidden">
                    {% if units.has_previous %}
                    <a href="?page={{ units.previous_page_number }}" 
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </a>
                    {% endif %}
                    {% if units.has_next %}
                    <a href="?page={{ units.next_page_number }}" 
                       class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </a>
                    {% endif %}
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing
                            <span class="font-medium">{{ units.start_index }}</span>
                            to
                            <span class="font-medium">{{ units.end_index }}</span>
                            of
                            <span class="font-medium">{{ units.paginator.count }}</span>
                            results
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            {% if units.has_previous %}
                            <a href="?page={{ units.previous_page_number }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Previous
                            </a>
                            {% endif %}
                            
                            {% for num in units.paginator.page_range %}
                            {% if units.number == num %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-olive-primary bg-olive-primary text-sm font-medium text-white">
                                {{ num }}
                            </span>
                            {% elif num > units.number|add:'-3' and num < units.number|add:'3' %}
                            <a href="?page={{ num }}" 
                               class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                {{ num }}
                            </a>
                            {% endif %}
                            {% endfor %}
                            
                            {% if units.has_next %}
                            <a href="?page={{ units.next_page_number }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Next
                            </a>
                            {% endif %}
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Block Unit Modal -->
<div id="blockModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Block Unit</h3>
            <form method="post" action="{% url 'projects:block_unit' project.id %}">
                {% csrf_token %}
                <input type="hidden" name="unit_id" id="block-unit-id">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Block Duration (hours)</label>
                    <select name="hours" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="1">1 hour</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="72">3 days</option>
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
                    <textarea name="notes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"
                              placeholder="Add notes about this block..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition font-medium">
                        Block Unit
                    </button>
                    <button type="button" onclick="closeModal('blockModal')" 
                            class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Update Unit Status</h3>
            <form method="post" action="{% url 'projects:update_unit_status' project.id %}">
                {% csrf_token %}
                <input type="hidden" name="unit_id" id="status-unit-id">
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        {% for value, label in status_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (optional)</label>
                    <textarea name="notes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"
                              placeholder="Add notes about this status change..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                        Update Status
                    </button>
                    <button type="button" onclick="closeModal('statusModal')" 
                            class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all');
    const unitCheckboxes = document.querySelectorAll('.unit-checkbox');
    const bulkActionBtn = document.getElementById('bulk-action-btn');
    const bulkActionSelect = document.getElementById('bulk-action');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            unitCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionButton();
        });
    }
    
    unitCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionButton);
    });
    
    function updateBulkActionButton() {
        const checkedBoxes = document.querySelectorAll('.unit-checkbox:checked');
        bulkActionBtn.disabled = checkedBoxes.length === 0 || bulkActionSelect.value === '';
    }
    
    if (bulkActionSelect) {
        bulkActionSelect.addEventListener('change', updateBulkActionButton);
    }
    
    if (bulkActionBtn) {
        bulkActionBtn.addEventListener('click', function() {
            const action = bulkActionSelect.value;
            const checkedBoxes = document.querySelectorAll('.unit-checkbox:checked');
            const unitIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (unitIds.length === 0) {
                alert('Please select at least one unit.');
                return;
            }
            
            if (action === 'block') {
                const hours = prompt('Block duration (hours):', '24');
                if (hours) {
                    performBulkAction('block', unitIds, {hours: hours});
                }
            } else if (action === 'unblock') {
                if (confirm('Are you sure you want to unblock the selected units?')) {
                    performBulkAction('unblock', unitIds);
                }
            } else if (action === 'update_status') {
                const status = prompt('Enter new status (available/booked/blocked/reserved/maintenance/sold):');
                if (status) {
                    performBulkAction('update_status', unitIds, {status: status});
                }
            }
        });
    }
});

function blockUnit(unitId) {
    document.getElementById('block-unit-id').value = unitId;
    document.getElementById('blockModal').classList.remove('hidden');
}

function unblockUnit(unitId) {
    if (confirm('Are you sure you want to unblock this unit?')) {
        const url = "{% url 'projects:unblock_unit' project.id 0 %}".replace('0', unitId);
        window.location.href = url;
    }
}

function updateUnitStatus(unitId) {
    document.getElementById('status-unit-id').value = unitId;
    document.getElementById('statusModal').classList.remove('hidden');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
}

function performBulkAction(action, unitIds, additionalData = {}) {
    const formData = new FormData();
    formData.append('action', action);
    unitIds.forEach(id => formData.append('unit_ids', id));
    
    Object.keys(additionalData).forEach(key => {
        formData.append(key, additionalData[key]);
    });
    
    fetch(`{% url 'projects:bulk_unit_actions' project.id %}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while performing the bulk action.');
    });
}
</script>
{% endblock %}
