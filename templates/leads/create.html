{% extends 'base.html' %}

{% block title %}New Visit - Bridgio CRM{% endblock %}

{% block page_title %}New Visit{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <div class="mb-4 sm:mb-6">
        <h1 class="text-2xl sm:text-3xl font-heading font-semibold text-text-primary mb-2">New Visit</h1>
        <p class="text-sm sm:text-base text-text-secondary">Create a new lead/visit. All user types can create new visits.</p>
    </div>
    
    <!-- Progress Steps -->
    <div class="mb-6 sm:mb-8 overflow-x-auto">
        <div class="flex items-center justify-between min-w-[500px] sm:min-w-0">
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-olive-primary text-white font-bold" id="step-1-indicator">1</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-olive-primary">Client Information</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-1-2-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-2-indicator">2</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">Requirements</p>
                </div>
            </div>
            <div class="flex-1 h-1 mx-4 bg-gray-200" id="step-2-3-line"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold" id="step-3-indicator">3</div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-gray-500">CP (Optional)</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
        <form id="new-visit-form" method="post" action="{% url 'leads:create' %}" class="space-y-8" onsubmit="event.preventDefault(); return false;">
            {% csrf_token %}
            <input type="hidden" name="step" id="form-step" value="1">
            
            <!-- Step 1: Client Information -->
            <div id="step-1" class="step-content">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Client Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Name *</label>
                        <input type="text" name="name" id="name" required
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Phone *</label>
                        <input type="tel" name="phone" id="phone" required
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Email</label>
                        <input type="email" name="email" id="email"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Age</label>
                        <input type="number" name="age" id="age" min="18" max="100"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Gender</label>
                        <select name="gender" id="gender"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select Gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Locality</label>
                        <input type="text" name="locality" id="locality"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Current Residence</label>
                        <select name="current_residence" id="current_residence"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select</option>
                            <option value="own">Own</option>
                            <option value="rent">Rent</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Occupation</label>
                        <select name="occupation" id="occupation"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select Occupation</option>
                            <option value="self_emp">Self Employed</option>
                            <option value="service">Service</option>
                            <option value="homemaker">Homemaker</option>
                            <option value="business">Business</option>
                            <option value="retired">Retired</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Company Name</label>
                        <input type="text" name="company_name" id="company_name"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Designation</label>
                        <input type="text" name="designation" id="designation"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-border-light">
                    <a href="{% url 'leads:list' %}" 
                       class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition font-medium text-text-primary">
                        Cancel
                    </a>
                    <button type="button" onclick="nextStep(1)" 
                            class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition font-semibold shadow-sm">
                        Next: Requirements
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Requirements -->
            <div id="step-2" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">Requirement Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Project *</label>
                        <select name="project" id="project" required
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select Project</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Budget (₹)</label>
                        <input type="number" name="budget" id="budget" step="0.01"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Purpose</label>
                        <select name="purpose" id="purpose"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select Purpose</option>
                            <option value="investment">Investment</option>
                            <option value="first_home">First Home</option>
                            <option value="second_home">Second Home</option>
                            <option value="retirement_home">Retirement Home</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">Visit Type</label>
                        <select name="visit_type" id="visit_type"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="">Select</option>
                            <option value="family">Family</option>
                            <option value="alone">Alone</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">First Visit or Revisit</label>
                        <select name="is_first_visit" id="is_first_visit"
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="true">First Visit</option>
                            <option value="false">Revisit</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-text-primary mb-2">How did you hear about us?</label>
                        <input type="text" name="how_did_you_hear" id="how_did_you_hear"
                               placeholder="e.g., Online, Hoarding, Referral, Walk-in, etc."
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                </div>
                <div class="flex justify-between space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(2)" 
                            class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition font-medium text-text-primary">
                        ← Previous
                    </button>
                    <button type="button" onclick="nextStep(2)" 
                            class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition font-semibold shadow-sm">
                        Next: CP Details
                    </button>
                </div>
            </div>
            
            <!-- Step 3: CP (Optional) -->
            <div id="step-3" class="step-content hidden">
                <h2 class="text-xl font-heading font-semibold text-text-primary mb-6 pb-2 border-b border-border-light">
                    Channel Partner Information <span class="text-text-secondary font-normal text-sm">(Optional)</span>
                </h2>
                <p class="text-sm text-text-secondary mb-4">CP details are optional for new visits. You can skip this step if not applicable.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-text-primary mb-2">Visit Source *</label>
                        <select name="visit_source" id="visit_source" required
                                class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                            <option value="walkin">Direct Walk-in</option>
                            <option value="call">Call Generated</option>
                            <option value="cp">Channel Partner</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">How was this visit generated?</p>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">CP Firm Name</label>
                        <input type="text" name="cp_firm_name" id="cp_firm_name"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">CP Name</label>
                        <input type="text" name="cp_name" id="cp_name"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">CP Phone</label>
                        <input type="tel" name="cp_phone" id="cp_phone"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-text-primary mb-2">CP RERA Number</label>
                        <input type="text" name="cp_rera_number" id="cp_rera_number"
                               class="w-full px-4 py-2.5 border border-border-light rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-olive-primary transition">
                    </div>
                </div>
                <div class="flex justify-between space-x-4 mt-6 pt-4 border-t border-border-light">
                    <button type="button" onclick="previousStep(3)" 
                            class="px-6 py-2.5 border border-border-light rounded-lg hover:bg-gray-50 transition font-medium text-text-primary">
                        ← Previous
                    </button>
                    <button type="button" onclick="submitFinalForm()" 
                            class="px-6 py-2.5 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition font-semibold shadow-sm">
                        Create New Visit
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    let currentStep = 1;
    
    function updateStepIndicators(step) {
        // Update step indicators (now 3 steps: 1=Client Info, 2=Requirements, 3=CP Details)
        for (let i = 1; i <= 3; i++) {
            const indicator = document.getElementById('step-' + i + '-indicator');
            const line = document.getElementById('step-' + (i-1) + '-' + i + '-line');
            
            if (i < step) {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-green-600 text-white font-bold';
                if (line) line.className = 'flex-1 h-1 mx-4 bg-green-600';
            } else if (i === step) {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-olive-primary text-white font-bold';
                if (line) line.className = 'flex-1 h-1 mx-4 bg-gray-200';
            } else {
                indicator.className = 'flex items-center justify-center w-10 h-10 rounded-full bg-gray-300 text-gray-600 font-bold';
                if (line) line.className = 'flex-1 h-1 mx-4 bg-gray-200';
            }
        }
    }
    
    function showStep(step) {
        // Hide all steps (now 3 steps)
        for (let i = 1; i <= 3; i++) {
            document.getElementById('step-' + i).classList.add('hidden');
        }
        // Show current step
        document.getElementById('step-' + step).classList.remove('hidden');
        updateStepIndicators(step);
        currentStep = step;
    }
    
    function nextStep(fromStep) {
        if (fromStep === 1) {
            // Validate step 1
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            if (!name || !phone) {
                alert('Name and Phone are required.');
                return;
            }
            // Save step 1 data
            submitStep(1);
        } else if (fromStep === 2) {
            // Validate step 2 (Requirements)
            const project = document.getElementById('project').value;
            if (!project) {
                alert('Project is required.');
                return;
            }
            // Save step 2 data
            submitStep(2);
        }
    }
    
    function previousStep(fromStep) {
        showStep(fromStep - 1);
    }
    
    function submitStep(step) {
        const form = document.getElementById('new-visit-form');
        const formData = new FormData(form);
        formData.set('step', step.toString());
        
        fetch('{% url "leads:create" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Request failed');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (step === 1) {
                    showStep(2);  // Go to Requirements (previously step 3)
                } else if (step === 2) {
                    showStep(3);  // Go to CP Details (previously step 4)
                }
            } else {
                alert(data.error || 'An error occurred. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'An error occurred. Please try again.');
        });
    }
    
    function submitFinalForm() {
        // Submit step 3 (final step) via fetch
        const form = document.getElementById('new-visit-form');
        const formData = new FormData(form);
        formData.set('step', '3');
        
        fetch('{% url "leads:create" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            // Check if response is ok
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || data.message || 'Request failed');
                }).catch(() => {
                    throw new Error('Request failed with status ' + response.status);
                });
            }
            // Parse JSON response
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.redirect_url) {
                    // Ensure redirect_url is a valid string
                    const redirectUrl = String(data.redirect_url);
                    if (redirectUrl && redirectUrl !== 'undefined' && redirectUrl !== 'null') {
                        window.location.href = redirectUrl;
                    } else {
                        console.error('Invalid redirect_url:', data.redirect_url);
                        window.location.href = '{% url "leads:list" %}';
                    }
                } else {
                    window.location.href = '{% url "leads:list" %}';
                }
            } else {
                alert(data.error || data.message || 'An error occurred. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
    
    // Form submission is now completely handled by JavaScript
    // No need for handleFormSubmit since we prevent default in form tag
    
    // Initialize (3 steps now: Client Info -> Requirements -> CP Details)
    updateStepIndicators(1);
</script>
{% endblock %}
