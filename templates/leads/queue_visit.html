{% extends 'base.html' %}
{% load lead_filters %}

{% block title %}Queue Visit - Bridgio CRM{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-heading font-bold text-olive-primary">Queue Visit (Receptionist)</h1>
            <p class="text-gray-600 mt-1">Verify client at door and queue for closing manager</p>
        </div>
        <a href="{% url 'dashboard' %}" class="text-olive-primary hover:text-olive-secondary">← Back to Dashboard</a>
    </div>
    
    <!-- Info Banner -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-sm text-blue-800">
            <strong>How it works:</strong> Search for the client by phone number, verify their identity with OTP, fill in all required details, and queue them for the closing manager. The closing manager will be notified immediately.
        </p>
    </div>
    
    <!-- Search Lead -->
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-6">
        <h2 class="text-xl font-heading font-bold mb-4">Search Client</h2>
        <div class="flex gap-4">
            <input type="text" 
                   id="search-phone" 
                   placeholder="Enter phone number..." 
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            <button onclick="searchLead()" 
                    class="bg-olive-primary text-white px-6 py-2 rounded-lg hover:bg-olive-secondary transition">
                Search
            </button>
            <button onclick="clearForm()" 
                    class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                New Client
            </button>
        </div>
        <div id="search-result" class="mt-4"></div>
    </div>
    
    <!-- Queue Visit Form -->
    <form method="post" class="bg-card-bg rounded-lg shadow-premium border border-border-light p-6">
        {% csrf_token %}
        
        <h2 class="text-xl font-heading font-bold mb-4">Client Details</h2>
        
        <!-- Basic Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Phone Number *</label>
                <input type="text" name="phone" id="phone" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Name *</label>
                <input type="text" name="name" id="name" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Email</label>
                <input type="email" name="email" id="email"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Project *</label>
                <select name="project" id="project" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select Project</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Additional Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Age</label>
                <input type="number" name="age" id="age" min="18" max="100"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Gender</label>
                <select name="gender" id="gender"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Locality</label>
                <input type="text" name="locality" id="locality"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Current Residence</label>
                <select name="current_residence" id="current_residence"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select</option>
                    <option value="own">Own</option>
                    <option value="rent">Rent</option>
                </select>
            </div>
        </div>
        
        <!-- Occupation Details -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Occupation</label>
                <select name="occupation" id="occupation"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select Occupation</option>
                    <option value="self_emp">Self Employed</option>
                    <option value="service">Service</option>
                    <option value="homemaker">Homemaker</option>
                    <option value="business">Business</option>
                    <option value="retired">Retired</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Company Name</label>
                <input type="text" name="company_name" id="company_name"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Designation</label>
                <input type="text" name="designation" id="designation"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
        </div>
        
        <!-- Requirement Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Purpose</label>
                <select name="purpose" id="purpose"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select Purpose</option>
                    <option value="investment">Investment</option>
                    <option value="first_home">First Home</option>
                    <option value="second_home">Second Home</option>
                    <option value="retirement_home">Retirement Home</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Configurations</label>
                <select name="configurations" id="configurations" multiple
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    {% for config in configurations %}
                    <option value="{{ config.id }}">{{ config.display_name }}</option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Budget Min (₹ Lakhs)</label>
                <input type="number" name="budget_min" id="budget_min" step="0.01"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Budget Max (₹ Lakhs)</label>
                <input type="number" name="budget_max" id="budget_max" step="0.01"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
        </div>
        
        <!-- Visit Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
                <label class="block text-sm font-medium mb-2">Visit Type</label>
                <select name="visit_type" id="visit_type"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select</option>
                    <option value="family">Family</option>
                    <option value="alone">Alone</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">Visit Source</label>
                <select name="visit_source" id="visit_source"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select</option>
                    <option value="call">Call Generated</option>
                    <option value="cp">Channel Partner</option>
                    <option value="walkin">Direct Walk-in</option>
                </select>
            </div>
        </div>
        
        <!-- Submit Button -->
        <div class="flex gap-4">
            <button type="submit" 
                    class="bg-olive-primary text-white px-8 py-3 rounded-lg hover:bg-olive-secondary transition font-medium">
                Queue Visit for Closing Manager
            </button>
            <button type="button" onclick="clearForm()" 
                    class="bg-gray-200 text-gray-700 px-8 py-3 rounded-lg hover:bg-gray-300 transition font-medium">
                Clear Form
            </button>
        </div>
    </form>
</div>

<script>
function searchLead() {
    const phone = document.getElementById('search-phone').value.trim();
    if (!phone) {
        alert('Please enter a phone number');
        return;
    }
    
    fetch(`/leads/search-leads/?phone=${encodeURIComponent(phone)}`)
        .then(response => response.json())
        .then(data => {
            const resultDiv = document.getElementById('search-result');
            if (data.leads && data.leads.length > 0) {
                const lead = data.leads[0];
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-800 font-medium">Client found! Details loaded below.</p>
                        <p class="text-sm text-green-600 mt-1">Name: ${lead.name} | Email: ${lead.email || 'N/A'}</p>
                    </div>
                `;
                
                // Fill form with lead data
                document.getElementById('phone').value = lead.phone;
                document.getElementById('name').value = lead.name;
                document.getElementById('email').value = lead.email || '';
                
                // Fill other fields if available
                if (lead.age) document.getElementById('age').value = lead.age;
                if (lead.gender) document.getElementById('gender').value = lead.gender;
                if (lead.locality) document.getElementById('locality').value = lead.locality;
                if (lead.current_residence) document.getElementById('current_residence').value = lead.current_residence;
                if (lead.occupation) document.getElementById('occupation').value = lead.occupation;
                if (lead.company_name) document.getElementById('company_name').value = lead.company_name;
                if (lead.designation) document.getElementById('designation').value = lead.designation;
                if (lead.purpose) document.getElementById('purpose').value = lead.purpose;
                if (lead.budget_min) document.getElementById('budget_min').value = lead.budget_min;
                if (lead.budget_max) document.getElementById('budget_max').value = lead.budget_max;
                if (lead.visit_type) document.getElementById('visit_type').value = lead.visit_type;
                if (lead.visit_source) document.getElementById('visit_source').value = lead.visit_source;
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800 font-medium">Client not found. Please fill in details for new client.</p>
                    </div>
                `;
                document.getElementById('phone').value = phone;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error searching for client');
        });
}

function clearForm() {
    document.querySelector('form').reset();
    document.getElementById('search-result').innerHTML = '';
    document.getElementById('search-phone').value = '';
}
</script>
{% endblock %}
