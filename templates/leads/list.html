{% extends 'base.html' %}
{% load tz %}
{% load lead_filters %}

{% block title %}Leads - Bridgio CRM{% endblock %}

{% block page_title %}Leads{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header and Filters -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
            <h1 class="text-2xl font-bold text-gray-900">Leads Management</h1>
            <div class="flex flex-wrap gap-3">
                {% if user.is_super_admin or user.is_mandate_owner or user.is_site_head %}
                <a href="{% url 'leads:download' %}?{{ request.GET.urlencode }}" 
                   class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Download
                </a>
                {% endif %}
                <a href="{% url 'leads:create' %}" 
                   class="inline-flex items-center px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition-colors">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Lead
                </a>
            </div>
        </div>

        <!-- Filter Form -->
        <form method="get" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" 
                           name="search" 
                           placeholder="Search by name, phone, project..." 
                           value="{{ search }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-transparent">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Project</label>
                    <select name="project" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-transparent">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if selected_project == project.id|stringformat:"s" %}selected{% endif %}>{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Budget</label>
                    <select name="budget" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary focus:border-transparent">
                        <option value="">All Budgets</option>
                        <option value="no_budget" {% if selected_budget == 'no_budget' %}selected{% endif %}>No Budget</option>
                        <option value="under_50l" {% if selected_budget == 'under_50l' %}selected{% endif %}>Under ₹50L</option>
                        <option value="50l_to_1cr" {% if selected_budget == '50l_to_1cr' %}selected{% endif %}>₹50L - ₹1Cr</option>
                        <option value="1cr_to_2cr" {% if selected_budget == '1cr_to_2cr' %}selected{% endif %}>₹1Cr - ₹2Cr</option>
                        <option value="over_2cr" {% if selected_budget == 'over_2cr' %}selected{% endif %}>Over ₹2Cr</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
                <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition-colors">
                    Filter
                </button>
                <a href="{% url 'leads:list' %}" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Clear
                </a>
            </div>
        </form>
    </div>

    <!-- Leads Table -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        {% if leads %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lead</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Call</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Budget</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for lead in leads %}
                    {% with notif=lead_notifications|get_item:lead.id %}
                    {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
                    <tr class="hover:bg-gray-50 transition-colors" id="lead-row-{{ lead.id }}">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-olive-primary flex items-center justify-center">
                                        <span class="text-white font-medium">{{ lead.name.0|upper }}</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ lead.name }}</div>
                                    <div class="text-sm text-gray-500">{{ lead.email|default:"No email" }}</div>
                                    {% if notif.overdue_count > 0 %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 mt-1">
                                        {{ notif.overdue_count }} overdue
                                    </span>
                                    {% endif %}
                                    {% if notif.today_callbacks > 0 %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 mt-1">
                                        {{ notif.today_callbacks }} callbacks today
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">{{ lead.phone|default:"No phone" }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <a href="{{ notif.tel_link }}" 
                               data-tel-link="{{ notif.tel_link }}"
                               data-lead-id="{{ lead.id }}"
                               onclick="trackCallClickAndDial(this); return false;"
                               class="inline-flex items-center px-3 py-1 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 transition-colors"
                               title="Call Now">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                                Call
                            </a>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">
                                {% if primary_assoc %}
                                    {{ primary_assoc.project.name }}
                                {% else %}
                                    <span class="text-gray-500">No project</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="relative">
                                <button type="button" 
                                        onclick="toggleStatusMenu({{ lead.id }})"
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium status-badge"
                                        data-current-status="{% if primary_assoc %}{{ primary_assoc.status }}{% else %}new{% endif %}">
                                    {% if primary_assoc %}
                                        {{ primary_assoc.get_status_display }}
                                    {% else %}
                                        New
                                    {% endif %}
                                    <svg class="ml-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                
                                <!-- Status Dropdown Menu -->
                                <div id="status-menu-{{ lead.id }}" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                    <div class="py-1">
                                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b">Update Status</div>
                                        {% for value, label in status_choices %}
                                        <form method="post" action="{% url 'leads:update_status' lead.pk %}" class="status-update-form" data-lead-id="{{ lead.id }}">
                                            {% csrf_token %}
                                            <input type="hidden" name="status" value="{{ value }}">
                                            {% if primary_assoc %}
                                                <input type="hidden" name="project_id" value="{{ primary_assoc.project_id }}">
                                            {% else %}
                                                <input type="hidden" name="project_id" value="">
                                            {% endif %}
                                            <button type="submit" 
                                                    class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 {% if primary_assoc and primary_assoc.status == value %}bg-blue-50 text-blue-800 font-medium{% endif %}">
                                                {{ label }}
                                            </button>
                                        </form>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="relative">
                                <button type="button" 
                                        onclick="toggleBudgetMenu({{ lead.id }})"
                                        class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                                               {% if lead.budget %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if lead.budget %}
                                        {% if lead.budget >= 10000000 %}
                                            {% widthratio lead.budget 10000000 1 as budget_cr %}
                                            ₹{{ budget_cr }} Cr
                                        {% else %}
                                            {% widthratio lead.budget 100000 1 as budget_l %}
                                            ₹{{ budget_l }} L
                                        {% endif %}
                                    {% else %}
                                        No Budget
                                    {% endif %}
                                    <svg class="ml-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                                
                                <!-- Budget Dropdown Menu -->
                                <div id="budget-menu-{{ lead.id }}" class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                    <div class="py-1">
                                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b">Update Budget</div>
                                        <form method="post" action="{% url 'leads:update_budget' lead.pk %}" class="budget-update-form" data-lead-id="{{ lead.id }}">
                                            {% csrf_token %}
                                            <div class="px-4 py-2">
                                                <select name="budget" class="w-full px-2 py-1 text-sm border border-gray-300 rounded">
                                                    <option value="">No Budget</option>
                                                    <option value="5000000" {% if lead.budget == 5000000 %}selected{% endif %}>Under ₹50L</option>
                                                    <option value="7500000" {% if lead.budget == 7500000 %}selected{% endif %}>₹50L - ₹75L</option>
                                                    <option value="10000000" {% if lead.budget == 10000000 %}selected{% endif %}>₹75L - ₹1Cr</option>
                                                    <option value="15000000" {% if lead.budget == 15000000 %}selected{% endif %}>₹1Cr - ₹1.5Cr</option>
                                                    <option value="20000000" {% if lead.budget == 20000000 %}selected{% endif %}>₹1.5Cr - ₹2Cr</option>
                                                    <option value="25000000" {% if lead.budget == 25000000 %}selected{% endif %}>Over ₹2Cr</option>
                                                </select>
                                            </div>
                                            <div class="px-4 py-2 border-t">
                                                <button type="submit" class="w-full px-3 py-1 bg-olive-primary text-white text-sm rounded hover:bg-olive-secondary">
                                                    Update
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-2">
                                <a href="{% url 'leads:detail' lead.pk %}" 
                                   class="inline-flex items-center px-3 py-1 border border-olive-primary text-olive-primary text-xs font-medium rounded hover:bg-olive-primary hover:text-white transition-colors">
                                    View
                                </a>
                                <button onclick="openNotesModal({{ lead.id }})" 
                                        class="inline-flex items-center px-3 py-1 border border-blue-300 text-blue-600 text-xs font-medium rounded hover:bg-blue-50 transition-colors">
                                    Notes
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>
                {% endif %}
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>
                {% endif %}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ page_obj.start_index }}</span> to <span class="font-medium">{{ page_obj.end_index }}</span> of <span class="font-medium">{{ paginator.count }}</span> results
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Previous
                            </a>
                        {% endif %}
                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-olive-primary bg-olive-primary text-sm font-medium text-white">{{ num }}</span>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <a href="?page={{ num }}&{{ request.GET.urlencode }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">{{ num }}</a>
                            {% endif %}
                        {% endfor %}
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Next
                            </a>
                        {% endif %}
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No leads found</h3>
            <p class="mt-1 text-sm text-gray-500">Get started by creating a new lead.</p>
            <div class="mt-6">
                <a href="{% url 'leads:create' %}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-olive-primary hover:bg-olive-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-olive-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Lead
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Notes Modal -->
<div id="notes-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Add Notes</h3>
            <form id="notes-form" method="post">
                {% csrf_token %}
                <input type="hidden" id="notes-lead-id" name="lead_id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="notes-content" name="content" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-olive-primary focus:border-olive-primary" required></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeNotesModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-md hover:bg-olive-secondary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Success Message -->
<div id="success-message" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
    <div class="flex items-center">
        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <span id="success-text">Success!</span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Status dropdown functionality
function toggleStatusMenu(leadId) {
    const menu = document.getElementById(`status-menu-${leadId}`);
    
    // Close all other menus
    document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"]').forEach(m => {
        if (m.id !== `status-menu-${leadId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle current menu
    menu.classList.toggle('hidden');
}

// Budget dropdown functionality
function toggleBudgetMenu(leadId) {
    const menu = document.getElementById(`budget-menu-${leadId}`);
    
    // Close all other menus
    document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"]').forEach(m => {
        if (m.id !== `budget-menu-${leadId}`) {
            m.classList.add('hidden');
        }
    });
    
    // Toggle current menu
    menu.classList.toggle('hidden');
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick*="toggleStatusMenu"]') && !event.target.closest('[onclick*="toggleBudgetMenu"]') && !event.target.closest('[id^="status-menu-"]') && !event.target.closest('[id^="budget-menu-"]')) {
        document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
    }
});

// Handle status updates
document.addEventListener('DOMContentLoaded', function() {
    // Handle all status update forms
    document.querySelectorAll('.status-update-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const leadId = this.getAttribute('data-lead-id');
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.textContent = 'Updating...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // Check if response is ok
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update the status button
                    const statusButton = document.querySelector(`#lead-row-${leadId} button[onclick*="toggleStatusMenu"]`);
                    const newStatus = formData.get('status');
                    
                    const statusLabels = {
                        'new': 'New',
                        'contacted': 'Contacted',
                        'visit_scheduled': 'Visit Scheduled',
                        'visit_completed': 'Visit Completed',
                        'interested': 'Interested',
                        'booked': 'Booked',
                        'lost': 'Lost',
                        'not_interested': 'Not Interested'
                    };
                    
                    const statusColors = {
                        'new': ['bg-gray-100', 'text-gray-800'],
                        'contacted': ['bg-blue-100', 'text-blue-800'],
                        'visit_scheduled': ['bg-blue-100', 'text-blue-800'],
                        'visit_completed': ['bg-green-100', 'text-green-800'],
                        'interested': ['bg-purple-100', 'text-purple-800'],
                        'booked': ['bg-purple-100', 'text-purple-800'],
                        'lost': ['bg-red-100', 'text-red-800'],
                        'not_interested': ['bg-gray-100', 'text-gray-800']
                    };
                    
                    if (statusButton) {
                        // Update button text
                        statusButton.innerHTML = `
                            ${statusLabels[newStatus]}
                            <svg class="ml-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        `;
                        
                        // Update button colors
                        statusButton.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-medium status-badge ${statusColors[newStatus][0]} ${statusColors[newStatus][1]}`;
                        statusButton.setAttribute('data-current-status', newStatus);
                    }
                    
                    // Close menu
                    document.getElementById(`status-menu-${leadId}`).classList.add('hidden');
                    
                    // Show success message
                    showSuccessMessage(data.message || 'Status updated successfully');
                    
                } else {
                    throw new Error(data.error || 'Update failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            });
        });
    });

    // Handle budget update forms
    document.querySelectorAll('.budget-update-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const leadId = this.getAttribute('data-lead-id');
            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            
            // Disable button and show loading
            submitButton.disabled = true;
            submitButton.textContent = 'Updating...';
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update the budget button
                    const budgetButton = document.querySelector(`#lead-row-${leadId} button[onclick*="toggleBudgetMenu"]`);
                    const newBudget = formData.get('budget');
                    
                    let budgetText = 'No Budget';
                    let budgetClass = 'bg-gray-100 text-gray-800';
                    
                    if (newBudget) {
                        const budgetValue = parseInt(newBudget);
                        if (budgetValue >= 10000000) {
                            const budgetCr = Math.floor(budgetValue / 10000000);
                            budgetText = `₹${budgetCr} Cr`;
                        } else {
                            const budgetL = Math.floor(budgetValue / 100000);
                            budgetText = `₹${budgetL} L`;
                        }
                        budgetClass = 'bg-green-100 text-green-800';
                    }
                    
                    if (budgetButton) {
                        budgetButton.innerHTML = `
                            ${budgetText}
                            <svg class="ml-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        `;
                        budgetButton.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${budgetClass}`;
                    }
                    
                    // Close menu
                    document.getElementById(`budget-menu-${leadId}`).classList.add('hidden');
                    
                    // Show success message
                    showSuccessMessage(data.message || 'Budget updated successfully');
                    
                } else {
                    throw new Error(data.error || 'Update failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating budget: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            });
        });
    });
});

// Call tracking and dialing
function trackCallClickAndDial(element) {
    // Get lead ID from data attribute
    const leadId = element.getAttribute('data-lead-id');
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     getCookie('csrftoken');
    
    // Get tel link from data attribute
    const telLink = element.getAttribute('data-tel-link');
    
    // Track the click first
    fetch(`/leads/${leadId}/track-call-click/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Call click tracked successfully');
        }
    })
    .catch(error => {
        console.error('Error tracking call click:', error);
    });
    
    // Open phone dialer
    window.location.href = telLink;
}

// Notes modal functionality
function openNotesModal(leadId) {
    document.getElementById('notes-lead-id').value = leadId;
    document.getElementById('notes-modal').classList.remove('hidden');
    document.getElementById('notes-content').focus();
}

function closeNotesModal() {
    document.getElementById('notes-modal').classList.add('hidden');
    document.getElementById('notes-form').reset();
}

// Handle notes form submission
document.getElementById('notes-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const leadId = formData.get('lead_id');
    const content = formData.get('content');
    
    // Validate content is not empty
    if (!content || content.trim() === '') {
        alert('Please enter a note before submitting.');
        return;
    }
    
    fetch(`/leads/${leadId}/update-notes/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeNotesModal();
            showSuccessMessage('Notes added successfully');
        } else {
            throw new Error(data.error || 'Failed to add notes');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding notes: ' + error.message);
    });
});

// Success message functionality
function showSuccessMessage(message) {
    const messageEl = document.getElementById('success-message');
    const textEl = document.getElementById('success-text');
    
    textEl.textContent = message;
    messageEl.classList.remove('hidden');
    
    setTimeout(() => {
        messageEl.classList.add('hidden');
    }, 3000);
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
