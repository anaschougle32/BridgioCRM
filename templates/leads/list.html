{% extends 'base.html' %}
{% load tz %}
{% load lead_filters %}

{% block title %}Leads - Bridgio CRM{% endblock %}

{% block page_title %}Leads{% endblock %}
{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-heading font-bold text-olive-primary">Leads</h1>
        <a href="{% url 'leads:create' %}" 
           class="bg-olive-primary text-white px-6 py-2 rounded-custom hover:bg-olive-secondary transition">
            New Visit
        </a>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-custom shadow-md p-4">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="text" name="search" placeholder="Search by name, phone, email..." 
                   value="{{ search }}"
                   class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
            <select name="status" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                <option value="">All Status</option>
                {% for value, label in status_choices %}
                <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <select name="pretag_status" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                <option value="">All Pretags</option>
                {% for value, label in pretag_status_choices %}
                <option value="{{ value }}" {% if selected_pretag_status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="bg-olive-primary text-white px-4 py-2 rounded-custom hover:bg-olive-secondary transition">
                Filter
            </button>
        </form>
    </div>
    
    <!-- Leads Table -->
    <div class="bg-white rounded-custom shadow-md overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for lead in leads %}
                {% with notif=lead_notifications|get_item:lead.id %}
                <tr class="hover:bg-gray-50" id="lead-row-{{ lead.id }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <span class="font-medium">{{ lead.name }}</span>
                            {% if notif.overdue_count > 0 %}
                            <a href="{% url 'leads:detail' lead.pk %}" class="ml-2 px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 hover:bg-red-200" title="{{ notif.overdue_count }} overdue reminder(s)">
                                ‚ö†Ô∏è {{ notif.overdue_count }}
                            </a>
                            {% endif %}
                            {% if notif.today_callbacks > 0 %}
                            <a href="{% url 'leads:detail' lead.pk %}" class="ml-2 px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 hover:bg-yellow-200" title="{{ notif.today_callbacks }} callback(s) today">
                                üìû {{ notif.today_callbacks }}
                            </a>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="{{ notif.tel_link|default:'tel:+91' }}{{ lead.phone }}" 
                           class="inline-flex items-center px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium"
                           title="Call Now">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            Call
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <!-- Status Dropdown -->
                        <div class="relative inline-block text-left">
                            <button type="button" 
                                    class="inline-flex items-center px-3 py-1.5 text-xs rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-olive-primary"
                                    onclick="toggleStatusMenu({{ lead.id }})">
                                {{ lead.get_status_display }}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="status-menu-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1">
                                    {% for value, label in status_choices %}
                                    <form method="post" action="{% url 'leads:update_status' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="status" value="{{ value }}">
                                        <button type="submit" 
                                                class="block w-full text-left px-4 py-2 text-sm {% if lead.status == value %}bg-blue-50 text-blue-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                                            {{ label }}
                                        </button>
                                    </form>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-2">
                            <!-- Quick Actions -->
                            <a href="{% url 'leads:detail' lead.pk %}" 
                               class="px-2 py-1 text-xs text-olive-primary hover:text-olive-secondary border border-olive-primary rounded hover:bg-olive-primary/10">
                                View
                            </a>
                            <button onclick="openLogCallModal({{ lead.id }})" 
                                    class="px-2 py-1 text-xs text-blue-600 hover:text-blue-700 border border-blue-300 rounded hover:bg-blue-50">
                                Log Call
                            </button>
                            <button onclick="openWhatsAppModal({{ lead.id }})" 
                                    class="px-2 py-1 text-xs text-green-600 hover:text-green-700 border border-green-300 rounded hover:bg-green-50">
                                WhatsApp
                            </button>
                            <button onclick="openReminderModal({{ lead.id }})" 
                                    class="px-2 py-1 text-xs text-yellow-600 hover:text-yellow-700 border border-yellow-300 rounded hover:bg-yellow-50">
                                Reminder
                            </button>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-gray-500">No leads found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if leads.has_other_pages %}
    <div class="mt-6 flex justify-center space-x-2">
        {% if leads.has_previous %}
        <a href="?page={{ leads.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_pretag_status %}&pretag_status={{ selected_pretag_status }}{% endif %}" 
           class="px-4 py-2 border border-gray-300 rounded-custom hover:bg-gray-50">Previous</a>
        {% endif %}
        <span class="px-4 py-2">Page {{ leads.number }} of {{ leads.paginator.num_pages }}</span>
        {% if leads.has_next %}
        <a href="?page={{ leads.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_pretag_status %}&pretag_status={{ selected_pretag_status }}{% endif %}" 
           class="px-4 py-2 border border-gray-300 rounded-custom hover:bg-gray-50">Next</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Log Call Modal -->
<div id="log-call-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Log Call</h3>
            <button onclick="closeLogCallModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <form id="log-call-form" method="post" hx-post="" hx-target="#call-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Call Outcome *</label>
                    <select name="outcome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">Select Outcome</option>
                        <option value="connected">Connected</option>
                        <option value="not_reachable">Not Reachable</option>
                        <option value="switched_off">Switched Off</option>
                        <option value="wrong_number">Wrong Number</option>
                        <option value="busy">Busy</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Next Action</label>
                    <select name="next_action" id="next-action-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">None</option>
                        <option value="callback">Callback</option>
                        <option value="schedule_visit">Schedule Visit</option>
                        <option value="not_interested">Mark as Not Interested</option>
                    </select>
                </div>
                <div id="callback-date-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Callback Date & Time</label>
                    <input type="datetime-local" name="reminder_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="closeLogCallModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Log Call</button>
            </div>
        </form>
        <div id="call-result"></div>
    </div>
</div>

<!-- WhatsApp Modal -->
<div id="whatsapp-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Send WhatsApp</h3>
            <button onclick="closeWhatsAppModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <div class="space-y-3">
            <a id="whatsapp-intro" href="#" target="_blank" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Intro Message</a>
            <a id="whatsapp-project" href="#" target="_blank" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Project Details</a>
            <a id="whatsapp-booking" href="#" target="_blank" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Booking Confirmation</a>
        </div>
        <div class="mt-4">
            <button onclick="closeWhatsAppModal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
        </div>
    </div>
</div>

<!-- Reminder Modal -->
<div id="reminder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Set Reminder</h3>
            <button onclick="closeReminderModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <form id="reminder-form" method="post" hx-post="" hx-target="#reminder-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Type *</label>
                    <select name="reminder_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="callback">Callback</option>
                        <option value="payment_followup">Payment Follow-up</option>
                        <option value="visit_reminder">Visit Reminder</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date & Time *</label>
                    <input type="datetime-local" name="reminder_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="closeReminderModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Set Reminder</button>
            </div>
        </form>
        <div id="reminder-result"></div>
    </div>
</div>

<script>
    function toggleStatusMenu(leadId) {
        const menu = document.getElementById('status-menu-' + leadId);
        // Close all other menus
        document.querySelectorAll('[id^="status-menu-"]').forEach(m => {
            if (m.id !== 'status-menu-' + leadId) {
                m.classList.add('hidden');
            }
        });
        menu.classList.toggle('hidden');
    }
    
    // Close menus when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('[onclick*="toggleStatusMenu"]') && !event.target.closest('[id^="status-menu-"]')) {
            document.querySelectorAll('[id^="status-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });
    
    let currentLeadId = null;
    
    function openLogCallModal(leadId) {
        currentLeadId = leadId;
        const form = document.getElementById('log-call-form');
        form.action = '/leads/' + leadId + '/log-call/';
        form.setAttribute('hx-post', '/leads/' + leadId + '/log-call/');
        document.getElementById('log-call-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
    
    function closeLogCallModal() {
        document.getElementById('log-call-modal').classList.add('hidden');
        document.getElementById('log-call-form').reset();
        document.getElementById('callback-date-field').style.display = 'none';
    }
    
    function openWhatsAppModal(leadId) {
        currentLeadId = leadId;
        // Fetch WhatsApp links (you'll need to create an endpoint or use existing)
        fetch('/leads/' + leadId + '/whatsapp/?template=intro')
            .then(response => response.text())
            .then(html => {
                // Parse and set links (simplified - you may need to adjust)
                document.getElementById('whatsapp-intro').href = '/leads/' + leadId + '/whatsapp/?template=intro';
                document.getElementById('whatsapp-project').href = '/leads/' + leadId + '/whatsapp/?template=project';
                document.getElementById('whatsapp-booking').href = '/leads/' + leadId + '/whatsapp/?template=booking';
            });
        document.getElementById('whatsapp-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
    
    function closeWhatsAppModal() {
        document.getElementById('whatsapp-modal').classList.add('hidden');
    }
    
    function openReminderModal(leadId) {
        currentLeadId = leadId;
        const form = document.getElementById('reminder-form');
        form.action = '/leads/' + leadId + '/create-reminder/';
        form.setAttribute('hx-post', '/leads/' + leadId + '/create-reminder/');
        document.getElementById('reminder-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
    
    function closeReminderModal() {
        document.getElementById('reminder-modal').classList.add('hidden');
        document.getElementById('reminder-form').reset();
    }
    
    // Show/hide callback date field
    document.getElementById('next-action-select')?.addEventListener('change', function() {
        const callbackField = document.getElementById('callback-date-field');
        if (this.value === 'callback') {
            callbackField.style.display = 'block';
        } else {
            callbackField.style.display = 'none';
        }
    });
    
    // Handle htmx responses
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'call-result' || event.detail.target.id === 'reminder-result') {
            setTimeout(() => {
                closeLogCallModal();
                closeReminderModal();
                location.reload(); // Reload to update notifications
            }, 1500);
        }
    });
    
    // Handle form submissions for status updates
    document.querySelectorAll('form[action*="update-status"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                location.reload();
            });
        });
    });
</script>
{% endblock %}
