{% extends 'base.html' %}
{% load tz %}
{% load lead_filters %}

{% block title %}Leads - Bridgio CRM{% endblock %}

{% block page_title %}Leads{% endblock %}
{% block content %}
<!-- Tablet Split-View Layout (md: 768px-1024px) -->
<div class="hidden md:flex lg:hidden h-[calc(100vh-8rem)] -mx-4 sm:-mx-6">
    <!-- Left Column: Leads List (40%) -->
    <div class="w-2/5 border-r border-gray-200 overflow-y-auto flex flex-col">
        <!-- Header with Filters -->
        <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10">
            <h1 class="text-xl font-heading font-bold text-olive-primary mb-3">Leads</h1>
            
            <!-- Compact Filters -->
            <div class="space-y-2">
                <input type="text" 
                       name="search" 
                       placeholder="Search..." 
                       value="{{ search }}"
                       hx-get="{% url 'leads:list' %}"
                       hx-target="#leads-list-tablet"
                       hx-trigger="keyup changed delay:500ms"
                       hx-include="[name='status'], [name='project']"
                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                <div class="flex gap-2">
                    <select name="status" 
                            hx-get="{% url 'leads:list' %}"
                            hx-target="#leads-list-tablet"
                            hx-trigger="change"
                            hx-include="[name='search'], [name='project']"
                            class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="project"
                            hx-get="{% url 'leads:list' %}"
                            hx-target="#leads-list-tablet"
                            hx-trigger="change"
                            hx-include="[name='search'], [name='status']"
                            class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if selected_project == project.id|stringformat:"s" %}selected{% endif %}>{{ project.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Leads List -->
        <div id="leads-list-tablet" class="flex-1 overflow-y-auto">
            {% for lead in leads %}
            {% with notif=lead_notifications|get_item:lead.id %}
            {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
            <div class="border-b border-gray-200 p-3 hover:bg-gray-50 cursor-pointer transition-colors tablet-lead-item min-h-[48px]"
                 data-lead-id="{{ lead.id }}"
                 onclick="loadLeadDetail({{ lead.id }})">
                <div class="flex items-center justify-between mb-1">
                    <h3 class="font-semibold text-sm text-gray-900 truncate flex-1">{{ lead.name }}</h3>
                    {% if notif.overdue_count > 0 %}
                    <span class="ml-2 px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-800 flex-shrink-0">{{ notif.overdue_count }}</span>
                    {% endif %}
                </div>
                <div class="flex items-center gap-2 text-xs text-gray-600">
                    <span class="font-mono">{{ phone_display|default:lead.phone }}</span>
                    {% if primary_assoc %}
                    <span class="status-badge px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs">{{ primary_assoc.get_status_display|slice:":10" }}</span>
                    {% endif %}
                </div>
                {% if lead.notes %}
                {% load lead_filters %}
                <p class="text-xs text-gray-500 mt-1 line-clamp-1">{{ lead.notes|get_last_note|truncatewords:8 }}</p>
                {% endif %}
            </div>
            {% endwith %}
            {% endwith %}
            {% empty %}
            <div class="p-8 text-center">
                <p class="text-gray-500 text-sm">No leads found</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Right Column: Lead Detail (60%) -->
    <div class="w-3/5 overflow-y-auto bg-gray-50" id="tablet-lead-detail">
        <div class="p-6 text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <p class="text-sm">Select a lead to view details</p>
        </div>
    </div>
</div>

<!-- Mobile & Desktop View (≤767px and ≥1025px) -->
<div class="md:hidden lg:block space-y-4 sm:space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0">
        <h1 class="text-2xl sm:text-3xl font-heading font-bold text-olive-primary">Leads</h1>
        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
            {% if user.is_super_admin or user.is_mandate_owner or user.is_site_head %}
            <a href="{% url 'leads:upload' %}" 
               class="w-full sm:w-auto bg-gray-600 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-gray-700 transition text-center text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>Upload Leads
            </a>
            <a href="{% url 'leads:visits_list' %}" 
               class="w-full sm:w-auto bg-blue-600 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-blue-700 transition text-center text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>Visits
            </a>
            {% endif %}
            <a href="{% url 'leads:create' %}" 
               class="w-full sm:w-auto bg-olive-primary text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-olive-secondary transition text-center text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>New Visit
            </a>
        </div>
    </div>
    
    <!-- Call Metrics -->
    {% if call_metrics %}
    <div class="bg-white rounded-custom shadow-md p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Call Metrics</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            <div class="text-center p-3 bg-blue-50 rounded-lg">
                <div class="text-2xl font-bold text-blue-600">{{ call_metrics.today }}</div>
                <div class="text-xs text-gray-600 mt-1">Today</div>
            </div>
            <div class="text-center p-3 bg-green-50 rounded-lg">
                <div class="text-2xl font-bold text-green-600">{{ call_metrics.this_week }}</div>
                <div class="text-xs text-gray-600 mt-1">This Week</div>
            </div>
            <div class="text-center p-3 bg-purple-50 rounded-lg">
                <div class="text-2xl font-bold text-purple-600">{{ call_metrics.this_month }}</div>
                <div class="text-xs text-gray-600 mt-1">This Month</div>
            </div>
            <div class="text-center p-3 bg-orange-50 rounded-lg">
                <div class="text-2xl font-bold text-orange-600">{{ call_metrics.total }}</div>
                <div class="text-xs text-gray-600 mt-1">Total</div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Filters -->
    <div class="bg-white rounded-custom shadow-md overflow-hidden">
        <form method="get" class="space-y-0">
            <!-- Filter Header (Always Visible) -->
            <div class="p-3 sm:p-4 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button type="button" 
                                id="filter-toggle"
                                onclick="toggleFilters()"
                                class="flex items-center gap-2 text-sm font-medium text-gray-700 hover:text-olive-primary transition-colors">
                            <svg id="filter-chevron" class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span>Filters</span>
                            <span id="active-filter-count" class="ml-2 px-2 py-0.5 text-xs bg-olive-primary text-white rounded-full hidden">0</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="text" name="search" placeholder="Search by name, phone, email, notes... (Press / to focus)" 
                               value="{{ search }}"
                               id="search-input"
                               class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary w-48 sm:w-64">
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Filter Content -->
            <div id="filter-content" class="hidden p-3 sm:p-4 space-y-3">
                <!-- First Row: Basic Filters -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <select name="status" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Status</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="project" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" {% if selected_project == project.id|stringformat:"s" %}selected{% endif %}>{{ project.name }}</option>
                        {% endfor %}
                    </select>
                    <select name="pretag_status" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Pretags</option>
                        {% for value, label in pretag_status_choices %}
                        <option value="{{ value }}" {% if selected_pretag_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="configuration" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Configurations</option>
                        {% for config in configurations %}
                        <option value="{{ config.id }}" {% if selected_configuration == config.id|stringformat:"s" %}selected{% endif %}>{{ config.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Second Row: Advanced Filters -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <select name="budget" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Budgets</option>
                        <option value="no_budget" {% if selected_budget == 'no_budget' %}selected{% endif %}>No Budget</option>
                        <option value="under_50l" {% if selected_budget == 'under_50l' %}selected{% endif %}>Under ₹50L</option>
                        <option value="50l_to_1cr" {% if selected_budget == '50l_to_1cr' %}selected{% endif %}>₹50L - ₹1Cr</option>
                        <option value="1cr_to_2cr" {% if selected_budget == '1cr_to_2cr' %}selected{% endif %}>₹1Cr - ₹2Cr</option>
                        <option value="over_2cr" {% if selected_budget == 'over_2cr' %}selected{% endif %}>Over ₹2Cr</option>
                    </select>
                    <select name="assigned_to" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Assignees</option>
                        {% for assignee in assignees %}
                        <option value="{{ assignee.id }}" {% if selected_assigned_to == assignee.id|stringformat:"s" %}selected{% endif %}>{{ assignee.username }}</option>
                        {% endfor %}
                    </select>
                    <select name="channel_partner" class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary">
                        <option value="">All Channel Partners</option>
                        {% for cp in channel_partners %}
                        <option value="{{ cp.id }}" {% if selected_channel_partner == cp.id|stringformat:"s" %}selected{% endif %}>{{ cp.cp_name }} ({{ cp.cp_unique_id }})</option>
                        {% endfor %}
                    </select>
                    <div class="flex gap-2">
                        <input type="date" name="date_from" value="{{ date_from }}" placeholder="From Date"
                               class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary flex-1">
                        <input type="date" name="date_to" value="{{ date_to }}" placeholder="To Date"
                               class="px-4 py-2 border border-gray-300 rounded-custom focus:ring-2 focus:ring-olive-primary flex-1">
                    </div>
                </div>
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3 pt-2 border-t border-gray-200">
                    <button type="submit" class="bg-olive-primary text-white px-4 py-2 rounded-custom hover:bg-olive-secondary transition">
                        Filter
                    </button>
                    <a href="{% url 'leads:list' %}" class="px-4 py-2 border border-gray-300 rounded-custom hover:bg-gray-50 transition">
                        Clear
                    </a>
                    {% if user.is_super_admin or user.is_mandate_owner or user.is_site_head %}
                    <a href="{% url 'leads:download' %}?{{ request.GET.urlencode }}" 
                       class="bg-green-600 text-white px-4 py-2 rounded-custom hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>
    
    <!-- Leads - Mobile Card View (≤768px only) -->
    <div class="md:hidden space-y-3">
        {% for lead in leads %}
        {% with notif=lead_notifications|get_item:lead.id %}
        <div class="bg-white rounded-xl p-5 mb-4 shadow-lg border border-gray-100 hover:shadow-xl hover:border-olive-primary/20 touch-manipulation active:scale-[0.98] transition-all duration-200 cursor-pointer" 
             id="lead-card-{{ lead.id }}" 
             data-lead-id="{{ lead.id }}"
             onclick="loadLeadDetail({{ lead.id }})">
            <!-- Card Header -->
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-2 flex-wrap">
                        <h3 class="font-semibold text-base text-gray-900 truncate">{{ lead.name }}</h3>
                        <div class="flex items-center gap-1 flex-wrap">
                            {% if notif.overdue_count > 0 %}
                            <span class="px-1.5 py-0.5 text-xs rounded-full bg-red-100 text-red-800 flex items-center gap-1 flex-shrink-0" title="{{ notif.overdue_count }} overdue reminder(s)">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>{{ notif.overdue_count }}
                            </span>
                            {% endif %}
                            {% if notif.today_callbacks > 0 %}
                            <span class="px-1.5 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 flex items-center gap-1 flex-shrink-0" title="{{ notif.today_callbacks }} callback(s) today">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>{{ notif.today_callbacks }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Status Badge -->
                    {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
                    <div class="mb-3">
                        <span class="status-badge inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-full shadow-sm {% if primary_assoc and primary_assoc.status == 'visit_completed' %}bg-green-100 text-green-800 border border-green-200{% elif primary_assoc and primary_assoc.status == 'visit_scheduled' %}bg-blue-100 text-blue-800 border border-blue-200{% elif primary_assoc and primary_assoc.status == 'interested' %}bg-purple-100 text-purple-800 border border-purple-200{% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}">
                            {% if primary_assoc %}{{ primary_assoc.get_status_display }}{% else %}New{% endif %}
                        </span>
                    </div>
                    {% endwith %}
                    <!-- Quick Actions -->
                    <div class="flex items-center gap-2 mt-3" onclick="event.stopPropagation();">
                        <a href="{{ notif.tel_link }}" 
                           target="_blank" 
                           onclick="trackCallClick({{ lead.id }});"
                           class="inline-flex items-center px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:shadow-md transition-all text-sm font-semibold min-h-[48px] shadow-sm">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            Call
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4 text-sm border-t border-gray-100 pt-4">
                <div>
                    <span class="text-gray-600 text-xs font-medium mb-1 block">Budget:</span>
                    <div class="mt-1.5">
                        <div class="relative inline-block text-left">
                            <button type="button" 
                                    class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-full shadow-sm {% if lead.budget %}bg-green-100 text-green-800 border border-green-200{% else %}bg-gray-100 text-gray-600 border border-gray-200{% endif %} hover:bg-green-200 transition-colors"
                                    onclick="toggleBudgetMenu({{ lead.id }})">
                                {% if lead.budget %}
                                    {% if lead.budget >= 10000000 %}
                                        {% widthratio lead.budget 10000000 1 as budget_cr %}
                                        ₹{{ budget_cr }} Cr
                                    {% else %}
                                        {% widthratio lead.budget 100000 1 as budget_l %}
                                        ₹{{ budget_l }} L
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400">—</span>
                                {% endif %}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="budget-menu-mobile-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1 max-h-60 overflow-y-auto">
                                    <form method="post" action="{% url 'leads:update_budget' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="budget" value="">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Clear Budget</button>
                                    </form>
                                    <div class="border-t my-1"></div>
                                    {% for value, label in budget_choices %}
                                    <form method="post" action="{% url 'leads:update_budget' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="budget" value="{{ value }}">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm {% if lead.budget == value %}bg-green-50 text-green-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">{{ label }}</button>
                                    </form>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <span class="text-gray-600 text-xs font-medium mb-1 block">Config:</span>
                    <div class="mt-1.5">
                        <div class="relative inline-block text-left">
                            {% with lead_configs=lead.configurations.all %}
                            <button type="button" 
                                    class="inline-flex items-center px-3 py-1.5 text-xs font-medium rounded-full shadow-sm {% if lead_configs %}bg-blue-100 text-blue-800 border border-blue-200{% else %}bg-gray-100 text-gray-600 border border-gray-200{% endif %} hover:bg-blue-200 transition-colors"
                                    onclick="toggleConfigMenu({{ lead.id }})">
                                {% if lead_configs %}
                                    <span>{% for config in lead_configs %}{{ config.display_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
                                {% else %}
                                    <span class="text-gray-400">—</span>
                                {% endif %}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="config-menu-mobile-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1 max-h-60 overflow-y-auto">
                                    {% for config in configurations %}
                                    <form method="post" action="{% url 'leads:update_configuration' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="configuration" value="{{ config.id }}">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm {% if config in lead_configs %}bg-blue-50 text-blue-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                                            {% if config in lead_configs %}✓ {% endif %}{{ config.display_name }}
                                        </button>
                                    </form>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endwith %}
                        </div>
                    </div>
                </div>
                <div>
                    <span class="text-gray-500 text-xs">CP ID:</span>
                    <div class="mt-1">
                        {% if lead.channel_partner %}
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">{{ lead.channel_partner.cp_unique_id }}</span>
                        {% else %}
                            <span class="text-gray-400 text-xs">—</span>
                        {% endif %}
                    </div>
                </div>
                <div>
                    <span class="text-gray-500 text-xs">Status:</span>
                    <div class="mt-1">
                        <div class="relative inline-block text-left">
                            {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
                            <button type="button" 
                                    class="status-display inline-flex items-center px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200"
                                    onclick="toggleStatusMenu({{ lead.id }})">
                                {% if primary_assoc %}{{ primary_assoc.get_status_display }}{% else %}New{% endif %}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="status-menu-mobile-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1">
                                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b">Status</div>
                                    {% for value, label in status_choices %}
                                    <form method="post" action="{% url 'leads:update_status' lead.pk %}" class="inline" data-lead-id="{{ lead.id }}">
                                        {% csrf_token %}
                                        {% if primary_assoc %}<input type="hidden" name="project_id" value="{{ primary_assoc.project_id }}">{% endif %}
                                        <input type="hidden" name="status" value="{{ value }}">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm {% if primary_assoc and primary_assoc.status == value %}bg-blue-50 text-blue-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">{{ label }}</button>
                                    </form>
                                    {% endfor %}
                                    <div class="border-t my-1"></div>
                                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b">Actions</div>
                                    <button onclick="openLogCallModal({{ lead.id }}); toggleStatusMenu({{ lead.id }});" class="block w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                                        Log Call
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if lead.notes %}
            <div class="mb-3">
                <span class="text-gray-500 text-xs">Notes:</span>
                {% load lead_filters %}
                <p class="text-sm text-gray-700 mt-1 line-clamp-2">{{ lead.notes|get_last_note|truncatewords:15 }}</p>
            </div>
            {% endif %}
            
            <div class="flex flex-wrap gap-2 pt-3 border-t border-gray-200">
                <a href="{% url 'leads:detail' lead.pk %}" class="flex-1 px-3 py-1.5 text-xs text-center text-olive-primary hover:text-olive-secondary border border-olive-primary rounded hover:bg-olive-primary/10">View</a>
                <button onclick="openNotesModal({{ lead.id }})" class="flex-1 px-3 py-1.5 text-xs text-center text-blue-600 hover:text-blue-700 border border-blue-300 rounded hover:bg-blue-50">Add Notes</button>
            </div>
        </div>
        {% endwith %}
        {% endwith %}
        {% empty %}
        <div class="bg-white rounded-lg shadow-md p-8 text-center">
            <p class="text-gray-500">No leads found</p>
        </div>
        {% endfor %}
    </div>
    
    <!-- Leads Table - Desktop View (≥769px) -->
    <div class="hidden md:block bg-white rounded-custom shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none sortable-column" data-column="name">
                            Name
                            <span class="sort-icon inline-block ml-1 text-gray-400">⇅</span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none sortable-column" data-column="budget">
                            Budget
                            <span class="sort-icon inline-block ml-1 text-gray-400">⇅</span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Configuration</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">CP ID</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase max-w-xs">Notes</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100 select-none sortable-column" data-column="status">
                            Status
                            <span class="sort-icon inline-block ml-1 text-gray-400">⇅</span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                {% for lead in leads %}
                {% with notif=lead_notifications|get_item:lead.id %}
                <tr class="hover:bg-gray-50 {% cycle 'bg-white' 'bg-gray-50' %}" id="lead-row-{{ lead.id }}">
                    <td class="px-3 sm:px-6 py-3 sm:py-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2">
                            <span class="font-medium text-sm sm:text-base">{{ lead.name }}</span>
                            <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
                                {% if notif.overdue_count > 0 %}
                                <a href="{% url 'leads:detail' lead.pk %}" class="px-1.5 sm:px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-800 hover:bg-red-200 flex items-center gap-1" title="{{ notif.overdue_count }} overdue reminder(s)">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>{{ notif.overdue_count }}
                                </a>
                                {% endif %}
                                {% if notif.today_callbacks > 0 %}
                                <a href="{% url 'leads:detail' lead.pk %}" class="px-1.5 sm:px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800 hover:bg-yellow-200 flex items-center gap-1" title="{{ notif.today_callbacks }} callback(s) today">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>{{ notif.today_callbacks }}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4">
                        <a href="{{ notif.tel_link }}" 
                           class="inline-flex items-center px-2 sm:px-3 py-1 sm:py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-xs sm:text-sm font-medium"
                           title="Call Now"
                           onclick="event.stopPropagation(); trackCallClick({{ lead.id }});"
                           target="_blank">
                            <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            <span class="hidden sm:inline">Call</span>
                        </a>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-sm">
                        <!-- Budget Dropdown -->
                        <div class="relative inline-block text-left">
                            <button type="button" 
                                    class="inline-flex items-center px-2 sm:px-3 py-1 text-xs rounded-full {% if lead.budget %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-600{% endif %} hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-olive-primary"
                                    onclick="toggleBudgetMenu({{ lead.id }})">
                                {% if lead.budget %}
                                    {% if lead.budget >= 10000000 %}
                                        {% widthratio lead.budget 10000000 1 as budget_cr %}
                                        ₹{{ budget_cr }} Cr
                                    {% else %}
                                        {% widthratio lead.budget 100000 1 as budget_l %}
                                        ₹{{ budget_l }} L
                                    {% endif %}
                                {% else %}
                                    <span class="text-gray-400">—</span>
                                {% endif %}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="budget-menu-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1 max-h-60 overflow-y-auto">
                                    <form method="post" action="{% url 'leads:update_budget' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="budget" value="">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            Clear Budget
                                        </button>
                                    </form>
                                    <div class="border-t my-1"></div>
                                    {% for value, label in budget_choices %}
                                    <form method="post" action="{% url 'leads:update_budget' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="budget" value="{{ value }}">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm {% if lead.budget == value %}bg-green-50 text-green-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                                            {{ label }}
                                        </button>
                                    </form>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-sm">
                        <!-- Configuration Dropdown -->
                        <div class="relative inline-block text-left">
                            {% with lead_configs=lead.configurations.all %}
                            <button type="button" 
                                    class="inline-flex items-center px-2 sm:px-3 py-1 text-xs rounded-full {% if lead_configs %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-600{% endif %} hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-olive-primary"
                                    onclick="toggleConfigMenu({{ lead.id }})">
                                {% if lead_configs %}
                                    <span>{% for config in lead_configs %}{{ config.display_name }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
                                {% else %}
                                    <span class="text-gray-400">—</span>
                                {% endif %}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="config-menu-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1 max-h-60 overflow-y-auto">
                                    {% for config in configurations %}
                                    <form method="post" action="{% url 'leads:update_configuration' lead.pk %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="configuration" value="{{ config.id }}">
                                        <button type="submit" class="block w-full text-left px-4 py-2 text-sm {% if config in lead_configs %}bg-blue-50 text-blue-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                                            {% if config in lead_configs %}✓ {% endif %}{{ config.display_name }}
                                        </button>
                                    </form>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endwith %}
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4 text-sm">
                        {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
                        {% if primary_assoc and primary_assoc.is_pretagged and lead.channel_partner %}
                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-semibold">{{ lead.channel_partner.cp_unique_id }}</span>
                        {% elif lead.channel_partner %}
                            <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">{{ lead.channel_partner.cp_unique_id }}</span>
                        {% else %}
                            <span class="text-gray-400">—</span>
                        {% endif %}
                        {% endwith %}
                    </td>
                    <td class="px-3 py-3 sm:py-4 text-sm max-w-xs">
                        {% if lead.notes %}
                            {% load lead_filters %}
                            <div class="text-gray-700 truncate" title="{{ lead.notes|get_last_note }}" style="max-width: 200px;">
                                {{ lead.notes|get_last_note|truncatewords:6 }}
                            </div>
                        {% else %}
                            <span class="text-gray-400">—</span>
                        {% endif %}
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4">
                        <!-- Status Dropdown with Call Logging -->
                        <div class="relative inline-block text-left">
                            {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
                            <button type="button" 
                                    class="status-display inline-flex items-center px-2 sm:px-3 py-1 sm:py-1.5 text-xs rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-olive-primary"
                                    onclick="toggleStatusMenu({{ lead.id }})">
                                {% if primary_assoc %}
                                    <span class="hidden sm:inline">{{ primary_assoc.get_status_display }}</span>
                                    <span class="sm:hidden">{{ primary_assoc.get_status_display|slice:":3" }}</span>
                                {% else %}
                                    <span class="hidden sm:inline">New</span>
                                    <span class="sm:hidden">New</span>
                                {% endif %}
                                <svg class="ml-1 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            {% endwith %}
                            <div id="status-menu-{{ lead.id }}" class="hidden absolute left-0 mt-2 w-48 sm:w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1">
                                    <!-- Status Options -->
                                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b">Status</div>
                                    {% with primary_assoc=lead_primary_associations|get_item:lead.id %}
                                    {% for value, label in status_choices %}
                                    <form method="post" action="{% url 'leads:update_status' lead.pk %}" class="inline" data-lead-id="{{ lead.id }}">
                                        {% csrf_token %}
                                        {% if primary_assoc %}<input type="hidden" name="project_id" value="{{ primary_assoc.project_id }}">{% endif %}
                                        <input type="hidden" name="status" value="{{ value }}">
                                        <button type="submit" 
                                                class="block w-full text-left px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm {% if primary_assoc and primary_assoc.status == value %}bg-blue-50 text-blue-800 font-medium{% else %}text-gray-700 hover:bg-gray-100{% endif %}">
                                            {{ label }}
                                        </button>
                                    </form>
                                    {% endfor %}
                                    {% endwith %}
                                    <!-- Call Logging Option -->
                                    <div class="border-t my-1"></div>
                                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase border-b">Actions</div>
                                    <button onclick="openLogCallModal({{ lead.id }}); toggleStatusMenu({{ lead.id }});" 
                                            class="block w-full text-left px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                        </svg>
                                        Log Call
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-3 sm:px-6 py-3 sm:py-4">
                        <div class="flex items-center gap-2">
                            <a href="{% url 'leads:detail' lead.pk %}" 
                               class="px-2 py-1 text-xs text-olive-primary hover:text-olive-secondary border border-olive-primary rounded hover:bg-olive-primary/10">
                                View
                            </a>
                            <button onclick="openNotesModal({{ lead.id }})" 
                                    class="px-2 py-1 text-xs text-blue-600 hover:text-blue-700 border border-blue-300 rounded hover:bg-blue-50">
                                Add Notes
                            </button>
                        </div>
                    </td>
                </tr>
                {% endwith %}
                {% empty %}
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">No leads found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if leads.has_other_pages %}
    <div class="mt-6 flex justify-center space-x-2">
        {% if leads.has_previous %}
        <a href="?page={{ leads.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_pretag_status %}&pretag_status={{ selected_pretag_status }}{% endif %}" 
           class="px-4 py-2 border border-gray-300 rounded-custom hover:bg-gray-50">Previous</a>
        {% endif %}
        <span class="px-4 py-2">Page {{ leads.number }} of {{ leads.paginator.num_pages }}</span>
        {% if leads.has_next %}
        <a href="?page={{ leads.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_pretag_status %}&pretag_status={{ selected_pretag_status }}{% endif %}" 
           class="px-4 py-2 border border-gray-300 rounded-custom hover:bg-gray-50">Next</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Log Call Modal -->
<div id="log-call-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Log Call</h3>
            <button onclick="closeLogCallModal()" class="text-gray-500 hover:text-gray-700">✕</button>
        </div>
        <form id="log-call-form" method="post" hx-post="" hx-target="#call-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Call Outcome *</label>
                    <select name="outcome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">Select Outcome</option>
                        <option value="connected">Connected</option>
                        <option value="not_reachable">Not Reachable</option>
                        <option value="switched_off">Switched Off</option>
                        <option value="wrong_number">Wrong Number</option>
                        <option value="busy">Busy</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Next Action</label>
                    <select name="next_action" id="next-action-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">None</option>
                        <option value="callback">Callback</option>
                        <option value="schedule_visit">Schedule Visit</option>
                        <option value="not_interested">Mark as Not Interested</option>
                    </select>
                </div>
                <div id="callback-date-field" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Callback Date & Time</label>
                    <input type="datetime-local" name="reminder_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="closeLogCallModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Log Call</button>
            </div>
        </form>
        <div id="call-result"></div>
    </div>
</div>

<!-- WhatsApp Modal -->
<div id="whatsapp-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Send WhatsApp</h3>
            <button onclick="closeWhatsAppModal()" class="text-gray-500 hover:text-gray-700">✕</button>
        </div>
        <div class="space-y-3">
            <a id="whatsapp-intro" href="#" target="_blank" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Intro Message</a>
            <a id="whatsapp-project" href="#" target="_blank" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Project Details</a>
            <a id="whatsapp-booking" href="#" target="_blank" class="block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Booking Confirmation</a>
        </div>
        <div class="mt-4">
            <button onclick="closeWhatsAppModal()" class="w-full px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Close</button>
        </div>
    </div>
</div>

<!-- Notes Modal -->
<div id="notes-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Add Note</h3>
            <button onclick="closeNotesModal()" class="text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="notes-form" method="post" hx-post="" hx-target="#notes-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes *</label>
                    <textarea name="notes" id="notes-textarea" rows="6" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary" placeholder="Add important notes about conversations, preferences, follow-ups, etc."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="closeNotesModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Save Notes</button>
            </div>
        </form>
        <div id="notes-result"></div>
    </div>
</div>

<!-- Reminder Modal -->
<div id="reminder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-4 sm:p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Set Reminder</h3>
            <button onclick="closeReminderModal()" class="text-gray-500 hover:text-gray-700">✕</button>
        </div>
        <form id="reminder-form" method="post" hx-post="" hx-target="#reminder-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Type *</label>
                    <select name="reminder_type" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="callback">Callback</option>
                        <option value="payment_followup">Payment Follow-up</option>
                        <option value="visit_reminder">Visit Reminder</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date & Time *</label>
                    <input type="datetime-local" name="reminder_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button type="button" onclick="closeReminderModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Set Reminder</button>
            </div>
        </form>
        <div id="reminder-result"></div>
    </div>
</div>

<script>
    // Collapsible Filters
    function toggleFilters() {
        const filterContent = document.getElementById('filter-content');
        const chevron = document.getElementById('filter-chevron');
        const isHidden = filterContent.classList.contains('hidden');
        
        if (isHidden) {
            filterContent.classList.remove('hidden');
            chevron.style.transform = 'rotate(180deg)';
            localStorage.setItem('leadsFiltersExpanded', 'true');
        } else {
            filterContent.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
            localStorage.setItem('leadsFiltersExpanded', 'false');
        }
        updateActiveFilterCount();
    }
    
    function updateActiveFilterCount() {
        const form = document.querySelector('form[method="get"]');
        if (!form) return;
        
        const formData = new FormData(form);
        let activeCount = 0;
        
        // Count non-empty filter values (excluding search and page)
        for (const [key, value] of formData.entries()) {
            if (key !== 'search' && key !== 'page' && value && value.trim() !== '') {
                activeCount++;
            }
        }
        
        const countBadge = document.getElementById('active-filter-count');
        if (countBadge) {
            if (activeCount > 0) {
                countBadge.textContent = activeCount;
                countBadge.classList.remove('hidden');
            } else {
                countBadge.classList.add('hidden');
            }
        }
    }
    
    // Initialize filter state from localStorage
    document.addEventListener('DOMContentLoaded', function() {
        const savedState = localStorage.getItem('leadsFiltersExpanded');
        const filterContent = document.getElementById('filter-content');
        const chevron = document.getElementById('filter-chevron');
        
        if (savedState === 'true' && filterContent) {
            filterContent.classList.remove('hidden');
            if (chevron) chevron.style.transform = 'rotate(180deg)';
        }
        
        updateActiveFilterCount();
        
        // Update count when filters change
        const filterInputs = document.querySelectorAll('#filter-content select, #filter-content input[type="date"]');
        filterInputs.forEach(input => {
            input.addEventListener('change', updateActiveFilterCount);
        });
    });
    
    function toggleStatusMenu(leadId) {
        const menu = document.getElementById('status-menu-' + leadId);
        const mobileMenu = document.getElementById('status-menu-mobile-' + leadId);
        // Close all other menus
        document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"], [id^="config-menu-"]').forEach(m => {
            if (m.id !== 'status-menu-' + leadId && m.id !== 'status-menu-mobile-' + leadId && m.id !== 'budget-menu-' + leadId && m.id !== 'budget-menu-mobile-' + leadId && m.id !== 'config-menu-' + leadId && m.id !== 'config-menu-mobile-' + leadId) {
                m.classList.add('hidden');
            }
        });
        if (menu) menu.classList.toggle('hidden');
        if (mobileMenu) mobileMenu.classList.toggle('hidden');
    }
    
    function toggleBudgetMenu(leadId) {
        const menu = document.getElementById('budget-menu-' + leadId);
        const mobileMenu = document.getElementById('budget-menu-mobile-' + leadId);
        // Close all other menus
        document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"], [id^="config-menu-"]').forEach(m => {
            if (m.id !== 'status-menu-' + leadId && m.id !== 'budget-menu-' + leadId && m.id !== 'budget-menu-mobile-' + leadId && m.id !== 'config-menu-' + leadId && m.id !== 'config-menu-mobile-' + leadId && m.id !== 'status-menu-mobile-' + leadId) {
                m.classList.add('hidden');
            }
        });
        if (menu) menu.classList.toggle('hidden');
        if (mobileMenu) mobileMenu.classList.toggle('hidden');
    }
    
    function toggleConfigMenu(leadId) {
        const menu = document.getElementById('config-menu-' + leadId);
        const mobileMenu = document.getElementById('config-menu-mobile-' + leadId);
        // Close all other menus
        document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"], [id^="config-menu-"]').forEach(m => {
            if (m.id !== 'status-menu-' + leadId && m.id !== 'status-menu-mobile-' + leadId && m.id !== 'budget-menu-' + leadId && m.id !== 'budget-menu-mobile-' + leadId && m.id !== 'config-menu-' + leadId && m.id !== 'config-menu-mobile-' + leadId) {
                m.classList.add('hidden');
            }
        });
        if (menu) menu.classList.toggle('hidden');
        if (mobileMenu) mobileMenu.classList.toggle('hidden');
    }
    
    // Track call when user clicks call button
    function trackCall(leadId) {
        // This will be called when user clicks the call button
        // The actual call logging happens when they submit the log call form
        // But we can track the click here if needed
        fetch('/leads/' + leadId + '/track-call-click/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        }).catch(err => console.log('Call tracking:', err));
    }
    
    // Close menus when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('[id^="status-menu-"], [id^="budget-menu-"], [id^="config-menu-"], button, [onclick*="toggleStatusMenu"], [onclick*="toggleBudgetMenu"], [onclick*="toggleConfigMenu"]')) {
            document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"], [id^="config-menu-"]').forEach(m => {
                m.classList.add('hidden');
            });
        }
    });
    
    let currentLeadId = null;
    
    function openLogCallModal(leadId) {
        currentLeadId = leadId;
        const form = document.getElementById('log-call-form');
        const url = '/leads/' + leadId + '/log-call/';
        form.action = url;
        form.setAttribute('hx-post', url);
        form.setAttribute('hx-target', '#call-result');
        form.setAttribute('hx-swap', 'innerHTML');
        // Reset form
        form.reset();
        document.getElementById('callback-date-field').style.display = 'none';
        document.getElementById('call-result').innerHTML = '';
        document.getElementById('log-call-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
    
    function closeLogCallModal() {
        document.getElementById('log-call-modal').classList.add('hidden');
        document.getElementById('log-call-form').reset();
        document.getElementById('callback-date-field').style.display = 'none';
    }
    
    function openWhatsAppModal(leadId) {
        currentLeadId = leadId;
        // Fetch WhatsApp links (you'll need to create an endpoint or use existing)
        fetch('/leads/' + leadId + '/whatsapp/?template=intro')
            .then(response => response.text())
            .then(html => {
                // Parse and set links (simplified - you may need to adjust)
                document.getElementById('whatsapp-intro').href = '/leads/' + leadId + '/whatsapp/?template=intro';
                document.getElementById('whatsapp-project').href = '/leads/' + leadId + '/whatsapp/?template=project';
                document.getElementById('whatsapp-booking').href = '/leads/' + leadId + '/whatsapp/?template=booking';
            });
        document.getElementById('whatsapp-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
    
    function closeWhatsAppModal() {
        document.getElementById('whatsapp-modal').classList.add('hidden');
    }
    
    function openReminderModal(leadId) {
        currentLeadId = leadId;
        const form = document.getElementById('reminder-form');
        form.action = '/leads/' + leadId + '/create-reminder/';
        form.setAttribute('hx-post', '/leads/' + leadId + '/create-reminder/');
        document.getElementById('reminder-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
    }
    
    function closeReminderModal() {
        document.getElementById('reminder-modal').classList.add('hidden');
        document.getElementById('reminder-form').reset();
    }
    
    function openNotesModal(leadId) {
        currentLeadId = leadId;
        const form = document.getElementById('notes-form');
        const textarea = document.getElementById('notes-textarea');
        const url = '/leads/' + leadId + '/update-notes/';
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        
        // Set form attributes
        form.action = url;
        form.setAttribute('hx-post', url);
        form.setAttribute('hx-target', '#notes-result');
        form.setAttribute('hx-swap', 'innerHTML');
        if (csrfToken) {
            form.setAttribute('hx-headers', JSON.stringify({'X-CSRFToken': csrfToken}));
        }
        
        // Re-initialize HTMX on the form to pick up the new attributes
        if (typeof htmx !== 'undefined') {
            htmx.process(form);
        }
        
        // Always clear textarea - we're adding a new note, not editing existing ones
        textarea.value = '';
        textarea.placeholder = 'Add important notes about conversations, preferences, follow-ups, etc.';
        document.getElementById('notes-modal').classList.remove('hidden');
        document.querySelectorAll('[id^="actions-menu-"]').forEach(menu => menu.classList.add('hidden'));
        // Focus on textarea
        setTimeout(() => textarea.focus(), 100);
    }
    
    function closeNotesModal() {
        document.getElementById('notes-modal').classList.add('hidden');
        const form = document.getElementById('notes-form');
        const textarea = document.getElementById('notes-textarea');
        form.reset();
        textarea.value = '';
        textarea.placeholder = 'Add important notes about conversations, preferences, follow-ups, etc.';
    }
    
    // Show/hide callback date field
    document.getElementById('next-action-select')?.addEventListener('change', function() {
        const callbackField = document.getElementById('callback-date-field');
        if (this.value === 'callback') {
            callbackField.style.display = 'block';
        } else {
            callbackField.style.display = 'none';
        }
    });
    
    // Handle htmx responses - streamlined and optimized
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const targetId = event.detail.target.id;
        console.log('HTMX afterSwap:', targetId, event.detail);
        
        // Handle successful responses
        if (targetId === 'call-result') {
            const responseText = event.detail.target.innerHTML || '';
            console.log('Call result:', responseText);
            if (responseText.includes('successfully') || responseText.includes('success')) {
                setTimeout(() => {
                    closeLogCallModal();
                    // Force reload to update call metrics
                    window.location.reload();
                }, 1000);
            }
        } else if (targetId === 'notes-result') {
            const responseText = event.detail.target.innerHTML || '';
            console.log('Notes result:', responseText);
            if (responseText.includes('successfully') || responseText.includes('success') || responseText.includes('Note added')) {
                closeNotesModal();
                // Force reload to update notes display
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else if (responseText.includes('error') || responseText.includes('Error')) {
                // Show error message
                alert('Error: ' + responseText);
            } else if (event.detail.xhr?.status >= 400) {
                // HTTP error status
                alert('Error: ' + (responseText || 'Failed to save note. Please try again.'));
            } else {
                // If we get here and no success message, still try to reload after a delay
                console.warn('Unexpected response format, reloading anyway');
                closeNotesModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } else if (targetId === 'reminder-result') {
            const responseText = event.detail.target.innerHTML || '';
            if (responseText.includes('successfully') || responseText.includes('success')) {
                setTimeout(() => {
                    closeReminderModal();
                    window.location.reload();
                }, 1000);
            }
        }
    });
    
    // Also handle HTMX errors
    document.body.addEventListener('htmx:responseError', function(event) {
        console.error('HTMX Error:', event.detail);
        const errorMsg = event.detail.xhr?.responseText || 'An error occurred. Please try again.';
        alert('Error: ' + errorMsg);
    });
    
    // Utility function to get CSRF token from cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Column sorting
    document.querySelectorAll('.sortable-column').forEach(header => {
        header.addEventListener('click', function() {
            const column = this.dataset.column;
            const currentUrl = new URL(window.location);
            const currentSort = currentUrl.searchParams.get('sort');
            const currentOrder = currentUrl.searchParams.get('order');
            
            let newOrder = 'asc';
            if (currentSort === column && currentOrder === 'asc') {
                newOrder = 'desc';
            }
            
            currentUrl.searchParams.set('sort', column);
            currentUrl.searchParams.set('order', newOrder);
            window.location.href = currentUrl.toString();
        });
    });
    
    // Handle page reload trigger from server
    document.body.addEventListener('reloadPage', function() {
        window.location.reload();
    });
    
    // Load lead detail - handles both tablet and mobile
    function loadLeadDetail(leadId) {
        // Check if we're on mobile (≤768px)
        if (window.innerWidth <= 768) {
            // On mobile, navigate to the detail page
            window.location.href = `/leads/${leadId}/`;
            return;
        }
        
        // On tablet (768px - 1024px), use split view
        // Update active state
        document.querySelectorAll('.tablet-lead-item').forEach(item => {
            item.classList.remove('bg-blue-50', 'border-l-4', 'border-blue-500');
        });
        const selectedItem = document.querySelector(`[data-lead-id="${leadId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('bg-blue-50', 'border-l-4', 'border-blue-500');
        }
        
        // Load detail via HTMX
        const detailPanel = document.getElementById('tablet-lead-detail');
        if (detailPanel && typeof htmx !== 'undefined') {
            htmx.ajax('GET', `/leads/${leadId}/`, {
                target: '#tablet-lead-detail',
                swap: 'innerHTML',
                select: '.hidden.md\\:flex.lg\\:hidden',
                headers: {'HX-Request': 'true'}
            }).then(() => {
                // Scroll to top of detail panel
                detailPanel.scrollTop = 0;
            });
        } else if (detailPanel) {
            // Fallback: direct fetch
            fetch(`/leads/${leadId}/`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const tabletView = doc.querySelector('.hidden.md\\:flex.lg\\:hidden');
                    if (tabletView) {
                        detailPanel.innerHTML = tabletView.outerHTML;
                        detailPanel.scrollTop = 0;
                    }
                });
        }
    }
    
    // Handle HTMX before request to add headers
    document.body.addEventListener('htmx:configRequest', function(event) {
        // Ensure CSRF token is included for all HTMX requests
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            event.detail.headers['X-CSRFToken'] = csrfToken.value;
        }
        // Also ensure X-Requested-With header for Django
        event.detail.headers['X-Requested-With'] = 'XMLHttpRequest';
        // Ensure HX-Request header is set
        event.detail.headers['HX-Request'] = 'true';
    });
    
    // Debug HTMX events
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        console.log('HTMX beforeRequest:', event.detail);
        if (event.detail.path && event.detail.path.includes('update-notes')) {
            console.log('Notes form submitting:', event.detail);
        }
    });
    
    document.body.addEventListener('htmx:afterRequest', function(event) {
        console.log('HTMX afterRequest:', event.detail);
        if (event.detail.path && event.detail.path.includes('update-notes')) {
            console.log('Notes form response:', event.detail);
        }
    });
    
    // Handle HTMX errors specifically for notes
    document.body.addEventListener('htmx:responseError', function(event) {
        if (event.detail.path && event.detail.path.includes('update-notes')) {
            console.error('Notes form error:', event.detail);
            const errorMsg = event.detail.xhr?.responseText || 'An error occurred. Please try again.';
            alert('Error adding note: ' + errorMsg);
        }
    });
    
    // Handle form submissions for status, budget, and configuration updates
    document.querySelectorAll('form[action*="update-status"], form[action*="update-budget"], form[action*="update-configuration"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // Check response status first
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'An error occurred');
                    }).catch(() => {
                        throw new Error(`Server error: ${response.status}`);
                    });
                }
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else if (response.redirected) {
                    window.location.href = response.url;
                    return;
                } else {
                    // Non-JSON response, assume success
                    return { success: true };
                }
            })
            .then(data => {
                if (data && data.success) {
                    // Close any open menus
                    document.querySelectorAll('[id^="status-menu-"], [id^="budget-menu-"], [id^="config-menu-"]').forEach(m => {
                        m.classList.add('hidden');
                    });
                    
                    // Update all status displays for this lead
                    const leadId = this.getAttribute('data-lead-id');
                    const newStatus = formData.get('status');
                    
                    // Find the lead container (card or table row)
                    const leadContainers = document.querySelectorAll(`[data-lead-id="${leadId}"]`);
                    leadContainers.forEach(container => {
                        // Find the parent lead card/row
                        let leadElement = container.closest('.bg-white') || container.closest('tr');
                        if (!leadElement) {
                            // Try finding by ID
                            leadElement = document.getElementById(`lead-card-${leadId}`) || 
                                           document.querySelector(`[onclick*="loadLeadDetail(${leadId})"]`);
                        }
                        
                        if (leadElement) {
                            // Update all status badges in this lead element
                            const statusBadges = leadElement.querySelectorAll('.status-badge');
                            statusBadges.forEach(badge => {
                                const statusText = badge.querySelector('span') || badge;
                                const statusLabels = {
                                    'new': 'New',
                                    'contacted': 'Contacted',
                                    'visit_scheduled': 'Visit Scheduled',
                                    'visit_completed': 'Visit Completed',
                                    'interested': 'Interested',
                                    'booked': 'Booked',
                                    'lost': 'Lost',
                                    'not_interested': 'Not Interested'
                                };
                                statusText.textContent = statusLabels[newStatus] || 'Updated';
                                
                                // Update styling
                                badge.className = badge.className.replace(/bg-\w+-100|bg-\w+-200|text-\w+-700|text-\w+-800|bg-\w+-50|border-\w+-200/g, '');
                                switch(newStatus) {
                                    case 'new':
                                        badge.classList.add('bg-gray-100', 'text-gray-800', 'border', 'border-gray-200');
                                        break;
                                    case 'contacted':
                                        badge.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
                                        break;
                                    case 'visit_scheduled':
                                        badge.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
                                        break;
                                    case 'visit_completed':
                                        badge.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                                        break;
                                    case 'interested':
                                        badge.classList.add('bg-purple-100', 'text-purple-800', 'border', 'border-purple-200');
                                        break;
                                    case 'booked':
                                        badge.classList.add('bg-purple-100', 'text-purple-800', 'border', 'border-purple-200');
                                        break;
                                    case 'lost':
                                        badge.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                                        break;
                                    default:
                                        badge.classList.add('bg-gray-100', 'text-gray-800', 'border', 'border-gray-200');
                                }
                            });
                            
                            // Update dropdown button text
                            const dropdownButtons = leadElement.querySelectorAll('button[onclick*="toggleStatusMenu"]');
                            dropdownButtons.forEach(button => {
                                const statusLabels = {
                                    'new': 'New',
                                    'contacted': 'Contacted',
                                    'visit_scheduled': 'Visit Scheduled',
                                    'visit_completed': 'Visit Completed',
                                    'interested': 'Interested',
                                    'booked': 'Booked',
                                    'lost': 'Lost',
                                    'not_interested': 'Not Interested'
                                };
                                const span = button.querySelector('span');
                                if (span) {
                                    span.textContent = statusLabels[newStatus] || 'Updated';
                                }
                            });
                        }
                    });
                    
                    // Show success message briefly
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    successMsg.textContent = data.message || 'Status updated successfully';
                    document.body.appendChild(successMsg);
                    setTimeout(() => successMsg.remove(), 3000);
                } else {
                    throw new Error(data?.error || 'Update failed');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || 'An error occurred. Please try again.');
                // Re-enable button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = originalText;
                }
            });
        });
    });
    
    // Track call clicks for metrics
    function trackCallClick(leadId) {
        // Get CSRF token from cookie
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         getCookie('csrftoken');
        
        fetch(`/leads/${leadId}/track-call-click/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Call click tracked successfully');
            }
        })
        .catch(error => {
            console.error('Error tracking call click:', error);
        });
    }
</script>
{% endblock %}
