{% extends 'base.html' %}
{% load tz %}
{% load lead_filters %}

{% block title %}{{ lead.name }} - Bridgio CRM{% endblock %}

{% block content %}
<!-- Tablet Split-View Detail (md: 768px-1024px) - For embedding in split view -->
<div class="hidden md:flex lg:hidden flex-col h-full">
    <div class="flex-1 overflow-y-auto p-4">
        <div class="space-y-4">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-xl font-heading font-bold text-olive-primary">{{ lead.name }}</h1>
                    {% if primary_association %}
                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full mt-2 {% if primary_association.status == 'visit_completed' %}bg-green-100 text-green-800{% elif primary_association.status == 'visit_scheduled' %}bg-blue-100 text-blue-800{% elif primary_association.status == 'interested' %}bg-purple-100 text-purple-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ primary_association.get_status_display }}
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="flex gap-2 flex-wrap">
                <a href="{{ tel_link }}" 
                   target="_blank"
                   class="inline-flex items-center px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium min-h-[48px]">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    Call
                </a>
                <button onclick="document.getElementById('call-modal').classList.remove('hidden')" 
                        class="inline-flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium min-h-[48px]">
                    Log Call
                </button>
                <button onclick="document.getElementById('notes-modal').classList.remove('hidden'); document.getElementById('notes-textarea-detail').value = '';" 
                        class="inline-flex items-center px-3 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition text-sm font-medium min-h-[48px]">
                    Add Note
                </button>
            </div>
            
            <!-- Client Information -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                <h3 class="font-heading font-bold mb-3 text-olive-primary">Client Information</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>Phone:</strong> <span class="font-mono">{{ phone_display }}</span></p>
                    <p><strong>Email:</strong> {{ lead.email|default:"-" }}</p>
                    <p><strong>Projects:</strong> 
                        {% if associations %}
                            {% for assoc in associations %}
                                <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">{{ assoc.project.name }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-gray-400">No projects assigned</span>
                        {% endif %}
                    </p>
                    <p><strong>Configurations:</strong> 
                        {% if lead.configurations.all %}
                            {% for config in lead.configurations.all %}
                                <span class="inline-block px-2 py-1 bg-green-100 text-green-800 rounded text-xs mr-1">{{ config.display_name }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-gray-400">None selected</span>
                        {% endif %}
                    </p>
                    <p><strong>Assigned To:</strong> 
                        {% if primary_association and primary_association.assigned_to %}
                            {{ primary_association.assigned_to.username }}
                        {% else %}
                            <span class="text-gray-400">Unassigned</span>
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <!-- Notes Section -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-heading font-bold text-olive-primary">Notes</h3>
                </div>
                <div id="notes-section">
                    {% if lead.notes %}
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        {% for note in lead.notes|split_by_timestamp %}
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                            {% if note.timestamp %}
                            <div class="text-xs text-gray-500 mb-1">--- {{ note.timestamp }} ({{ note.user }}) ---</div>
                            {% endif %}
                            <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ note.content }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500">No notes added yet.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Call History -->
            <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                <h3 class="font-heading font-bold mb-3 text-olive-primary">Call History</h3>
                {% if call_logs %}
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    {% for call in call_logs %}
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <p class="text-sm font-medium">{{ call.get_outcome_display }}</p>
                        <p class="text-xs text-gray-600">{{ call.created_at|date:"d M Y, h:i A" }} by {{ call.called_by.username }}</p>
                        {% if call.notes %}
                        <p class="text-sm text-gray-700 mt-1">{{ call.notes }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No call logs yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Mobile Panel View (‚â§768px) -->
<div id="mobile-lead-detail" class="fixed inset-0 bg-white z-[100] md:hidden flex flex-col transform transition-transform duration-300 translate-x-0" style="height: 100vh; height: 100dvh; overflow: hidden;">
    <!-- Sticky Header -->
    <div class="sticky top-0 bg-white border-b border-gray-200 p-4 z-10 shadow-sm safe-area-top flex-shrink-0">
        <div class="flex items-center justify-between mb-2">
            <div class="flex-1 min-w-0">
                <h1 class="text-xl font-heading font-bold text-olive-primary truncate">{{ lead.name }}</h1>
                <div class="flex items-center gap-2 mt-1">
                    {% if primary_association %}
                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full {% if primary_association.status == 'visit_completed' %}bg-green-100 text-green-800{% elif primary_association.status == 'visit_scheduled' %}bg-blue-100 text-blue-800{% elif primary_association.status == 'interested' %}bg-purple-100 text-purple-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ primary_association.get_status_display }}
                    </span>
                    {% else %}
                    <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">New</span>
                    {% endif %}
                </div>
            </div>
            <button onclick="window.history.back()" class="ml-3 p-2 text-gray-600 hover:text-gray-800 min-h-[48px] min-w-[48px] flex items-center justify-center">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto p-4 pb-24" style="overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; scroll-behavior: smooth;">
        <!-- Mobile Content -->
        <div class="space-y-4">
    
    <!-- Quick Actions Bar -->
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-3 sm:p-4">
        <div class="flex flex-wrap gap-2 sm:gap-3 items-center">
            <a href="{{ tel_link }}" 
               class="inline-flex items-center px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                <span class="hidden sm:inline">Call Now</span>
                <span class="sm:hidden">Call</span>
            </a>
            
            <!-- WhatsApp Templates -->
            <div class="relative inline-block">
                <button onclick="toggleWhatsAppMenu('whatsapp-menu-mobile')" 
                        class="inline-flex items-center px-3 sm:px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    <span class="hidden sm:inline">WhatsApp</span>
                    <span class="sm:hidden">WA</span>
                </button>
                <div id="whatsapp-menu-mobile" class="hidden absolute left-0 mt-2 w-48 sm:w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                    <div class="p-2">
                        {% if user.is_sourcing_manager %}
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=pretag" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üè∑Ô∏è Pretag Message</a>
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=at_site" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üìç At Site Message</a>
                        {% elif user.is_closing_manager or user.is_super_admin %}
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=closing_manager" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üìã Closing Manager Template</a>
                        {% else %}
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=intro" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üìù Intro Message</a>
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=project_details" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üè¢ Project Details</a>
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=booking_confirmation" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">‚úÖ Booking Confirmation</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <button onclick="document.getElementById('call-modal').classList.remove('hidden')" 
                    class="inline-flex items-center px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                <span class="hidden sm:inline">Log Call</span>
                <span class="sm:hidden">Call</span>
            </button>
            
            <button onclick="document.getElementById('reminder-modal').classList.remove('hidden')" 
                    class="inline-flex items-center px-3 sm:px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="hidden sm:inline">Set Reminder</span>
                <span class="sm:hidden">Reminder</span>
            </button>
            
            {% if user.is_closing_manager or user.is_super_admin %}
                {% if primary_association %}
                    {% if primary_association.status != 'lost' and primary_association.status != 'booked' %}
                        {% if not primary_association.is_pretagged or primary_association.phone_verified %}
                            <a href="{% url 'bookings:create' lead.id %}?project={{ primary_association.project_id }}" 
                               class="inline-flex items-center px-3 sm:px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm sm:text-base">
                                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="hidden sm:inline">Create Booking</span>
                                <span class="sm:hidden">Booking</span>
                            </a>
                        {% endif %}
                    {% endif %}
                    
                    {% if primary_association.status == 'visit_completed' %}
                        <button onclick="openRevisitModal()" 
                                class="inline-flex items-center px-3 sm:px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition text-sm sm:text-base">
                            <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            <span class="hidden sm:inline">Schedule Revisit</span>
                            <span class="sm:hidden">Revisit</span>
                        </button>
                    {% endif %}
                {% endif %}
                {% if lead.bookings.exists %}
                    <a href="{% url 'bookings:list' %}?search={{ lead.name }}" 
                       class="inline-flex items-center px-3 sm:px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm sm:text-base">
                        <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="hidden sm:inline">View Bookings ({{ lead.bookings.count }})</span>
                        <span class="sm:hidden">Bookings</span>
                    </a>
                {% endif %}
            {% endif %}
                </div>
            </div>
            
            <!-- Main Info (Mobile) -->
            <div class="space-y-4">
                <!-- Collapsible Section: Client Information -->
                <div class="bg-card-bg rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <button onclick="toggleMobileSection('client-info')" class="w-full flex justify-between items-center p-4 text-left">
                        <h3 class="font-heading font-bold text-olive-primary">Client Information</h3>
                        <svg id="client-info-icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="client-info-content" class="hidden px-4 pb-4">
                        <div class="space-y-3">
                            <p><strong>Phone:</strong> <span class="font-mono">{{ phone_display }}</span></p>
                            <p><strong>Email:</strong> {{ lead.email|default:"-" }}</p>
                            <p><strong>Projects:</strong> 
                                {% if associations %}
                                    {% for assoc in associations %}
                                        <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">{{ assoc.project.name }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-gray-400">No projects assigned</span>
                                {% endif %}
                            </p>
                            <p><strong>Configurations:</strong> 
                                {% if lead.configurations.all %}
                                    {% for config in lead.configurations.all %}
                                        <span class="inline-block px-2 py-1 bg-green-100 text-green-800 rounded text-xs mr-1">{{ config.display_name }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-gray-400">None selected</span>
                                {% endif %}
                            </p>
                            {% if lead.channel_partner %}
                            <p><strong>Channel Partner:</strong> 
                                <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">
                                    {{ lead.channel_partner.cp_name }} ({{ lead.channel_partner.firm_name }})
                                </span>
                            </p>
                            <p><strong>CP ID:</strong> {{ lead.channel_partner.cp_id|default:"-" }}</p>
                            <p><strong>CP Phone:</strong> {{ lead.channel_partner.phone|default:"-" }}</p>
                            {% endif %}
                            <p><strong>Assigned To:</strong> 
                                {% if primary_association and primary_association.assigned_to %}
                                    {{ primary_association.assigned_to.username }}
                                {% else %}
                                    <span class="text-gray-400">Unassigned</span>
                                {% endif %}
                            </p>
                            <p><strong>Created By:</strong> {{ lead.created_by.username|default:"-" }}</p>
                            <p><strong>Created At:</strong> {{ lead.created_at|date:"d M Y, h:i A" }}</p>
                            {% if primary_association and primary_association.is_pretagged %}
                            <p><strong>Pretag Status:</strong> {{ primary_association.get_pretag_status_display|default:"-" }}</p>
                            <p><strong>Phone Verified:</strong> {% if primary_association.phone_verified %}‚úì Yes{% else %}‚úó No{% endif %}</p>
                            {% if primary_association.phone_verified and primary_association.assigned_to %}
                            <p><strong>Verified By:</strong> {{ primary_association.assigned_to.username }} ({{ primary_association.project.name }})</p>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Collapsible Section: Notes -->
                <div class="bg-card-bg rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <button onclick="toggleMobileSection('notes')" class="w-full flex justify-between items-center p-4 text-left">
                        <h3 class="font-heading font-bold text-olive-primary">Notes</h3>
                        <svg id="notes-icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="notes-content" class="hidden px-4 pb-4">
                        <div class="mb-3">
                            <button onclick="document.getElementById('notes-modal').classList.remove('hidden'); document.getElementById('notes-textarea-detail').value = '';" 
                                    class="w-full px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition text-sm min-h-[48px]">
                                + Add Note
                            </button>
                        </div>
                        <div id="notes-section">
                        {% if lead.notes %}
                        <div class="space-y-3">
                            {% for note in lead.notes|split_by_timestamp %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                {% if note.timestamp %}
                                <div class="text-xs text-gray-500 mb-2">--- {{ note.timestamp }} ({{ note.user }}) ---</div>
                                {% endif %}
                                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ note.content }}</p>
                            </div>
                            {% endfor %}
                        </div>
                            {% else %}
                            <p class="text-sm text-gray-500 mb-3">No notes added yet.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Collapsible Section: OTP -->
                <div class="bg-card-bg rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <button onclick="toggleMobileSection('otp')" class="w-full flex justify-between items-center p-4 text-left">
                        <h3 class="font-heading font-bold text-olive-primary">OTP Verification</h3>
                        <svg id="otp-icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="otp-content" class="hidden px-4 pb-4">
                        {% include 'leads/otp_section.html' %}
                    </div>
                </div>
                
                <!-- Collapsible Section: Call History -->
                <div class="bg-card-bg rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <button onclick="toggleMobileSection('call-history')" class="w-full flex justify-between items-center p-4 text-left">
                        <h3 class="font-heading font-bold text-olive-primary">Call History</h3>
                        <svg id="call-history-icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="call-history-content" class="hidden px-4 pb-4">
                        {% if call_logs %}
                <div class="space-y-3">
                    {% for call in call_logs %}
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium">{{ call.get_outcome_display }}</p>
                                <p class="text-xs text-gray-600">{{ call.created_at|date:"d M Y, h:i A" }} by {{ call.called_by.username }}</p>
                                {% if call.notes %}
                                <p class="text-sm text-gray-700 mt-1">{{ call.notes }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                        {% else %}
                        <p class="text-gray-500 text-sm">No call logs yet.</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Collapsible Section: Reminders -->
                <div class="bg-card-bg rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <button onclick="toggleMobileSection('reminders')" class="w-full flex justify-between items-center p-4 text-left">
                        <h3 class="font-heading font-bold text-olive-primary">Upcoming Reminders</h3>
                        <svg id="reminders-icon" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div id="reminders-content" class="hidden px-4 pb-4">
                {% if reminders %}
                <div class="space-y-3">
                    {% for reminder in reminders %}
                    <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium">{{ reminder.reminder_date|date:"d M Y, h:i A" }}</p>
                                {% if reminder.notes %}
                                <p class="text-sm text-gray-700 mt-1">{{ reminder.notes }}</p>
                                {% endif %}
                            </div>
                            <form method="post" action="{% url 'leads:complete_reminder' lead.id reminder.id %}" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="text-xs text-green-600 hover:text-green-700">‚úì Complete</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                        {% else %}
                        <p class="text-gray-500 text-sm">No active reminders.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Fixed Action Buttons (Mobile) -->
    <div class="sticky bottom-0 bg-white border-t border-gray-200 p-4 z-10 shadow-lg">
        <div class="flex gap-3">
            <a href="{{ tel_link }}" 
               target="_blank"
               class="flex-1 inline-flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-base font-medium min-h-[56px]">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Call
            </a>
            {% if lead.email %}
            <a href="mailto:{{ lead.email }}" 
               class="flex-1 inline-flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-base font-medium min-h-[56px]">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                Email
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Desktop View (‚â•769px) -->
<div class="hidden md:block max-w-6xl mx-auto space-y-4 sm:space-y-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-0">
        <h1 class="text-2xl sm:text-3xl font-heading font-bold text-olive-primary">{{ lead.name }}</h1>
        <a href="{% url 'leads:list' %}" class="text-sm sm:text-base text-olive-primary hover:text-olive-secondary">‚Üê Back to Leads</a>
    </div>
    
    <!-- Quick Actions Bar -->
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-3 sm:p-4">
        <div class="flex flex-wrap gap-2 sm:gap-3 items-center">
            <a href="{{ tel_link }}" 
               class="inline-flex items-center px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm sm:text-base">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                <span class="hidden sm:inline">Call Now</span>
                <span class="sm:hidden">Call</span>
            </a>
            
            <!-- WhatsApp Templates -->
            <div class="relative inline-block">
                <button onclick="toggleWhatsAppMenu('whatsapp-menu-mobile')" 
                        class="inline-flex items-center px-3 sm:px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm sm:text-base">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    <span class="hidden sm:inline">WhatsApp</span>
                    <span class="sm:hidden">WA</span>
                </button>
                <div id="whatsapp-menu-mobile" class="hidden absolute left-0 mt-2 w-48 sm:w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                    <div class="p-2">
                        {% if user.is_sourcing_manager %}
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=pretag" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üè∑Ô∏è Pretag Message</a>
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=at_site" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üìç At Site Message</a>
                        {% elif user.is_closing_manager or user.is_super_admin %}
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=closing_manager" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üìã Closing Manager Template</a>
                        {% else %}
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=intro" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üìù Intro Message</a>
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=project_details" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">üè¢ Project Details</a>
                            <a href="{% url 'leads:whatsapp' lead.id %}?template=booking_confirmation" 
                               target="_blank"
                               class="block px-3 sm:px-4 py-2 hover:bg-gray-100 rounded text-xs sm:text-sm">‚úÖ Booking Confirmation</a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <button onclick="document.getElementById('call-modal').classList.remove('hidden')" 
                    class="inline-flex items-center px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                <span class="hidden sm:inline">Log Call</span>
                <span class="sm:hidden">Call</span>
            </button>
            
            <button onclick="document.getElementById('reminder-modal').classList.remove('hidden')" 
                    class="inline-flex items-center px-3 sm:px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition text-sm sm:text-base">
                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="hidden sm:inline">Set Reminder</span>
                <span class="sm:hidden">Reminder</span>
            </button>
            
            {% if user.is_closing_manager or user.is_super_admin %}
                {% if primary_association %}
                    {% if primary_association.status != 'lost' and primary_association.status != 'booked' %}
                        {% if not primary_association.is_pretagged or primary_association.phone_verified %}
                            <a href="{% url 'bookings:create' lead.id %}?project={{ primary_association.project_id }}" 
                               class="inline-flex items-center px-3 sm:px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm sm:text-base">
                                <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="hidden sm:inline">Create Booking</span>
                                <span class="sm:hidden">Booking</span>
                            </a>
                        {% endif %}
                    {% endif %}
                {% endif %}
                {% if lead.bookings.exists %}
                    <a href="{% url 'bookings:list' %}?search={{ lead.name }}" 
                       class="inline-flex items-center px-3 sm:px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition text-sm sm:text-base">
                        <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="hidden sm:inline">View Bookings ({{ lead.bookings.count }})</span>
                        <span class="sm:hidden">Bookings</span>
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
        <!-- Main Info -->
        <div class="lg:col-span-2 space-y-4 sm:space-y-6">
            <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-4 sm:p-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <h3 class="font-heading font-bold mb-3 text-olive-primary">Client Information</h3>
                        {% if primary_association and primary_association.is_pretagged and not primary_association.phone_verified %}
                            <p><strong>Phone:</strong> <span class="text-gray-400">Hidden (Pretagged - Verify OTP to view)</span></p>
                        {% else %}
                            <p><strong>Phone:</strong> <span class="font-mono">{{ phone_display }}</span></p>
                        {% endif %}
                        <p><strong>Email:</strong> {{ lead.email|default:"-" }}</p>
                        <p><strong>Projects:</strong> 
                            {% if associations %}
                                {% for assoc in associations %}
                                    <span class="inline-block px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-1">{{ assoc.project.name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-gray-400">No projects assigned</span>
                            {% endif %}
                        </p>
                        <p><strong>Status:</strong> 
                            {% if primary_association %}
                                {{ primary_association.get_status_display }}
                            {% else %}
                                New
                            {% endif %}
                        </p>
                        <p><strong>Configurations:</strong> 
                            {% if lead.configurations.all %}
                                {% for config in lead.configurations.all %}
                                    <span class="inline-block px-2 py-1 bg-green-100 text-green-800 rounded text-xs mr-1">{{ config.display_name }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-gray-400">None selected</span>
                            {% endif %}
                        </p>
                        {% if lead.channel_partner %}
                        <p><strong>Channel Partner:</strong> 
                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">
                                {{ lead.channel_partner.cp_name }} ({{ lead.channel_partner.firm_name }})
                            </span>
                        </p>
                        <p><strong>CP ID:</strong> {{ lead.channel_partner.cp_id|default:"-" }}</p>
                        <p><strong>CP Phone:</strong> {{ lead.channel_partner.phone|default:"-" }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="font-heading font-bold mb-3 text-olive-primary">Assignment</h3>
                        <p><strong>Assigned To:</strong> 
                            {% if primary_association and primary_association.assigned_to %}
                                {{ primary_association.assigned_to.username }}
                            {% else %}
                                <span class="text-gray-400">Unassigned</span>
                            {% endif %}
                        </p>
                        <p><strong>Created By:</strong> {{ lead.created_by.username|default:"-" }}</p>
                        <p><strong>Created At:</strong> {{ lead.created_at|date:"d M Y, h:i A" }}</p>
                        {% if primary_association and primary_association.is_pretagged %}
                        <p><strong>Pretag Status:</strong> {{ primary_association.get_pretag_status_display|default:"-" }}</p>
                        <p><strong>Phone Verified:</strong> {% if primary_association.phone_verified %}‚úì Yes{% else %}‚úó No{% endif %}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Complete Lead Data Section -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-heading font-bold text-olive-primary">Complete Lead Information</h3>
                        {% if can_edit_lead_data %}
                        <button onclick="toggleEditMode()" id="edit-mode-btn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                            ‚úèÔ∏è Edit Data
                        </button>
                        {% endif %}
                    </div>
                    
                    <div id="lead-data-display" class="space-y-4">
                        <!-- Personal Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Personal Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div><strong>Full Name:</strong> <span id="display-name">{{ lead.name|default:"-" }}</span></div>
                                <div><strong>Phone:</strong> <span id="display-phone">{{ phone_display }}</span></div>
                                <div><strong>Email:</strong> <span id="display-email">{{ lead.email|default:"-" }}</span></div>
                                <div><strong>Alternate Phone:</strong> <span id="display-alt-phone">{{ lead.alternate_phone|default:"-" }}</span></div>
                                <div><strong>WhatsApp:</strong> <span id="display-whatsapp">{{ lead.whatsapp_number|default:"-" }}</span></div>
                                <div><strong>Address:</strong> <span id="display-address">{{ lead.address|default:"-" }}</span></div>
                            </div>
                        </div>
                        
                        <!-- Budget & Preferences -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Budget & Preferences</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div><strong>Budget:</strong> 
                                    <span id="display-budget">
                                        {% if lead.budget %}
                                            {% if lead.budget >= 10000000 %}
                                                {% widthratio lead.budget 10000000 1 as budget_cr %}
                                                ‚Çπ{{ budget_cr }} Cr
                                            {% else %}
                                                {% widthratio lead.budget 100000 1 as budget_l %}
                                                ‚Çπ{{ budget_l }} L
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                </div>
                                <div><strong>Preferred Configuration:</strong> 
                                    <span id="display-configurations">
                                        {% if lead.configurations.all %}
                                            {% for config in lead.configurations.all %}
                                                {{ config.display_name }}{% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                </div>
                                <div><strong>Preferred Project:</strong> <span id="display-preferred-project">{{ lead.preferred_project.name|default:"-" }}</span></div>
                                <div><strong>Lead Source:</strong> <span id="display-lead-source">{{ lead.get_visit_source_display|default:"-" }}</span></div>
                            </div>
                        </div>
                        
                        <!-- Professional Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-700 mb-3">Professional Information</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div><strong>Occupation:</strong> <span id="display-occupation">{{ lead.occupation|default:"-" }}</span></div>
                                <div><strong>Company:</strong> <span id="display-company">{{ lead.company_name|default:"-" }}</span></div>
                                <div><strong>Annual Income:</strong> <span id="display-income">{{ lead.annual_income|default:"-" }}</span></div>
                                <div><strong>Work Address:</strong> <span id="display-work-address">{{ lead.work_address|default:"-" }}</span></div>
                            </div>
                        </div>
                        
                        <!-- Data Source Attribution -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-700 mb-3">Data Source & Attribution</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                <div><strong>Data Source:</strong> 
                                    <span id="display-data-source">
                                        {% if lead.channel_partner %}
                                            <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">Channel Partner</span>
                                        {% else %}
                                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">Owner Data</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div><strong>Created By:</strong> <span id="display-created-by">{{ lead.created_by.username|default:"-" }}</span></div>
                                <div><strong>Created At:</strong> <span id="display-created-at">{{ lead.created_at|date:"d M Y, h:i A" }}</span></div>
                                <div><strong>Last Updated:</strong> <span id="display-updated-at">{{ lead.updated_at|date:"d M Y, h:i A" }}</span></div>
                                {% if lead.channel_partner %}
                                <div><strong>Channel Partner:</strong> <span id="display-cp-name">{{ lead.channel_partner.cp_name }} ({{ lead.channel_partner.firm_name }})</span></div>
                                <div><strong>CP ID:</strong> <span id="display-cp-id">{{ lead.channel_partner.cp_unique_id|default:"-" }}</span></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Completion Status -->
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <h4 class="font-semibold text-yellow-700 mb-3">Data Completion Status</h4>
                            <div class="space-y-2 text-sm">
                                {% with completion_status=lead.get_completion_status %}
                                <div class="flex justify-between">
                                    <span>Profile Completion:</span>
                                    <span class="font-semibold {% if completion_status.percentage >= 80 %}text-green-600{% elif completion_status.percentage >= 50 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                        {{ completion_status.percentage }}%
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: {{ completion_status.percentage }}%"></div>
                                </div>
                                {% if completion_status.missing_fields %}
                                <div class="mt-2">
                                    <strong>Missing Fields:</strong>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        {% for field in completion_status.missing_fields %}
                                        <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs">{{ field }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Edit Form (Hidden by default) -->
                    <div id="lead-data-edit" class="hidden space-y-4">
                        <form id="lead-data-form" method="post" action="{% url 'leads:update_lead_data' lead.id %}">
                            {% csrf_token %}
                            <!-- Personal Information -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3">Personal Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                                        <input type="text" name="name" id="edit-name" value="{{ lead.name }}" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Phone *</label>
                                        <input type="tel" name="phone" id="edit-phone" value="{{ lead.phone }}" required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" name="email" id="edit-email" value="{{ lead.email }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Alternate Phone</label>
                                        <input type="tel" name="alternate_phone" id="edit-alt-phone" value="{{ lead.alternate_phone }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number</label>
                                        <input type="tel" name="whatsapp_number" id="edit-whatsapp" value="{{ lead.whatsapp_number }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                        <textarea name="address" id="edit-address" rows="2"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{{ lead.address }}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Budget & Preferences -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3">Budget & Preferences</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Budget</label>
                                        <select name="budget" id="edit-budget"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">Select Budget</option>
                                            {% for value, label in budget_choices %}
                                            <option value="{{ value }}" {% if lead.budget == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Lead Source</label>
                                        <select name="visit_source" id="edit-lead-source"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                            <option value="">Select Source</option>
                                            {% for value, label in lead_source_choices %}
                                            <option value="{{ value }}" {% if lead.visit_source == value %}selected{% endif %}>{{ label }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Professional Information -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-700 mb-3">Professional Information</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Occupation</label>
                                        <input type="text" name="occupation" id="edit-occupation" value="{{ lead.occupation }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                                        <input type="text" name="company_name" id="edit-company" value="{{ lead.company_name }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Annual Income</label>
                                        <input type="text" name="annual_income" id="edit-income" value="{{ lead.annual_income }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Work Address</label>
                                        <textarea name="work_address" id="edit-work-address" rows="2"
                                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{{ lead.work_address }}</textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="toggleEditMode()"
                                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm">
                                    Cancel
                                </button>
                                <button type="submit"
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm">
                                    üíæ Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-heading font-bold text-olive-primary">Notes</h3>
                        <button onclick="document.getElementById('notes-modal').classList.remove('hidden'); document.getElementById('notes-textarea-detail').value = '';" 
                                class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition text-sm">
                            + Add Note
                        </button>
                    </div>
                    <div id="notes-section">
                        {% if lead.notes %}
                        <div class="space-y-3">
                            {% for note in lead.notes|split_by_timestamp %}
                            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                                {% if note.timestamp %}
                                <div class="text-xs text-gray-500 mb-2">--- {{ note.timestamp }} ({{ note.user }}) ---</div>
                                {% endif %}
                                <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ note.content }}</p>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-sm text-gray-500 mb-3">No notes added yet.</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- OTP Section -->
                <div class="mt-6">
                    {% include 'leads/otp_section.html' %}
                </div>
            </div>
            
            <!-- Call History -->
            <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-6">
                <h3 class="font-heading font-bold mb-4 text-olive-primary">Call History</h3>
                {% if call_logs %}
                <div class="space-y-3">
                    {% for call in call_logs %}
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium">{{ call.get_outcome_display }}</p>
                                <p class="text-xs text-gray-600">{{ call.created_at|date:"d M Y, h:i A" }} by {{ call.called_by.username }}</p>
                                {% if call.notes %}
                                <p class="text-sm text-gray-700 mt-1">{{ call.notes }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No call logs yet.</p>
                {% endif %}
            </div>
            
            <!-- Reminders -->
            <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-6">
                <h3 class="font-heading font-bold mb-4 text-olive-primary">Upcoming Reminders</h3>
                {% if reminders %}
                <div class="space-y-3">
                    {% for reminder in reminders %}
                    <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium">{{ reminder.reminder_date|date:"d M Y, h:i A" }}</p>
                                {% if reminder.notes %}
                                <p class="text-sm text-gray-700 mt-1">{{ reminder.notes }}</p>
                                {% endif %}
                            </div>
                            <form method="post" action="{% url 'leads:complete_reminder' lead.id reminder.id %}" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="text-xs text-green-600 hover:text-green-700">‚úì Complete</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No active reminders.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Quick Stats -->
            <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-6">
                <h3 class="font-heading font-bold mb-4 text-olive-primary">Quick Stats</h3>
                <div class="space-y-3">
                    <div>
                        <p class="text-xs text-gray-600">Total Calls</p>
                        <p class="text-2xl font-bold text-olive-primary">{{ call_logs|length }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-600">Active Reminders</p>
                        <p class="text-2xl font-bold text-yellow-600">{{ reminders|length }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Call Log Modal -->
<div id="call-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Log Call</h3>
            <button onclick="document.getElementById('call-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <form method="post" action="{% url 'leads:log_call' lead.id %}" hx-post="{% url 'leads:log_call' lead.id %}" hx-target="#call-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Call Outcome *</label>
                    <select name="outcome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">Select Outcome</option>
                        <option value="connected">Connected</option>
                        <option value="not_reachable">Not Reachable</option>
                        <option value="switched_off">Switched Off</option>
                        <option value="wrong_number">Wrong Number</option>
                        <option value="busy">Busy</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Next Action</label>
                    <select name="next_action" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="">No Action</option>
                        <option value="callback">Callback</option>
                        <option value="send_whatsapp">Send WhatsApp</option>
                        <option value="schedule_visit">Schedule Visit</option>
                        <option value="not_interested">Mark as Not Interested</option>
                    </select>
                </div>
                <div id="callback-date" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Callback Date & Time</label>
                    <input type="datetime-local" name="reminder_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
                <div id="call-result"></div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('call-modal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Log Call</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Notes Modal -->
<div id="notes-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Add Note</h3>
            <button onclick="document.getElementById('notes-modal').classList.add('hidden'); document.getElementById('notes-textarea-detail').value = '';" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <form method="post" action="{% url 'leads:update_notes' lead.id %}" hx-post="{% url 'leads:update_notes' lead.id %}" hx-target="#notes-section" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes *</label>
                    <textarea name="notes" id="notes-textarea-detail" rows="6" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary" placeholder="Add important notes about conversations, preferences, follow-ups, etc."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Add important notes about conversations, preferences, follow-ups, etc.</p>
                </div>
                <div id="notes-result"></div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('notes-modal').classList.add('hidden'); document.getElementById('notes-textarea-detail').value = '';" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Save Notes</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Reminder Modal -->
<div id="reminder-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Set Reminder</h3>
            <button onclick="document.getElementById('reminder-modal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">‚úï</button>
        </div>
        <form method="post" action="{% url 'leads:create_reminder' lead.id %}" hx-post="{% url 'leads:create_reminder' lead.id %}" hx-target="#reminder-result" hx-swap="innerHTML">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reminder Type</label>
                    <select name="reminder_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                        <option value="callback">Callback</option>
                        <option value="payment_followup">Payment Follow-up</option>
                        <option value="visit_reminder">Visit Reminder</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date & Time *</label>
                    <input type="datetime-local" name="reminder_date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea name="notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"></textarea>
                </div>
                <div id="reminder-result"></div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('reminder-modal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary">Create Reminder</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // WhatsApp menu toggle function
    function toggleWhatsAppMenu(menuId) {
        const menu = document.getElementById(menuId);
        if (menu) {
            menu.classList.toggle('hidden');
        }
    }
    
    // Close WhatsApp menu when clicking outside
    document.addEventListener('click', function(event) {
        const whatsappMenus = ['whatsapp-menu-desktop', 'whatsapp-menu-mobile'];
        whatsappMenus.forEach(menuId => {
            const menu = document.getElementById(menuId);
            const button = event.target.closest('button[onclick*="' + menuId + '"]');
            if (menu && !menu.contains(event.target) && !button) {
                menu.classList.add('hidden');
            }
        });
    });
    
    // Show/hide callback date field
    const nextActionSelect = document.querySelector('select[name="next_action"]');
    if (nextActionSelect) {
        nextActionSelect.addEventListener('change', function() {
            const callbackDate = document.getElementById('callback-date');
            if (callbackDate) {
                if (this.value === 'callback') {
                    callbackDate.classList.remove('hidden');
                } else {
                    callbackDate.classList.add('hidden');
                }
            }
        });
    }
    
    // Close modals on outside click
    document.getElementById('call-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
    
    document.getElementById('reminder-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
        }
    });
    
    document.getElementById('notes-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.add('hidden');
            const textarea = document.getElementById('notes-textarea-detail');
            if (textarea) textarea.value = '';
        }
    });
    
    // Handle closeNotesModal event from HTMX
    document.body.addEventListener('closeNotesModal', function() {
        const modal = document.getElementById('notes-modal');
        const textarea = document.getElementById('notes-textarea-detail');
        if (modal) modal.classList.add('hidden');
        if (textarea) textarea.value = '';
    });
    
    // Hide base header and prevent scrolling when mobile panel is active
    const mobilePanel = document.getElementById('mobile-lead-detail');
    const mainHeader = document.getElementById('main-header');
    const mainContent = document.getElementById('main-content');
    
    if (mobilePanel && window.innerWidth < 768) {
        // Hide base header and prevent main content scrolling
        if (mainHeader) mainHeader.style.display = 'none';
        if (mainContent) {
            mainContent.style.overflow = 'hidden';
            mainContent.style.height = '100vh';
        }
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }
    
    // Cleanup on window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth >= 768) {
            if (mainHeader) mainHeader.style.display = '';
            if (mainContent) {
                mainContent.style.overflow = '';
                mainContent.style.height = '';
            }
            document.body.style.overflow = '';
        }
    });
    
    // Revisit Modal Functions
    function openRevisitModal() {
        document.getElementById('revisit-modal').classList.remove('hidden');
    }
    
    function closeRevisitModal() {
        document.getElementById('revisit-modal').classList.add('hidden');
    }
    
    function scheduleRevisit() {
        const visitDate = document.getElementById('revisit-date').value;
        const visitTime = document.getElementById('revisit-time').value;
        const timeFrame = document.getElementById('revisit-timeframe').value;
        const reason = document.getElementById('revisit-reason').value;
        
        if (!visitDate || !visitTime) {
            alert('Please select date and time for the revisit');
            return;
        }
        
        fetch('{% url "leads:schedule_revisit" lead.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'project_id': '{{ primary_association.project.id }}',
                'visit_date': visitDate,
                'visit_time': visitTime,
                'time_frame': timeFrame,
                'revisit_reason': reason
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeRevisitModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error scheduling revisit');
        });
    }
</script>

<!-- Revisit Modal -->
<div id="revisit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-heading font-bold text-olive-primary">Schedule Revisit</h3>
            <button onclick="closeRevisitModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">Visit Date *</label>
                <input type="date" id="revisit-date" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">Visit Time *</label>
                <input type="time" id="revisit-time" required
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">Time Frame</label>
                <select id="revisit-timeframe"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary">
                    <option value="">Select Time Frame</option>
                    <option value="morning">Morning</option>
                    <option value="afternoon">Afternoon</option>
                    <option value="evening">Evening</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">Reason for Revisit</label>
                <textarea id="revisit-reason" rows="3"
                          placeholder="E.g., Client wants to see model flat, discuss payment plan, etc."
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-primary"></textarea>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <p class="text-sm text-blue-800">
                    <strong>Note:</strong> Revisits do not require OTP verification. The client will be marked as verified automatically.
                </p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="scheduleRevisit()"
                        class="flex-1 bg-olive-primary text-white px-6 py-2 rounded-lg hover:bg-olive-secondary transition font-medium">
                    Schedule Revisit
                </button>
                <button onclick="closeRevisitModal()"
                        class="flex-1 bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition font-medium">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function toggleEditMode() {
    const displaySection = document.getElementById('lead-data-display');
    const editSection = document.getElementById('lead-data-edit');
    const editBtn = document.getElementById('edit-mode-btn');
    
    if (displaySection.classList.contains('hidden')) {
        // Switch to display mode
        displaySection.classList.remove('hidden');
        editSection.classList.add('hidden');
        editBtn.innerHTML = '‚úèÔ∏è Edit Data';
        editBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        editBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
    } else {
        // Switch to edit mode
        displaySection.classList.add('hidden');
        editSection.classList.remove('hidden');
        editBtn.innerHTML = '‚ùå Cancel Edit';
        editBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        editBtn.classList.add('bg-red-600', 'hover:bg-red-700');
    }
}

// Handle form submission with AJAX
document.getElementById('lead-data-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Disable submit button and show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Saving...';
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update display fields with new data
            updateDisplayFields(data.updated_data);
            
            // Show success message
            showNotification('Lead data updated successfully!', 'success');
            
            // Switch back to display mode
            toggleEditMode();
            
            // Reload page after a short delay to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            throw new Error(data.error || 'Update failed');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(error.message || 'An error occurred. Please try again.', 'error');
    })
    .finally(() => {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

function updateDisplayFields(data) {
    // Update display fields with new data
    if (data.name) document.getElementById('display-name').textContent = data.name;
    if (data.phone) document.getElementById('display-phone').textContent = data.phone;
    if (data.email) document.getElementById('display-email').textContent = data.email || '-';
    if (data.alternate_phone) document.getElementById('display-alt-phone').textContent = data.alternate_phone || '-';
    if (data.whatsapp_number) document.getElementById('display-whatsapp').textContent = data.whatsapp_number || '-';
    if (data.address) document.getElementById('display-address').textContent = data.address || '-';
    if (data.budget_display) document.getElementById('display-budget').innerHTML = data.budget_display;
    if (data.lead_source_display) document.getElementById('display-lead-source').textContent = data.lead_source_display || '-';
    if (data.occupation) document.getElementById('display-occupation').textContent = data.occupation || '-';
    if (data.company) document.getElementById('display-company').textContent = data.company || '-';
    if (data.annual_income) document.getElementById('display-income').textContent = data.annual_income || '-';
    if (data.work_address) document.getElementById('display-work-address').textContent = data.work_address || '-';
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>

{% endblock %}


