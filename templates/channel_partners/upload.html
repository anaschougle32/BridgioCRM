{% extends 'base.html' %}

{% block title %}Import Channel Partners - Bridgio CRM{% endblock %}

{% block page_title %}Import Channel Partners{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
        <h2 class="text-2xl font-heading font-semibold text-olive-primary mb-6">Upload Channel Partners</h2>
        
        <!-- Step Indicators -->
        <div class="flex justify-center mb-8">
            <div class="flex items-center space-x-4">
                <div id="step-1-indicator" class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-olive-primary text-white flex items-center justify-center font-bold">1</div>
                    <span class="ml-2 text-sm font-medium">Upload File</span>
                </div>
                <div class="w-16 h-0.5 bg-gray-300"></div>
                <div id="step-2-indicator" class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">2</div>
                    <span class="ml-2 text-sm font-medium">Map Fields</span>
                </div>
                <div class="w-16 h-0.5 bg-gray-300"></div>
                <div id="step-3-indicator" class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">3</div>
                    <span class="ml-2 text-sm font-medium">Review & Import</span>
                </div>
            </div>
        </div>
        
        <!-- Step 1: Upload File -->
        <div id="step-1" class="bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
            <h2 class="text-2xl font-heading font-semibold text-olive-primary mb-4">Step 1: Upload File</h2>
            
            <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-olive-primary transition cursor-pointer">
                <input type="file" id="file-input" accept=".csv,.xlsx,.xls" class="hidden">
                <div class="flex flex-col items-center">
                    <svg class="w-16 h-16 text-yellow-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                    </svg>
                    <p class="text-lg font-medium mb-2">Drag and drop your file here</p>
                    <p class="text-gray-500 mb-4">or</p>
                    <button type="button" onclick="document.getElementById('file-input').click()" 
                            class="px-6 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">
                        Browse Files
                    </button>
                    <p class="text-sm text-gray-500 mt-4">Supported formats: .xlsx, .xls, .csv (Max 10MB)</p>
                </div>
            </div>
            
            <div id="file-info" class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <div>
                            <p id="file-name" class="font-medium text-green-900"></p>
                            <p id="file-size" class="text-sm text-green-700"></p>
                        </div>
                    </div>
                    <button onclick="clearFile()" class="text-red-600 hover:text-red-800">Remove</button>
                </div>
            </div>
            
            <div class="mt-6 flex justify-end">
                <button id="next-to-mapping" onclick="proceedToMapping()" disabled
                        class="px-6 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition disabled:bg-gray-300 disabled:cursor-not-allowed">
                    Next: Map Fields ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 2: Map Fields -->
        <div id="step-2" class="hidden bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
            <h2 class="text-2xl font-heading font-semibold text-olive-primary mb-4">Step 2: Map Fields</h2>
            
            <div id="mapping-container" class="space-y-4">
                <!-- Mapping table will be loaded here -->
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="goBackToStep1()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    ‚Üê Back
                </button>
                <button type="button" onclick="proceedToReview()" 
                        class="px-6 py-2 bg-olive-primary text-white rounded-lg hover:bg-olive-secondary transition">
                    Next: Review ‚Üí
                </button>
            </div>
        </div>
        
        <!-- Step 3: Review & Import -->
        <div id="step-3" class="hidden bg-card-bg rounded-lg shadow-premium border border-border-light p-8">
            <h2 class="text-2xl font-heading font-semibold text-olive-primary mb-4">Step 3: Review & Import</h2>
            
            <div id="preview-container" class="space-y-4">
                <!-- Preview will be loaded here -->
            </div>
            
            <div class="mt-6 flex justify-between">
                <button type="button" onclick="goBackToStep2()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    ‚Üê Back
                </button>
                <form id="final-upload-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="final-mapping" name="mapping" />
                    <input type="hidden" id="final-session-id" name="session_id" />
                    <button type="submit" 
                            class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        ‚úÖ Import CPs
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Info Boxes -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="font-semibold text-blue-900 mb-2">üìã Required Fields</h3>
            <ul class="text-sm text-blue-800 space-y-1">
                <li><strong>Name</strong> (cp_name) - Required</li>
                <li><strong>Firm Name</strong> (firm_name) - Required</li>
                <li><strong>Phone Number</strong> (phone) - Required</li>
            </ul>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="font-semibold text-yellow-900 mb-2">‚ÑπÔ∏è Auto-Mapping</h3>
            <p class="text-sm text-yellow-800">
                The system automatically detects column names. You can manually adjust mappings if needed.
            </p>
        </div>
    </div>
</div>

<script>
let selectedFile = null;
let fileSessionId = null;

// Drag and Drop Handlers
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-olive-secondary', 'bg-olive-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-olive-secondary', 'bg-olive-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-olive-secondary', 'bg-olive-50');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileSelect(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    // Validate file type
    const validTypes = ['.xlsx', '.xls', '.csv'];
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();
    if (!validTypes.includes(fileExt)) {
        alert('Please upload a valid Excel or CSV file (.xlsx, .xls, .csv)');
        return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('File size must be less than 10MB');
        return;
    }
    
    selectedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    document.getElementById('file-info').classList.remove('hidden');
    
    // Enable next button
    document.getElementById('next-to-mapping').disabled = false;
}

function clearFile() {
    selectedFile = null;
    fileInput.value = '';
    document.getElementById('file-info').classList.add('hidden');
    document.getElementById('next-to-mapping').disabled = true;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Step Navigation
function proceedToMapping() {
    if (!selectedFile) {
        alert('Please select a file');
        return;
    }
    
    // Upload file and get mapping
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('action', 'analyze');
    
    fetch('{% url "channel_partners:upload_analyze" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fileSessionId = data.session_id;
            displayMapping(data.headers, data.mapping);
            showStep(2);
        } else {
            alert('Error: ' + (data.error || 'Failed to analyze file'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while analyzing the file');
    });
}

function displayMapping(headers, autoMapping) {
    const container = document.getElementById('mapping-container');
    // CP field options
    const fieldOptions = {
        'name': 'Name (Required)',
        'firm_name': 'Firm Name (Required)',
        'phone': 'Phone Number (Required)',
        'phone2': 'Phone Number 2',
        'locality': 'Locality',
        'team_size': 'Team Size',
        'owner_name': 'Owner Name',
        'owner_number': 'Owner Number',
        'rera_id': 'RERA ID',
        'status': 'Status',
    };
    
    let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Detected Column</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Map to Field</th></tr></thead><tbody>';
    
    headers.forEach((header, index) => {
        const mappedField = autoMapping[header] || '';
        html += `<tr class="bg-white border-b"><td class="px-4 py-3 text-sm text-gray-900">${header}</td><td class="px-4 py-3"><select name="mapping_${index}" data-header="${header}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-olive-primary"><option value="">-- Ignore --</option>`;
        
        Object.entries(fieldOptions).forEach(([value, label]) => {
            const selected = mappedField === value ? 'selected' : '';
            html += `<option value="${value}" ${selected}>${label}</option>`;
        });
        
        html += `</select></td></tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function proceedToReview() {
    // Collect mapping
    const mapping = {};
    document.querySelectorAll('[name^="mapping_"]').forEach(select => {
        const header = select.getAttribute('data-header');
        const field = select.value;
        if (field) {
            mapping[header] = field;
        }
    });
    
    // Validate required fields
    const requiredFields = ['name', 'firm_name', 'phone'];
    const mappedFields = Object.values(mapping);
    const missingFields = requiredFields.filter(field => !mappedFields.includes(field));
    
    if (missingFields.length > 0) {
        alert(`Please map the required fields: ${missingFields.join(', ')}`);
        return;
    }
    
    // Show preview
    showPreview(mapping);
}

function showPreview(mapping) {
    const container = document.getElementById('preview-container');
    container.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-olive-primary"></div><p class="mt-4 text-gray-600">Loading preview...</p></div>';
    
    const formData = new FormData();
    formData.append('session_id', fileSessionId);
    formData.append('mapping', JSON.stringify(mapping));
    formData.append('action', 'preview');
    
    fetch('{% url "channel_partners:upload_preview" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let errorHtml = '';
            if (data.errors > 0) {
                errorHtml = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <h3 class="font-semibold text-yellow-900 mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            Rows with Errors: ${data.errors}
                        </h3>
                        <p class="text-sm text-yellow-800 mb-2">These rows will be skipped during import. You can download the error CSV after import to fix and re-upload.</p>
                        ${data.error_rows && data.error_rows.length > 0 ? `
                            <div class="mt-2 max-h-40 overflow-y-auto">
                                <table class="min-w-full text-xs">
                                    <thead class="bg-yellow-100">
                                        <tr>
                                            <th class="px-2 py-1">Row</th>
                                            <th class="px-2 py-1">Error</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.error_rows.slice(0, 10).map(err => `
                                            <tr>
                                                <td class="px-2 py-1">${err.row}</td>
                                                <td class="px-2 py-1">${err.error}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-green-900 mb-2">Ready to Import</h3>
                    <p class="text-sm text-green-800">Total rows: ${data.total_rows}</p>
                    <p class="text-sm text-green-800">Valid rows: ${data.valid_rows}</p>
                    ${data.errors > 0 ? `<p class="text-sm text-yellow-800">Rows with errors: ${data.errors}</p>` : ''}
                </div>
                ${errorHtml}
            `;
            
            // Set final form data
            document.getElementById('final-mapping').value = JSON.stringify(mapping);
            document.getElementById('final-session-id').value = fileSessionId;
            
            showStep(3);
        } else {
            alert('Error: ' + (data.error || 'Failed to generate preview'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating preview');
    });
}

function showStep(step) {
    // Hide all steps
    document.getElementById('step-1').classList.add('hidden');
    document.getElementById('step-2').classList.add('hidden');
    document.getElementById('step-3').classList.add('hidden');
    
    // Show current step
    document.getElementById(`step-${step}`).classList.remove('hidden');
    
    // Update indicators
    [1, 2, 3].forEach(s => {
        const indicator = document.getElementById(`step-${s}-indicator`);
        if (s < step) {
            indicator.querySelector('div').classList.remove('bg-gray-300', 'text-gray-600');
            indicator.querySelector('div').classList.add('bg-green-500', 'text-white');
        } else if (s === step) {
            indicator.querySelector('div').classList.remove('bg-gray-300', 'text-gray-600', 'bg-green-500');
            indicator.querySelector('div').classList.add('bg-olive-primary', 'text-white');
        } else {
            indicator.querySelector('div').classList.remove('bg-olive-primary', 'text-white', 'bg-green-500');
            indicator.querySelector('div').classList.add('bg-gray-300', 'text-gray-600');
        }
    });
}

function goBackToStep1() {
    showStep(1);
}

function goBackToStep2() {
    showStep(2);
}

// Handle final form submission
document.getElementById('final-upload-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('mapping', document.getElementById('final-mapping').value);
    formData.append('session_id', document.getElementById('final-session-id').value);
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Importing...';
    
    fetch('{% url "channel_partners:upload" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && !data.success) {
            alert('Error: ' + (data.error || 'Failed to upload'));
            submitBtn.disabled = false;
            submitBtn.textContent = '‚úÖ Import CPs';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during upload');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ Import CPs';
    });
});
</script>
{% endblock %}
